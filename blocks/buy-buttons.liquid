 
{% liquid
  assign block_settings = block.settings
  assign product = closest.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
  endif

  assign variant = closest.product.selected_or_first_available_variant
  assign inventory_quantity = variant.inventory_quantity
  assign inventory_policy = variant.inventory_policy

  if variant.inventory_management == 'shopify'
    assign inventory_managed = true
  endif

  assign can_add_to_cart = false
  assign add_to_cart_text = 'products.product.unavailable' | t

  if variant
    if variant.quantity_rule.min > variant.inventory_quantity and inventory_managed and inventory_policy == 'deny'
      assign quantity_rule_soldout = true
    endif

    if variant.available
      assign can_add_to_cart = true
      assign add_to_cart_text = 'products.product.add_to_cart' | t
    elsif inventory_managed and inventory_quantity <= 0 and inventory_policy == 'deny' or quantity_rule_soldout
      assign can_add_to_cart = false
      assign add_to_cart_text = 'products.product.sold_out' | t
    else
      assign can_add_to_cart = false
      assign add_to_cart_text = 'products.product.unavailable' | t
    endif
  endif

  # Check if product has personalization enabled
  assign show_personalise_button = false
  assign product_tags_lowercase = product.tags | join: ' ' | downcase
  if product_tags_lowercase contains 'cust_personalized'
    assign show_personalise_button = true
  endif
%}

<span
  class="buy-buttons-block buy-buttons-block--{{ block.id }}"
  {{ block.shopify_attributes }}
>
  {%- if product != blank -%}
    {%- assign product_form_id = 'BuyButtons-ProductForm-' | append: section.id -%}
    <product-form-component
      data-section-id="{{ section.id }}"
      data-product-id="{{ product.id }}"
      data-product-url="{{ product.url }}"
      on:submit="/handleSubmit"
      data-quantity-default="{% if product.selected_or_first_available_variant.quantity_rule.min %}{{ product.selected_or_first_available_variant.quantity_rule.min }}{% else %}1{% endif %}"
      data-quantity-error-max="{{ 'products.product.quantity_error_max' | t }}"
    >
      <div
        class="visually-hidden"
        aria-live="assertive"
        role="status"
        aria-atomic="true"
        ref="liveRegion"
      ></div>
      {%- form 'product', product, id: product_form_id, data-type: 'add-to-cart-form' -%}
        <input
          type="hidden"
          name="id"
          ref="variantId"
          value="{{ product.selected_or_first_available_variant.id }}"
        >
        {%- if block_settings.gift_card_form and product.gift_card? -%}
          {%- render 'gift-card-recipient-form', product: product, form: form, section: section, block: block -%}
        {%- endif -%}
        <div
          class="product-form-buttons spacing-style{% if block_settings.stacking %} product-form-buttons--stacked{% endif %}"
          style="{% render 'spacing-style', settings: block_settings %}"
          ref="productFormButtons"
        >
          {%- liquid
            assign has_quantity_rules = false
            if variant.quantity_rule.min > 1 or variant.quantity_rule.increment > 1 or variant.quantity_rule.max != null
              assign has_quantity_rules = true
            endif
          -%}

          {%- comment -%} Gift Wrap and Gift Message Section {%- endcomment -%}
          {% render 'gift-wrap-message', product: product, form: form, product_form_id: product_form_id %}

          {%- comment -%} Personalise It Button {%- endcomment -%}
          {% if show_personalise_button %}
          <button
            type="button"
            class="personalise-button button-unstyled"
            data-personalise-button
          >
            <span class="personalise-button__summary" data-personalise-summary style="display: none;"></span>
            <div class="icon-tex-container"> 
            <span class="personalise-button__icon">
             <img src="{{ 'edit-icon-personisation.png' | asset_url }}" alt="" width="18" height="18">

            </span>
            <span class="personalise-button__text" data-personalise-text>PERSONALISE IT</span>
            </div>
          </button>
          
          {%- comment -%} Personalisation Confirmation Checkbox {%- endcomment -%}
          <div class="personalise-confirmation" data-personalise-confirmation style="display: none;">
            <label class="personalise-confirmation__label">
              <input 
                type="checkbox" 
                class="personalise-confirmation__checkbox"
                data-personalise-confirm-checkbox
                form="{{ product_form_id }}"
              >
              <span class="personalise-confirmation__text" data-personalise-confirm-text></span>
            </label>
          </div>
          {% endif %}

          {%- if has_quantity_rules -%}
            {%- assign cart_quantity = cart | item_count_for_variant: variant.id -%}
            <div
              class="quantity-label"
              ref="quantityLabel"
            >
              {{ 'products.product.quantity' | t }}
              <span
                class="quantity-label__cart-count{% if cart_quantity == 0 %} hidden{% endif %}"
                ref="quantityLabelCartCount"
                >({{ cart_quantity }}
                {{ 'products.product.in_cart' | t }})</span
              >
            </div>
          {%- endif -%}

          <div class="product-form-buttons__row">
            {% content_for 'block', type: 'quantity', id: 'quantity' %}

            {% content_for 'block',
              type: 'add-to-cart',
              id: 'add-to-cart',
              can_add_to_cart: can_add_to_cart,
              add_to_cart_text: add_to_cart_text
            %}
          </div>

          {%- comment -%} Free Shipping and Delivery Messages {%- endcomment -%}
          {%- liquid
            assign threshold_cents = settings.free_shipping_threshold | default: 45000
            assign threshold_money = threshold_cents | money
          -%}
          <div class="product-shipping-messages">
            <div class="shipping-message">
              <span class="shipping-message__icon">
                {{- 'truck-duotone.svg' | inline_asset_content -}}
              </span>
              <span class="shipping-message__text">
                Free shipping over {{ threshold_money }}
              </span>
            </div>
            <div class="shipping-message">
              <span class="shipping-message__icon">
                <img src="{{ 'rectangle.svg' | asset_url }}" alt="" width="18" height="18" loading="lazy">
              </span>
              <span class="shipping-message__text">
                Same day delivery, order before 11 AM
              </span>
            </div>
          </div>

          {%- if has_quantity_rules -%}
            <div
              class="quantity-rules"
              ref="quantityRules"
            >
              {%- if variant.quantity_rule.increment > 1 -%}
                <span class="quantity-rules__item">
                  {{ 'products.product.quantity_increments' | t: increment: variant.quantity_rule.increment }}
                </span>
              {%- endif -%}
              {%- if variant.quantity_rule.min > 1 -%}
                <span class="quantity-rules__item">
                  {{ 'products.product.quantity_minimum' | t: minimum: variant.quantity_rule.min }}
                </span>
              {%- endif -%}
              {%- if variant.quantity_rule.max != null -%}
                <span class="quantity-rules__item">
                  {{ 'products.product.quantity_maximum' | t: maximum: variant.quantity_rule.max }}
                </span>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- if product.quantity_price_breaks_configured? and variant.quantity_price_breaks.size > 0 -%}
            {%- liquid
              assign use_currency = settings.currency_code_enabled_product_pages
            -%}
            <volume-pricing
              class="volume-pricing"
              data-section-id="{{ section.id }}"
              ref="volumePricing"
            >
              <span class="volume-pricing__title caption-large">{{ 'content.volume_pricing' | t }}</span>
              <div class="volume-pricing__table">
                <div class="volume-pricing__row volume-pricing__row--even">
                  <span>{{ variant.quantity_rule.min }}+</span>
                  <span>
                    {%- if use_currency -%}
                      {{- variant.price | money_with_currency | strip -}}
                    {%- else -%}
                      {{- variant.price | money | strip -}}
                    {%- endif -%}
                    /{{ 'content.each_abbreviation' | t -}}
                  </span>
                </div>
                {%- for price_break in variant.quantity_price_breaks limit: 2 -%}
                  {%- liquid
                    assign row_index = forloop.index
                    if row_index == 1
                      assign row_class = 'volume-pricing__row volume-pricing__row--odd'
                    else
                      assign row_class = 'volume-pricing__row volume-pricing__row--even'
                    endif
                  -%}
                  <div class="{{ row_class }}">
                    <span>{{ price_break.minimum_quantity }}+</span>
                    <span>
                      {%- if use_currency -%}
                        {{- price_break.price | money_with_currency | strip -}}
                      {%- else -%}
                        {{- price_break.price | money | strip -}}
                      {%- endif -%}
                      /{{ 'content.each_abbreviation' | t -}}
                    </span>
                  </div>
                {%- endfor -%}

                {%- if variant.quantity_price_breaks.size > 2 -%}
                  <div class="volume-pricing__collapsible-wrapper">
                    {%- for price_break in variant.quantity_price_breaks offset: 2 -%}
                      {%- liquid
                        assign collapsed_index = forloop.index
                        assign total_index = collapsed_index | plus: 2
                        assign modulo_result = total_index | modulo: 2
                        if modulo_result == 1
                          assign row_class = 'volume-pricing__row volume-pricing__collapsible-row volume-pricing__row--odd'
                        else
                          assign row_class = 'volume-pricing__row volume-pricing__collapsible-row volume-pricing__row--even'
                        endif
                      -%}
                      <div class="{{ row_class }}">
                        <span>{{ price_break.minimum_quantity }}+</span>
                        <span>
                          {%- if use_currency -%}
                            {{- price_break.price | money_with_currency | strip -}}
                          {%- else -%}
                            {{- price_break.price | money | strip -}}
                          {%- endif -%}
                          /{{ 'content.each_abbreviation' | t -}}
                        </span>
                      </div>
                    {%- endfor -%}
                  </div>

                  <button
                    type="button"
                    class="volume-pricing__toggle button-unstyled"
                    ref="volumePricingToggle"
                    on:click="/toggleExpanded"
                  >
                    <span class="volume-pricing__toggle-text">
                      <span class="volume-pricing__show-more">+ {{ 'actions.show_more' | t }}</span>
                      <span class="volume-pricing__show-less">- {{ 'actions.show_less' | t }}</span>
                    </span>
                  </button>
                {%- endif -%}
              </div>
            </volume-pricing>
          {%- endif -%}
          {%- unless block_settings.gift_card_form and product.gift_card? -%}
            <span
              class="product-form-text__error hidden"
              ref="addToCartTextError"
            >
              <span class="svg-wrapper product-form-icon--error">
                {{- 'icon-error.svg' | inline_asset_content -}}
              </span>
            </span>
          {%- endunless -%}

          {% comment %}
          {% content_for 'block',
            type: 'accelerated-checkout',
            id: 'accelerated-checkout',
            can_add_to_cart: can_add_to_cart,
            form_obj: form
          %}
          {% endcomment %}
        </div>
      {%- endform -%}
    </product-form-component>
  {%- else -%}
    <div class="product-form-buttons">
      <button
        type="submit"
        name="add"
        class="button"
        disabled
      >
        {{ 'blocks.sold_out' | t }}
      </button>
    </div>
  {%- endif -%}
  
  {%- comment -%} Personalise Modal {%- endcomment -%}
  {% render 'personalise-modal', product: product, variant: variant, context: 'product-page' %}
  
  <script src="{{ 'personalise-modal.js' | asset_url }}" type="module"></script>
  <script>
    // Handle personalise button clicks - completely silent error handling
    (function() {
      'use strict';
      
      // Simple function to safely open the dialog when button is clicked
      function handlePersonaliseClick(e) {
        try {
          const button = e.target.closest('[data-personalise-button]');
          if (!button) return;
          
          e.preventDefault();
          e.stopPropagation();
          
          // Try to find and open the dialog with retries
          function tryOpenDialog(attempts) {
            attempts = attempts || 0;
            const maxAttempts = 40; // Increased for slower mobile devices
            
            try {
              // CRITICAL: Check if button is in quick-add modal - if so, find dialog within that modal
              let dialog = null;
              const quickAddModal = button.closest('#quick-add-modal-content');
              
              if (quickAddModal) {
                // Button is in quick-add modal - find personalise-dialog associated with this modal
                // First, try to find one marked for quick-add
                const productFormComponent = quickAddModal.querySelector('product-form-component');
                const productId = productFormComponent?.dataset?.productId;
                
                if (productId) {
                  // Try to find dialog with matching product ID
                  dialog = document.querySelector(`personalise-dialog[data-product-id="${productId}"][data-quick-add="true"]`);
                }
                
                // If not found by product ID, try to find one in modal content
                if (!dialog) {
                  dialog = quickAddModal.querySelector('personalise-dialog');
                }
                
                // If still not found, find one marked for quick-add (any product)
                if (!dialog) {
                  dialog = document.querySelector('personalise-dialog[data-quick-add="true"]');
                }
                
                // Last resort: find any dialog that's not the main product page one
                if (!dialog) {
                  const allDialogs = document.querySelectorAll('personalise-dialog');
                  if (allDialogs.length > 1) {
                    dialog = Array.from(allDialogs).find(d => {
                      const context = d.getAttribute('data-context');
                      return context !== 'product-page';
                    }) || allDialogs[0];
                  } else if (allDialogs.length === 1) {
                    dialog = allDialogs[0];
                  }
                }
              } else {
                // Button is NOT in quick-add modal - use main product page dialog
                dialog = document.getElementById('personalise-dialog');
                
                // If not found by ID, search for product page context
                if (!dialog) {
                  dialog = document.querySelector('personalise-dialog[data-context="product-page"]') ||
                           document.querySelector('personalise-dialog:not([data-context="cart-drawer"])');
                }
              }
              
              if (dialog) {
                // Check if custom element class is defined
                const isCustomElementDefined = customElements.get('personalise-dialog');
                
                if (isCustomElementDefined) {
                  // Try using the showDialog method
                  if (typeof dialog.showDialog === 'function') {
                    try {
                      dialog.showDialog();
                      return; // Success!
                    } catch (err) {
                      // Continue to fallback
                    }
                  }
                }
                
                // Fallback: try opening the inner dialog element directly
                const innerDialog = dialog.querySelector && dialog.querySelector('dialog');
                if (innerDialog && typeof innerDialog.showModal === 'function') {
                  try {
                    innerDialog.showModal();
                    return; // Success!
                  } catch (err) {
                    // Continue to retry
                  }
                }
              }
              
              // If not found and we haven't exceeded attempts, try again
              if (attempts < maxAttempts) {
                setTimeout(function() {
                  tryOpenDialog(attempts + 1);
                }, 100);
              }
              // Silently fail after max attempts - no errors logged
            } catch (err) {
              // Silently catch any errors - absolutely no logging
            }
          }
          
          tryOpenDialog(0);
        } catch (err) {
          // Silently handle any outer errors
        }
      }
      
      // Initialize event listener when DOM is ready
      function init() {
        try {
          // Check if personalise button exists before adding listener
          const hasButton = document.querySelector('[data-personalise-button]');
          if (hasButton) {
            document.addEventListener('click', handlePersonaliseClick, true);
          }
        } catch (err) {
          // Silently handle initialization errors
        }
      }
      
      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        // DOM already ready, wait a bit to ensure custom elements are loaded
        setTimeout(init, 100);
      }
    })();
  </script>
  
  <script>
    // Function to update button text - only define if not already defined (to avoid conflicts)
  if (!window.updatePersonaliseButtonText) {
    window.updatePersonaliseButtonText = function(updatedFormFromEvent) {
      try {
        // If a form was passed from the event, use it
        let eventForm = updatedFormFromEvent;
        
        // Try multiple ways to get product ID
        let productId = document.querySelector('product-form-component')?.dataset?.productId;
        
        // Check if we're in a quick-add modal context
        if (!productId) {
          const quickAddModal = document.querySelector('#quick-add-modal-content');
          if (quickAddModal) {
            const quickAddFormComponent = quickAddModal.querySelector('product-form-component');
            productId = quickAddFormComponent?.dataset?.productId;
          }
        }
        
        if (!productId) {
          productId = document.querySelector('sticky-add-to-cart')?.dataset?.productId;
        }
        if (!productId) {
          // Try to get from the button's closest product-form-component
          const button = document.querySelector('[data-personalise-button]');
          if (button) {
            productId = button.closest('product-form-component')?.dataset?.productId || 
                        button.closest('sticky-add-to-cart')?.dataset?.productId;
            
            // Also check if button is in quick-add modal
            if (!productId && button.closest('#quick-add-modal-content')) {
              const quickAddModal = button.closest('#quick-add-modal-content');
              const quickAddFormComponent = quickAddModal.querySelector('product-form-component');
              productId = quickAddFormComponent?.dataset?.productId;
            }
          }
        }
        
        // Also try to get from URL if available
        if (!productId) {
          const urlParams = new URLSearchParams(window.location.search);
          const variantId = urlParams.get('variant');
          // Try to extract product ID from variant or other sources
        }
        
        // Find the form to read personalisation from
        let form = null;
        
        // First, try to get product ID from buttons if not found yet
        if (!productId) {
          const buttons = document.querySelectorAll('[data-personalise-button]');
          for (const button of buttons) {
            // Check if button is in quick-add modal
            const quickAddModal = button.closest('#quick-add-modal-content');
            if (quickAddModal) {
              const quickAddFormComponent = quickAddModal.querySelector('product-form-component');
              if (quickAddFormComponent?.dataset?.productId) {
                productId = quickAddFormComponent.dataset.productId;
                form = quickAddModal.querySelector('form[data-type="add-to-cart-form"]');
                break;
              }
            }
            
            // Check button's closest product-form-component
            const formComponent = button.closest('product-form-component');
            if (formComponent?.dataset?.productId) {
              productId = formComponent.dataset.productId;
              form = formComponent.querySelector('form[data-type="add-to-cart-form"]');
              break;
            }
          }
        }
        
        // If form not found yet, try to find it
        if (!form) {
          // Try quick-add modal form
          const quickAddModal = document.querySelector('#quick-add-modal-content');
          if (quickAddModal) {
            form = quickAddModal.querySelector('form[data-type="add-to-cart-form"]');
          }
          
          // Fallback to any form
          if (!form) {
            form = document.querySelector('form[data-type="add-to-cart-form"]');
          }
        }
        
        // Helper function to update a single button (defined first so it can be used in retry)
        const updateButton = (button) => {
          const textSpan = button.querySelector('[data-personalise-text]');
          const summarySpan = button.querySelector('[data-personalise-summary]');
          
          // Find the confirmation checkbox container
          // Try multiple methods to find it
          let confirmationContainer = button.nextElementSibling;
          if (!confirmationContainer || !confirmationContainer.classList?.contains('personalise-confirmation')) {
            // Try finding in the same parent
            confirmationContainer = button.parentElement?.querySelector('[data-personalise-confirmation]');
          }
          if (!confirmationContainer) {
            // Try finding in the form buttons container
            const formButtons = button.closest('.product-form-buttons');
            if (formButtons) {
              confirmationContainer = formButtons.querySelector('[data-personalise-confirmation]');
            }
          }
          
          // Find the product ID for THIS specific button
          let buttonProductId = productId;
          if (!buttonProductId) {
            // Check if button is in quick-add modal
            const quickAddModal = button.closest('#quick-add-modal-content');
            if (quickAddModal) {
              const quickAddFormComponent = quickAddModal.querySelector('product-form-component');
              buttonProductId = quickAddFormComponent?.dataset?.productId;
            }
            
            // If still not found, check button's closest product-form-component
            if (!buttonProductId) {
              const formComponent = button.closest('product-form-component');
              buttonProductId = formComponent?.dataset?.productId;
            }
            
            // If still not found, check sticky-add-to-cart
            if (!buttonProductId) {
              const stickyCart = button.closest('sticky-add-to-cart');
              buttonProductId = stickyCart?.dataset?.productId;
            }
          }
          
          // Find ALL forms that might contain personalization for this product
          const allForms = [];
          
          // CRITICAL: Check if button is in quick-add modal - if so, ONLY use forms from that modal
          const buttonQuickAddModal = button.closest('#quick-add-modal-content');
          if (buttonQuickAddModal) {
            // Button is in quick-add modal - ONLY check forms within that modal
            const quickAddForms = buttonQuickAddModal.querySelectorAll('form[data-type="add-to-cart-form"]');
            quickAddForms.forEach(qForm => {
              // Only include forms that match the button's product ID
              const qFormComponent = qForm.closest('product-form-component');
              const qFormProductId = qFormComponent?.dataset?.productId;
              if (!buttonProductId || qFormProductId === buttonProductId || qFormProductId === String(buttonProductId)) {
                if (!allForms.includes(qForm)) {
                  allForms.push(qForm);
                }
              }
            });
            
            // If we have a form from the event and it's in the quick-add modal, prioritize it
            if (eventForm && buttonQuickAddModal.contains(eventForm) && !allForms.includes(eventForm)) {
              allForms.unshift(eventForm);
            }
          } else {
            // Button is NOT in quick-add modal - check all forms as before
            // First, try to find form by traversing from the button
            const buttonFormComponent = button.closest('product-form-component');
            if (buttonFormComponent) {
              const btnForm = buttonFormComponent.querySelector('form[data-type="add-to-cart-form"]');
              if (btnForm) allForms.push(btnForm);
            }
            
            // Find all product form components and their forms (but exclude quick-add modal forms)
            const allProductForms = document.querySelectorAll('product-form-component');
            allProductForms.forEach(formComponent => {
              // Skip forms that are in quick-add modal (they should only be checked when button is in quick-add)
              const quickAddModal = document.querySelector('#quick-add-modal-content');
              if (quickAddModal && quickAddModal.contains(formComponent)) {
                return; // Skip this form - it's in quick-add modal but button is not
              }
              
              if (buttonProductId) {
                const compProductId = formComponent.dataset?.productId || formComponent.dataset?.productId;
                if (compProductId === buttonProductId || compProductId === String(buttonProductId)) {
                  const compForm = formComponent.querySelector('form[data-type="add-to-cart-form"]');
                  if (compForm && !allForms.includes(compForm)) {
                    allForms.push(compForm);
                  }
                }
              } else {
                const compForm = formComponent.querySelector('form[data-type="add-to-cart-form"]');
                if (compForm && !allForms.includes(compForm)) {
                  allForms.push(compForm);
                }
              }
            });
            
            // Fallback to the form we found earlier (but not if it's in quick-add modal)
            if (form && !allForms.includes(form)) {
              const quickAddModal = document.querySelector('#quick-add-modal-content');
              if (!quickAddModal || !quickAddModal.contains(form)) {
                allForms.push(form);
              }
            }
            
            // If we have a form from the event, prioritize it (but not if it's in quick-add modal)
            if (eventForm && !allForms.includes(eventForm)) {
              const quickAddModal = document.querySelector('#quick-add-modal-content');
              if (!quickAddModal || !quickAddModal.contains(eventForm)) {
                allForms.unshift(eventForm);
              }
            }
          }
          
          if (textSpan) {
            let modalDialog = document.querySelector('personalise-dialog');
            // Build Your Set Quick Add: use only the quick-add dialog for current product; never fall back to another dialog
            if (buttonQuickAddModal && buttonQuickAddModal.hasAttribute('data-build-your-set')) {
              const bysDialog = buttonProductId
                ? document.querySelector(`personalise-dialog[data-quick-add="true"][data-product-id="${buttonProductId}"]`)
                : document.querySelector('personalise-dialog[data-quick-add="true"]');
              modalDialog = bysDialog || null;
            }
            
            const parts = [];
            let colorText = '';
            
            // Read personalisation directly from form inputs - check ALL forms
            for (const buttonForm of allForms) {
              if (!buttonForm) continue;
              // Read baby/kid/mum names from form
              const babyNameInput = buttonForm.querySelector('input[name="properties[Baby\'s Name]"]');
              if (babyNameInput && babyNameInput.value.trim()) {
                parts.push('Baby: ' + babyNameInput.value.trim());
              }
              
              const kidNameInput = buttonForm.querySelector('input[name="properties[Kid\'s Name]"]');
              if (kidNameInput && kidNameInput.value.trim()) {
                parts.push('Kid: ' + kidNameInput.value.trim());
              }
              
              const mumNameInput = buttonForm.querySelector('input[name="properties[Mum\'s Name]"]');
              if (mumNameInput && mumNameInput.value.trim()) {
                parts.push('Mum: ' + mumNameInput.value.trim());
              }
              
              // Read other fields from form
              const nameInput = buttonForm.querySelector('input[name="properties[Name]"]');
              if (nameInput && nameInput.value.trim()) {
                parts.push(nameInput.value.trim());
              }
              
              const name1Input = buttonForm.querySelector('input[name="properties[Name 1]"]');
              if (name1Input && name1Input.value.trim()) {
                parts.push(name1Input.value.trim());
              }
              
              const name2Input = buttonForm.querySelector('input[name="properties[Name 2]"]');
              if (name2Input && name2Input.value.trim()) {
                parts.push(name2Input.value.trim());
              }
              
              const name3Input = buttonForm.querySelector('input[name="properties[Name 3]"]');
              if (name3Input && name3Input.value.trim()) {
                parts.push(name3Input.value.trim());
              }
              
              const name4Input = buttonForm.querySelector('input[name="properties[Name 4]"]');
              if (name4Input && name4Input.value.trim()) {
                parts.push(name4Input.value.trim());
              }
              
              const dobInput = buttonForm.querySelector('input[name="properties[Date of Birth]"]');
              if (dobInput && dobInput.value.trim()) {
                parts.push(dobInput.value.trim());
              }
              
              const optionalDobInput = buttonForm.querySelector('input[name="properties[Personalise Date of Birth]"]');
              if (optionalDobInput && optionalDobInput.value.trim()) {
                parts.push(optionalDobInput.value.trim());
              }
              
              const schoolYearInput = buttonForm.querySelector('input[name="properties[School Year]"]');
              if (schoolYearInput && schoolYearInput.value.trim()) {
                parts.push(schoolYearInput.value.trim());
              }
              
              // Read color from form
              const colorInput = buttonForm.querySelector('input[name="properties[Text Color]"]:checked') || 
                                 buttonForm.querySelector('input[name="properties[Text Color]"]');
              if (colorInput && colorInput.value.trim()) {
                colorText = colorInput.value.trim();
              }
              
              // Read font from form
              const fontInput = buttonForm.querySelector('input[name="properties[Text Font]"]');
              if (fontInput && fontInput.value.trim()) {
                parts.push('Font: ' + fontInput.value.trim());
              }
              
              // If we found any personalization in this form, we can stop checking
              if (parts.length > 0 || colorText) {
                break;
              }
            }
            
            // Also check form inputs as a fallback/update (in case user is editing)
            // First, try to find form in quick-add modal context
            let quickAddForm = null;
            const quickAddModal = document.querySelector('#quick-add-modal-content');
            if (quickAddModal) {
              quickAddForm = quickAddModal.querySelector('form[data-type="add-to-cart-form"]');
            }
            
            // Use quick-add form if available, otherwise use the found form
            const activeForm = quickAddForm || form;
            
            if (activeForm || modalDialog) {
              // Read Baby/Kid/Mum names from modal dialog inputs (they're in the modal, not the form)
              let babyNameInput = modalDialog ? modalDialog.querySelector('input[name="properties[Baby\'s Name]"]') : null;
              if (!babyNameInput && activeForm) {
                babyNameInput = activeForm.querySelector('input[name="properties[Baby\'s Name]"]');
              }
              if (babyNameInput && babyNameInput.value.trim()) {
                // Replace if already exists, or add if not
                const existingIndex = parts.findIndex(p => p.startsWith('Baby: '));
                if (existingIndex >= 0) {
                  parts[existingIndex] = 'Baby: ' + babyNameInput.value.trim();
                } else {
                  parts.push('Baby: ' + babyNameInput.value.trim());
                }
              }
              
              let kidNameInput = modalDialog ? modalDialog.querySelector('input[name="properties[Kid\'s Name]"]') : null;
              if (!kidNameInput && activeForm) {
                kidNameInput = activeForm.querySelector('input[name="properties[Kid\'s Name]"]');
              }
              if (kidNameInput && kidNameInput.value.trim()) {
                const existingIndex = parts.findIndex(p => p.startsWith('Kid: '));
                if (existingIndex >= 0) {
                  parts[existingIndex] = 'Kid: ' + kidNameInput.value.trim();
                } else {
                  parts.push('Kid: ' + kidNameInput.value.trim());
                }
              }
              
              let mumNameInput = modalDialog ? modalDialog.querySelector('input[name="properties[Mum\'s Name]"]') : null;
              if (!mumNameInput && activeForm) {
                mumNameInput = activeForm.querySelector('input[name="properties[Mum\'s Name]"]');
              }
              if (mumNameInput && mumNameInput.value.trim()) {
                const existingIndex = parts.findIndex(p => p.startsWith('Mum: '));
                if (existingIndex >= 0) {
                  parts[existingIndex] = 'Mum: ' + mumNameInput.value.trim();
                } else {
                  parts.push('Mum: ' + mumNameInput.value.trim());
                }
              }
              
              // Also read other fields from modal dialog or form inputs
              let nameInput = modalDialog ? modalDialog.querySelector('#personalise-name') : null;
              if (!nameInput && activeForm) {
                nameInput = activeForm.querySelector('input[name="properties[Name]"]') || activeForm.querySelector('#personalise-name');
              }
              if (nameInput && nameInput.value.trim()) {
                const existingIndex = parts.findIndex(p => !p.startsWith('Baby: ') && !p.startsWith('Kid: ') && !p.startsWith('Mum: ') && !p.includes('|'));
                if (existingIndex >= 0 && !parts[existingIndex].includes('Name')) {
                  // Replace first non-baby/kid/mum part if it looks like a name
                } else {
                  parts.push(nameInput.value.trim());
                }
              }
              
              if (activeForm) {
                const name1Input = activeForm.querySelector('input[name="properties[Name 1]"]');
                if (name1Input && name1Input.value.trim()) {
                  parts.push(name1Input.value.trim());
                }
                
                const name2Input = activeForm.querySelector('input[name="properties[Name 2]"]');
                if (name2Input && name2Input.value.trim()) {
                  parts.push(name2Input.value.trim());
                }
                
                const name3Input = activeForm.querySelector('input[name="properties[Name 3]"]');
                if (name3Input && name3Input.value.trim()) {
                  parts.push(name3Input.value.trim());
                }
                
                const name4Input = activeForm.querySelector('input[name="properties[Name 4]"]');
                if (name4Input && name4Input.value.trim()) {
                  parts.push(name4Input.value.trim());
                }
                
                const dobInput = activeForm.querySelector('input[name="properties[Date of Birth]"]');
                if (dobInput && dobInput.value.trim()) {
                  parts.push(dobInput.value.trim());
                }
                
                const optionalDobInput = activeForm.querySelector('input[name="properties[Personalise Date of Birth]"]') || activeForm.querySelector('#dob_field_val');
                if (optionalDobInput && optionalDobInput.value.trim()) {
                  parts.push(optionalDobInput.value.trim());
                }
                
                const schoolYearInput = activeForm.querySelector('input[name="properties[School Year]"]');
                if (schoolYearInput && schoolYearInput.value.trim()) {
                  parts.push(schoolYearInput.value.trim());
                }
                
                // Read color from hidden input or visible input
                const colorInput = activeForm.querySelector('input[name="properties[Text Color]"]');
                if (colorInput && colorInput.value.trim()) {
                  colorText = colorInput.value.trim();
                }
                
                // Read font from form
                const fontInput = activeForm.querySelector('input[name="properties[Text Font]"]');
                if (fontInput && fontInput.value.trim()) {
                  // Check if font is already in parts to avoid duplicates
                  const fontIndex = parts.findIndex(p => p.startsWith('Font: '));
                  if (fontIndex >= 0) {
                    parts[fontIndex] = 'Font: ' + fontInput.value.trim();
                  } else {
                    parts.push('Font: ' + fontInput.value.trim());
                  }
                }
              }
            }
            
            // Check if we have personalisation data (from form inputs)
            const hasPersonalisation = parts.length > 0 || colorText;
            
            if (hasPersonalisation) {
              // Build summary text - prefer sessionStorage data, fallback to form inputs
              let summaryText = 'Personalised:';
              if (parts.length > 0) {
                summaryText += ' ' + parts.join(' | ');
              }
              if (colorText) {
                if (parts.length > 0) {
                  summaryText += ' (' + colorText + ')';
                } else {
                  summaryText += ' ' + colorText;
                }
              }
              
              // Show summary and update text
              if (summarySpan) {
                summarySpan.textContent = summaryText;
                summarySpan.style.display = '';
                button.classList.add('has-summary');
              }
              textSpan.textContent = 'EDIT';
              
              // Show and update confirmation checkbox
              if (confirmationContainer) {
                const confirmTextSpan = confirmationContainer.querySelector('[data-personalise-confirm-text]');
                if (confirmTextSpan) {
                  // Build dynamic label based on fields found in form or sessionStorage
                  const fields = [];
                  
                  // Check form inputs first (use activeForm which could be quick-add form)
                  if (activeForm) {
                    if (activeForm.querySelector('input[name="properties[Name]"]') || activeForm.querySelector('#personalise-name')) {
                      fields.push('name');
                    }
                    if (activeForm.querySelector('input[name="properties[Name 1]"]')) fields.push('name1');
                    if (activeForm.querySelector('input[name="properties[Name 2]"]')) fields.push('name2');
                    if (activeForm.querySelector('input[name="properties[Name 3]"]')) fields.push('name3');
                    if (activeForm.querySelector('input[name="properties[Name 4]"]')) fields.push('name4');
                    if (activeForm.querySelector('input[name="properties[Date of Birth]"]') || activeForm.querySelector('#dob_field_val')) {
                      fields.push('date');
                    }
                    if (colorText) fields.push('colour');
                    if (activeForm.querySelector('input[name="properties[Text Font]"]')) fields.push('font');
                    if (activeForm.querySelector('input[name="properties[Baby\'s Name]"]')) fields.push('baby name');
                    if (activeForm.querySelector('input[name="properties[Kid\'s Name]"]')) fields.push('kid name');
                    if (activeForm.querySelector('input[name="properties[Mum\'s Name]"]')) fields.push('mum name');
                  }
                  
                  // Also check form inputs if not already checked - check all forms
                  for (const checkForm of allForms) {
                    if (!checkForm) continue;
                    if (checkForm.querySelector('input[name="properties[Baby\'s Name]"]') && !fields.includes('baby name')) {
                      fields.push('baby name');
                    }
                    if (checkForm.querySelector('input[name="properties[Kid\'s Name]"]') && !fields.includes('kid name')) {
                      fields.push('kid name');
                    }
                    if (checkForm.querySelector('input[name="properties[Mum\'s Name]"]') && !fields.includes('mum name')) {
                      fields.push('mum name');
                    }
                  }
                  
                  if (fields.length > 0) {
                    confirmTextSpan.textContent = `I confirm my ${fields.join(', ')} personalisation`;
                    confirmationContainer.style.display = '';
                    // Update add to cart button state after showing confirmation
                    if (window.updateAddToCartButtonState) {
                      setTimeout(window.updateAddToCartButtonState, 50);
                    }
                  }
                }
              }
            } else {
              // No personalisation found, show default button
              if (summarySpan) {
                summarySpan.style.display = 'none';
                button.classList.remove('has-summary');
              }
              textSpan.textContent = 'PERSONALISE IT';
              if (confirmationContainer) {
                confirmationContainer.style.display = 'none';
                // Update add to cart button state after hiding confirmation
                if (window.updateAddToCartButtonState) {
                  setTimeout(window.updateAddToCartButtonState, 50);
                }
              }
            }
          }
        };
        
        // Find buttons in both main page and quick-add modal
        let buttons = document.querySelectorAll('[data-personalise-button]');
        
        // If no buttons found, wait a bit for dynamically loaded content (like quick-add modal)
        if (buttons.length === 0) {
          setTimeout(() => {
            const retryButtons = document.querySelectorAll('[data-personalise-button]');
            if (retryButtons.length > 0) {
              retryButtons.forEach(button => updateButton(button));
            }
          }, 500);
          return;
        }
        
        // Update all buttons
        buttons.forEach(button => {
          updateButton(button);
        });
      } catch (error) {
        console.error('Error updating personalise button text:', error);
      }
    };
  }
  
  // Listen for personalisation-saved event to update button (single update, no retries).
  // Duplicate retry loops previously caused the Edit personalisation button to flash
  // in the quick-add popup after save. Use shared debounce key with product-information.
  var PERSONALISATION_SAVED_DEBOUNCE_MS = 400;
  function handlePersonalisationSaved(event) {
    var now = Date.now();
    if (window.__lastPersonalisationSavedHandledAt && (now - window.__lastPersonalisationSavedHandledAt) < PERSONALISATION_SAVED_DEBOUNCE_MS) {
      return;
    }
    window.__lastPersonalisationSavedHandledAt = now;
    var updatedForm = event.detail && event.detail.form;
    setTimeout(function() {
      if (typeof window.updatePersonaliseButtonText === 'function') {
        window.updatePersonaliseButtonText(updatedForm);
      }
    }, 100);
  }

  // Set up event listeners (document only; event is also dispatched on dialog and bubbles)
  try {
    document.addEventListener('personalisation-saved', handlePersonalisationSaved);
    
    // Don't update button text on page load - everything is fresh on reload
    // Button text will be updated when personalisation is saved during the current session
  } catch (error) {
    console.error('Error setting up personalise button listeners:', error);
  }
  </script>
  
  <script>
    // Handle personalization confirmation checkbox - enable/disable add to cart button
    (function() {
      'use strict';
      
      // Expose function globally so it can be called from updatePersonaliseButtonText
      window.updateAddToCartButtonState = function() {
        try {
          const productFormComponent = document.querySelector('product-form-component[data-product-id="{{ product.id }}"]');
          if (!productFormComponent) return;
          
          const form = productFormComponent.querySelector('form[data-type="add-to-cart-form"]');
          if (!form) return;
          
          // Try to find confirmation checkbox - it might be in product-form-component or in buy-buttons-block
          let personalisationConfirmation = productFormComponent.querySelector('[data-personalise-confirmation]');
          if (!personalisationConfirmation) {
            // Try finding in buy-buttons-block
            const buyButtonsBlock = productFormComponent.closest('.buy-buttons-block') || 
                                    document.querySelector('.buy-buttons-block');
            if (buyButtonsBlock) {
              personalisationConfirmation = buyButtonsBlock.querySelector('[data-personalise-confirmation]');
            }
          }
          
          const personalisationCheckbox = personalisationConfirmation?.querySelector('[data-personalise-confirm-checkbox]');
          
          if (!personalisationConfirmation || !personalisationCheckbox) {
            // No confirmation checkbox found - personalization might not be present or not yet loaded
            // Don't interfere with button state
            return;
          }
          
          // Check if confirmation container is visible
          const isVisible = personalisationConfirmation.offsetParent !== null || 
                            personalisationConfirmation.style.display !== 'none' ||
                            window.getComputedStyle(personalisationConfirmation).display !== 'none';
          
          if (!isVisible) {
            // If not visible, personalization not present - don't interfere with button state
            return;
          }
          
          // If visible, enable/disable based on checkbox state
          const addToCartButtons = productFormComponent.querySelectorAll('add-to-cart-component');
          addToCartButtons.forEach(container => {
            if (container.refs?.addToCartButton) {
              if (personalisationCheckbox.checked) {
                container.enable();
              } else {
                container.disable();
              }
            }
          });
          
          // Also handle sticky bar add to cart button
          const stickyBar = document.querySelector('sticky-add-to-cart');
          if (stickyBar?.refs?.addToCartButton) {
            const stickyButton = stickyBar.refs.addToCartButton;
            // Only disable if variant is available (don't override unavailable state)
            if (stickyBar.dataset.variantAvailable === 'true') {
              if (personalisationCheckbox.checked) {
                stickyButton.disabled = false;
              } else {
                stickyButton.disabled = true;
              }
            }
          }
        } catch (error) {
          // Silently handle errors
        }
      }
      
      // Initialize on page load
      function init() {
        try {
          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(window.updateAddToCartButtonState, 100);
            });
          } else {
            setTimeout(window.updateAddToCartButtonState, 100);
          }
          
          // Listen for checkbox changes
          document.addEventListener('change', function(e) {
            if (e.target && e.target.matches('[data-personalise-confirm-checkbox]')) {
              window.updateAddToCartButtonState();
            }
          });
          
          // Also listen for personalisation-saved event to update button state
          document.addEventListener('personalisation-saved', function() {
            setTimeout(window.updateAddToCartButtonState, 200);
          });
        } catch (error) {
          // Silently handle errors
        }
      }
      
      init();
    })();
  </script>
</span>

{% if block_settings.show_pickup_availability %}
  <script
    src="{{ 'local-pickup.js' | asset_url }}"
    type="module"
  ></script>

  {%- assign pick_up_availabilities = closest.product.selected_or_first_available_variant.store_availabilities
    | where: 'pick_up_enabled', true
  -%}

  <local-pickup
    class="spacing-style product__pickup-availabilities"
    {% if pick_up_availabilities.size == 0 %}
      hidden
    {% endif %}
    data-section-id="{{ section.id }}"
    data-product-url="{{ closest.product.url }}"
    data-variant-id="{{ closest.product.selected_or_first_available_variant.id }}"
    style="{% render 'spacing-style', settings: block_settings %}"
    ref="localPickupButton"
  >
    {% if can_add_to_cart %}
      <dialog-component>
        <div class="pickup-availability__row">
          <div class="pickup-availability__column">
            <span class="svg-wrapper">
              {% if pick_up_availabilities.first.available %}
                {{- 'icon-available.svg' | inline_asset_content -}}
              {% else %}
                {{- 'icon-unavailable.svg' | inline_asset_content -}}
              {% endif %}
            </span>
          </div>
          <div class="pickup-availability__column">
            {% if pick_up_availabilities.first.available %}
              <p class="pickup-location__text-sm">
                {{ 'content.pickup_available_at_html' | t: location: pick_up_availabilities.first.location.name }}
              </p>
              <p class="pickup-location__text-xs">
                {{ 'content.pickup_ready_in' | t: pickup_time: pick_up_availabilities.first.pick_up_time }}
              </p>
            {% else %}
              <p class="pickup-location__text-sm">
                {{ 'content.pickup_not_available' | t }}
              </p>
            {% endif %}
            <button
              on:click="/showDialog"
              class="button-unstyled pickup-location__button"
            >
              {{ 'actions.view_store_information' | t }}
            </button>
          </div>
        </div>
        <dialog
          ref="dialog"
          class="dialog-modal dialog-drawer pickup-location__dialog color-{{ settings.drawer_color_scheme }}"
          scroll-lock
          aria-labelledby="pickup-dialog-heading"
        >
          <h2
            id="pickup-dialog-heading"
            class="visually-hidden"
          >
            {{ 'actions.view_store_information' | t }}
          </h2>
          <div class="pickup-availability__dialog-row pickup-availability__header-container">
            <div class="pickup-availability__column">
              <h4 class="pickup-location__h4">{{ closest.product.title }}</h4>
              <p class="pickup-location__text-sm">
                {{ closest.product.selected_or_first_available_variant.title }}
              </p>
            </div>
            <button
              ref="closeButton"
              on:click="/closeDialog"
              class="button button-unstyled close-button pickup-location__close-button"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>
          {% for pick_up_availability in pick_up_availabilities %}
            <div class="pickup-location__wrapper">
              <p class="pickup-location__text-bold">{{ pick_up_availability.location.name }}</p>
              <div class="pickup-location__address-wrapper">
                <span class="pickup-location__availability-wrapper">
                  {% if pick_up_availability.available %}
                    {{- 'icon-available.svg' | inline_asset_content -}}
                    {% assign pickup_time = pick_up_availability.pick_up_time | downcase %}
                    {{ 'content.pickup_available_in' | t: pickup_time: pickup_time }}
                  {% else %}
                    {{- 'icon-unavailable.svg' | inline_asset_content -}}
                    {{ 'content.pickup_not_available' | t }}
                  {% endif %}
                </span>
                <address class="pickup-location__address">
                  {{ pick_up_availability.location.address | format_address }}
                  {{ pick_up_availability.location.address.phone }}
                </address>
              </div>
            </div>
          {% endfor %}
        </dialog>
      </dialog-component>
    {% endif %}
  </local-pickup>
{% endif %}

{% stylesheet %}
  .buy-buttons-block {
    --buy-button-preferred-width: 185px;

    width: 100%;
  }

  .product-form-buttons {
    display: flex;
    flex-wrap: wrap;
    flex-direction: column;
    gap: var(--gap-sm);
  }

  @media screen and (max-width: 749px) {
    .product-form-buttons {
      margin-bottom: 24px;
    }  
  }

  .product-form-buttons:not(:has(.quantity-rules)) {
    gap: var(--gap-sm);
  }

  .product-form-buttons > *:not(.quantity-selector-wrapper, .quantity-rules, .quantity-label, .volume-pricing, .personalise-button) {
    flex: 1 1 var(--buy-button-preferred-width, 0);
    min-width: fit-content;
  }

  .product-form-buttons > .quantity-selector-wrapper {
    flex: 0 0 auto;
  }

  .product-form-buttons__row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm);
    width: 100%;
    align-items: stretch;
  }

  .product-form-buttons__row > *:last-child {
    flex: 1 1 auto;
    min-width: 0;
    width: auto;
  }

  .product-form-buttons__row > span:last-child {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
  }

  .product-form-buttons__row .add-to-cart-button,
  .product-form-buttons__row [class*="add-to-cart"],
  .product-form-buttons__row add-to-cart-component,
  .product-form-buttons__row add-to-cart-component button,
  .product-form-buttons__row > span:last-child add-to-cart-component,
  .product-form-buttons__row > span:last-child add-to-cart-component button {
    flex: 1 1 auto;
    min-width: 0;
    width: 100%;
  }

  .product-form-buttons--stacked
    > *:not(.quantity-selector-wrapper, .quantity-rules, .quantity-label, .volume-pricing) {
    flex-basis: 51%;
  }

  .product-form-buttons button {
    width: 100%;
    padding-block: var(--padding-lg);
  }

  .quantity-selector {
    flex-grow: 0;
    flex-shrink: 0;
    height: var(--height-buy-buttons);
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }

  .quantity-selector:hover {
    background-color: #ffffff;
  }

  /* .quantity-selector input[type='number'] {
    color: #333333;
  } */

  .quantity-label {
    flex: 1 0 100%;
    width: 100%;
    font-size: var(--font-size--sm);
    margin-block-end: var(--gap-xs);
  }

  .quantity-label__cart-count {
    color: var(--color-foreground-secondary);
  }

  .quantity-rules {
    display: flex;
    flex-wrap: wrap;
    gap: 0;
    row-gap: calc(var(--gap-xs) / 2);
    flex: 1 0 100%;
    width: 100%;
    font-size: var(--font-size--xs);
    color: var(--color-foreground-secondary);
    margin-block-start: var(--gap-xs);
    margin-block-end: var(--gap);
  }

  .product-form-buttons:has(~ .volume-pricing .volume-pricing__title) .quantity-rules {
    margin-block-end: var(--gap-md);
  }

  .quantity-rules__item {
    position: relative;
    display: inline-block;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  .quantity-rules__item:not(:last-child) {
    padding-right: var(--padding-xl);
    margin-right: var(--margin-2xs);
  }

  .quantity-rules__item:not(:last-child)::after {
    content: '';
    position: absolute;
    inset-inline-end: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.5em;
    line-height: 0;
  }

  /* Only apply these styles to add-to-cart buttons in the product form, not quick-add buttons */
  .product-form-buttons .add-to-cart-button:not(.quick-add__button) {
    height: var(--height-buy-buttons);
    text-transform: uppercase !important;
    background-color: #7295BB !important;
    color: #ffffff !important;
    border: none !important;
    font-weight: 500;
  }

  .product-form-buttons .add-to-cart-button:not(.quick-add__button):hover:not(:disabled) {
    background-color: #5a7a9a !important;
    color: #ffffff !important;
  }

  .product-form-buttons .add-to-cart-button:not(.quick-add__button):disabled {
    background-color: #cccccc !important;
    color: #666666 !important;
    cursor: not-allowed;
  }

  .product-form-buttons .add-to-cart-button.button-secondary:not(.quick-add__button) {
    text-transform: uppercase !important;
    background-color: #7295BB !important;
    color: #ffffff !important;
  }

  .product-form-buttons .add-to-cart-button.button-secondary:not(.quick-add__button):hover:not(:disabled) {
    background-color: #5a7a9a !important;
    color: #ffffff !important;
  }

  .product-form-text__error {
    display: flex;
    align-items: flex-start;
    gap: var(--gap-xs);
    margin-block-end: var(--gap-xs);
  }

  .product__pickup-availabilities {
    width: 100%;
  }

  .pickup-availability__column {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  .pickup-availability__row {
    display: flex;
    gap: var(--padding-xs);
  }

  .pickup-availability__dialog-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .pickup-availability__header-container {
    padding-block-end: var(--padding-2xl);
  }

  .pickup-location__wrapper {
    display: flex;
    flex-direction: column;
    padding-block: var(--padding-2xl);
    border-top: 1px solid var(--color-border);
    gap: var(--padding-xs);
  }

  .pickup-location__address-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--padding-md);
  }

  .pickup-location__dialog {
    padding: var(--padding-2xl);
    position: fixed;
    border-radius: 0;
    width: var(--sidebar-width);
    max-width: 95vw;
    height: 100%;
    margin: 0 0 0 auto;
    border: var(--style-border-drawer);
    box-shadow: var(--shadow-drawer);
    background-color: var(--color-background);
  }

  .pickup-location__dialog:modal {
    max-height: 100dvh;
  }

  .pickup-location__text-sm {
    font-size: var(--font-size--sm);
    margin: 0;
  }

  .pickup-location__text-xs {
    font-size: var(--font-size--xs);
    margin: 0;
  }

  .pickup-location__button {
    width: fit-content;
    color: var(--color-primary);
    font-size: var(--font-size--xs);
    font-family: var(--font-body--family);
    padding: 0;
    cursor: pointer;
    margin-block: var(--margin-xs);
  }

  .pickup-location__button:hover {
    color: var(--color-primary-hover);
  }

  .pickup-location__h4 {
    margin: 0;
  }

  .pickup-location__text-bold {
    font-size: var(--font-size--md);
    font-weight: 600;
    margin: 0;
  }

  .pickup-location__availability-wrapper {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    font-family: var(--font-paragraph--family);
  }

  .pickup-location__address {
    font-style: normal;
  }

  .pickup-location__close-button {
    top: calc(var(--padding-2xl) - (var(--icon-size-xs) / 2));
    right: calc(var(--padding-2xl) - var(--icon-size-xs));
  }

  .volume-pricing {
    display: block;
    width: 100%;
    margin-bottom: var(--gap);
  }

  .volume-pricing:not(:has(.volume-pricing__title)) {
    margin-top: 0;
    margin-bottom: 0;
  }

  .volume-pricing__title {
    display: block;
    margin-block-end: var(--gap-sm);
    font-size: var(--font-size--sm);
    font-weight: var(--font-body--weight);
    color: var(--color-foreground);
  }

  .volume-pricing__table {
    width: 100%;
  }

  .volume-pricing__row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-block: var(--padding-sm);
    padding-inline: var(--padding-md);
    font-size: var(--font-size--sm);
  }

  .volume-pricing__row--even {
    background: rgb(var(--color-foreground-rgb) / var(--opacity-5));
  }

  .volume-pricing__row--odd {
    background: var(--color-background);
  }

  .volume-pricing__collapsible-wrapper {
    block-size: 0;
    overflow-y: clip;
    opacity: 0;
    interpolate-size: allow-keywords;
    transition: opacity var(--animation-speed-slow) var(--animation-easing),
      block-size var(--animation-speed-slow) var(--animation-easing);
  }

  .volume-pricing__toggle {
    width: 100%;
    padding-bottom: 0;
    padding-inline: 0;
    text-align: left;
    color: var(--color-foreground-secondary);
    font-size: var(--font-size--xs);
    cursor: default;
    margin-block-start: 0;
    pointer-events: none;
  }

  button.volume-pricing__toggle {
    /* Need the extra specificity to override .product-form-buttons button */
    padding-block: var(--padding-sm);
  }

  .volume-pricing__toggle-text {
    cursor: pointer;
    display: inline-block;
    pointer-events: auto;
  }

  .volume-pricing__show-less {
    display: none;
  }

  .volume-pricing--expanded .volume-pricing__collapsible-wrapper {
    opacity: 1;
    block-size: auto;

    @starting-style {
      block-size: 0;
      opacity: 0;
      overflow-y: clip;
    }
  }

  .volume-pricing--expanded .volume-pricing__show-more {
    display: none;
  }

  .volume-pricing--expanded .volume-pricing__show-less {
    display: inline;
  }

  .price-per-item {
    display: block;
    color: var(--color-foreground);
    font-size: var(--font-size--sm);
    font-weight: normal;
  }

  /* Personalise Button */
  .personalise-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: var(--padding-md) var(--padding-lg);
    background-color: transparent;
    border: 1px solid #7295BB;
    border-radius: 0;
    color: #7295BB;
    text-transform: uppercase;
    font-weight: 500;
    font-size: var(--font-size--sm);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 0;
  }
  
  /* When summary is visible, space between left and right */
  .personalise-button.has-summary {
    justify-content: space-between;
  }
  
  .icon-tex-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .personalise-button__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .personalise-button__icon svg {
    width: 100%;
    height: 100%;
  }

  .personalise-button__text {
    line-height: 1;
  }

  .personalise-button__summary {
    display: inline-block;
    margin-right: var(--margin-sm);
    flex-shrink: 0;
    color: #1D425A;
    font-weight: 400;
    line-height: 1.4;
    text-transform: none;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Personalisation Confirmation Checkbox */
  .personalise-confirmation {
    margin-top: var(--margin-md);
    width: 100%;
  }

  .personalise-confirmation__label {
    display: flex;
    align-items: flex-start;
    gap: var(--gap-sm);
    cursor: pointer;
  }

  .personalise-confirmation__checkbox {
    margin: 0;
    margin-block-start: 2px;
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    cursor: pointer;
    border: 1.5px solid #7295BB !important;
    border-radius: 0px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: #FFFFFF;
    box-sizing: border-box;
  }

  .personalise-confirmation__checkbox:checked {
    background-color: #7295BB;
    border-color: #7295BB !important;
    background-image: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M13.3333 4L6 11.3333L2.66667 8' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 14px 14px;
  }

  .personalise-confirmation__text {
    flex: 1;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 140%;
    color: #1D425A;
  }

  /* Shipping Messages */
  .product-shipping-messages {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-md);
    width: 100%;
  }
  @media screen and (max-width: 749px) {
    .product-shipping-messages {
      margin-top: 16px;
    }
    .sticky-add-to-cart__actions:has(.add-to-cart-button) {
      flex-wrap: wrap;
    }
    .sticky-add-to-cart__actions {
      justify-content: center;
    }
    .sticky-add-to-cart__actions .personalise-button {
      width: auto;
      padding: 10px;
      height: auto;
      flex: auto;

    }
    .sticky-add-to-cart__actions .personalise-button:has(.add-to-cart-button) {
      width: 100%;
    }
    .sticky-add-to-cart__actions .sticky-add-to-cart__button:has(.add-to-cart-button) {
      width: 100%;
    }
    .sticky-add-to-cart__actions .sticky-add-to-cart__button {
      width: auto;
      padding: 10px;
      height: auto;
      flex: auto;
    }
    .sticky-add-to-cart__personalise-button .icon-tex-container {
      flex: none;
    }
  }
  @media screen and (min-width: 1400px) {
    .product-shipping-messages {
      justify-content: center;
    }
  }

  .shipping-message {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
  }

  .shipping-message__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 18px;
    height: 18px;
  }

  .shipping-message__icon svg,
  .shipping-message__icon img {
    width: 100%;
    height: 100%;
    display: block;
  }

  .shipping-message__text {
    font-family: 'Outfit';
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 18px;
    text-align: center;
    color: #1D425A;
  }

  @media screen and (max-width: 749px) {
    .shipping-message {
      min-width: 100%;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_buy_buttons",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product"
    },
    {
      "type": "checkbox",
      "id": "stacking",
      "label": "t:settings.always_stack_buttons",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_pickup_availability",
      "label": "t:settings.show_pickup_availability",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "gift_card_form",
      "label": "t:settings.gift_card_form",
      "default": true
    },
    {
      "type": "paragraph",
      "content": "t:content.gift_card_form_description"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_buy_buttons",
      "category": "t:categories.product",
      "blocks": {
        "quantity": {
          "type": "quantity",
          "static": true
        },
        "add-to-cart": {
          "type": "add-to-cart",
          "static": true,
          "settings": {
            "style_class": "button-secondary"
          }
        }
      }
    }
  ]
}
{% endschema %}
