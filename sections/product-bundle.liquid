{% liquid
  assign max_items = section.settings.max_products | default: 4
  assign items_per_view = section.settings.items_per_view | default: 4
  
  # Get metaobject from metafield custom.cb_bundle (on product)
  assign bundle_metaobject = blank
  assign section_heading = blank
  assign section_subheading = blank
  assign bundle_products = blank
  assign bundle_product = blank
  
  # Try to get bundle metaobject from product metafield
  if product != blank
    assign metafield_value = product.metafields.custom.cb_bundle
    if metafield_value != blank
      assign bundle_metaobject = metafield_value.value
    endif
  endif
  
  # Extract heading and subheading from metaobject
  if bundle_metaobject != blank
    assign section_heading = bundle_metaobject.heading.value | default: bundle_metaobject.heading
    # Try both sub_heading and subheading field names for compatibility
    if bundle_metaobject.sub_heading != blank
      assign section_subheading = bundle_metaobject.sub_heading.value | default: bundle_metaobject.sub_heading
    elsif bundle_metaobject.subheading != blank
      assign section_subheading = bundle_metaobject.subheading.value | default: bundle_metaobject.subheading
    endif
    
    # Get products from the product metafield inside the metaobject
    if bundle_metaobject.product != blank
      assign bundle_product = bundle_metaobject.product.value | default: bundle_metaobject.product
      if bundle_product != blank
        assign bundle_products_metafield = bundle_product.metafields.custom.cb_products_in_the_bundle
        if bundle_products_metafield != blank
          assign bundle_products = bundle_products_metafield.value
        endif
      endif
    endif
  endif
  
  # If no heading/subheading from metaobject, use section settings as fallback
  if section_heading == blank
    assign section_heading = section.settings.top_label
  endif
  if section_subheading == blank
    assign section_subheading = section.settings.section_title
  endif
%}

{% if bundle_products != blank %}
<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  data-testid="product-bundle"
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
    gap-style
    product-bundle-section
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
>
  <div class="product-bundle-header">
    {% if section_heading != blank %}
      <div class="product-bundle-top-label">
        <span class="product-bundle-top-label-text">{{ section_heading }}</span>
      </div>
    {% endif %}
    
    {% if section_subheading != blank %}
      <div class="product-bundle-section-title">
        <span class="product-bundle-section-title-label">{{ section_subheading }}</span>
      </div>
    {% endif %}
  </div>

  {% comment %} Build list of products from the bundle metafield {% endcomment %}
  {% capture list_items %}
    {% if bundle_products != blank %}
      {% assign displayed_count = 0 %}
      {% for product_item in bundle_products %}
        {% if displayed_count < max_items %}
          <div class="resource-list__item" data-product-bundle-item="true" data-product-id="{{ product_item.id }}">
            {% # theme-check-disable UniqueStaticBlockId %}
              {% content_for 'block', type: '_product-card', id: 'product-card', closest.product: product_item %}
            {% # theme-check-enable UniqueStaticBlockId %}
            {% comment %} Add View Product and + buttons using unified component {% endcomment %}
            {% render 'product-card-actions', 
              product: product_item, 
              section_id: section.id
            %}
          </div>
          {% assign displayed_count = displayed_count | plus: 1 %}
          {% comment %} Add split marker after each item except potentially the last {% endcomment %}
          {% unless displayed_count >= max_items %}
            <!--@list/split-->
          {% endunless %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endcapture %}

  {% liquid
    assign list_items_array = list_items | strip | split: '<!--@list/split-->'
    
    # Prepare carousel settings - remove gutters to allow full width
    assign slideshow_gutters = null
    assign gutter_style = '--gutter-slide-width: 0px;'

    assign show_arrows = false
    if section.settings.icons_style != 'none'
      assign show_arrows = true
    endif
  %}

  {% capture slides %}
    {% for item in list_items_array %}
      {% render 'slideshow-slide'
        index : forloop.index0,
        children : item,
        class : 'resource-list__slide product-bundle-slide'
      %}
    {% endfor %}
  {% endcapture %}

  {% comment %} Desktop carousel {% endcomment %}
  <div class="product-bundle-wrapper">
    <div
      class="resource-list resource-list__carousel product-bundle-carousel product-bundle-desktop"
      style="{{ gutter_style }} --column-count: {{ items_per_view }}; --resource-list-column-gap-desktop: {{ section.settings.columns_gap | default: 12 }}px;"
      data-testid="product-bundle-grid"
      data-items-per-view="{{ items_per_view }}"
    >
      {% render 'slideshow',
        ref: 'productBundleDesktop',
        class: 'resource-list__carousel',
        slides: slides,
        show_arrows: show_arrows,
        icon_style: section.settings.icons_style,
        icon_shape: section.settings.icons_shape,
        auto_hide_controls: false,
        infinite: false,
        initial_slide: 0,
        slide_count: list_items_array.size,
        slideshow_gutters: slideshow_gutters,
        arrows_position: 'center'
      %}
    </div>
    <div class="product-bundle-scrollbar-indicator">
      <div class="product-bundle-scrollbar-track">
        <div class="product-bundle-scrollbar-thumb"></div>
      </div>
    </div>
  </div>

  {% comment %} Buy Bundle Button {% endcomment %}
  {% if bundle_product != blank %}
    {% liquid
      assign bundle_price = bundle_product.price | money
      assign bundle_url = bundle_product.url
      if bundle_product.selected_or_first_available_variant.url != blank
        assign bundle_url = bundle_product.selected_or_first_available_variant.url
      endif
    %}
    <div class="product-bundle-button-wrapper">
      <a href="{{ bundle_url }}" class="product-bundle-button">
        Buy the complete Gift set - {{ bundle_price }}
      </a>
    </div>
  {% endif %}
</div>
{% endif %}

<style>
  .product-bundle-header {
    text-align: center;
    margin-bottom: 16px;
  }

  .product-bundle-top-label {
    text-align: center;
    margin-bottom: 0;
  }

  .product-bundle-top-label-text {
    margin: 0;
    font-family: 'Outfit', sans-serif;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    color: #7295BB;
    text-align: center;
    text-transform: lowercase;
    display: block;
  }

  .product-bundle-section-title {
    text-align: center;
    margin-bottom: 0;
  }

  .product-bundle-section-title-label {
    margin: 0;
    font-weight: 500;
    font-size: 24px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  @media screen and (min-width: 750px) {
    .product-bundle-section-title-label {
      font-size: 32px;
    }
  }

  /* Product card media sizing/background in slider */
  [data-testid="product-bundle-grid"] .card-gallery .product-media-container {
    background: url("bg_removal [Background removed].png"), #F7F7F7;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
  }

  [data-testid="product-bundle-grid"] .card-gallery .product-media-container img,
  [data-testid="product-bundle-grid"] .card-gallery .product-media-container picture,
  [data-testid="product-bundle-grid"] .card-gallery .product-media-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Hide sale/sold-out badge on slider images */
  [data-testid="product-bundle-grid"] .product-badges {
    display: none !important;
  }

  /* Product title styling */
  [data-testid="product-bundle-grid"] .text-block--product_title,
  [data-testid="product-bundle-grid"] .text-block--product_title *,
  [data-testid="product-bundle-grid"] .text-block--product_title p {
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-style: normal;
    font-size: 20px;
    line-height: 140%;
    letter-spacing: 0;
    color: #1D425A;
  }

  /* Explicit class injected on product title block */
  [data-testid="product-bundle-grid"] .product-title-text,
  [data-testid="product-bundle-grid"] .product-title-text *,
  [data-testid="product-bundle-grid"] .product-title-text p {
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-style: normal;
    font-size: 20px;
    line-height: 140%;
    letter-spacing: 0;
    color: #1D425A;
  }

  /* Product slider carousel container */
  .product-bundle-carousel {
    position: relative;
  }

  /* Remove horizontal padding for max width */
  [data-testid="product-bundle"] .section--page-width {
    padding-inline: 0 !important;
  }

  [data-testid="product-bundle"] .section--page-width > * {
    padding-inline: 0 !important;
  }

  [data-testid="product-bundle-grid"] {
    padding-inline: 0 !important;
    --peek-next-slide-size: 0px;
    --gutter-slide-width: 0px !important;
    overflow: visible;
  }

  @media (max-width: 749px) {
    [data-testid="product-bundle-grid"] {
      overflow: visible;
    }
  }

  /* Desktop slider styling */
  .product-bundle-desktop .resource-list__carousel {
    --column-count: {{ section.settings.items_per_view | default: 4 }};
    --resource-list-column-gap-desktop: {{ section.settings.columns_gap | default: 12 }}px;
  }

  /* Mobile (max-width: 749px): Show 2 columns like collection pages */
  @media screen and (max-width: 749px) {
    [data-testid="product-bundle-grid"] .product-bundle-desktop .resource-list__carousel {
      --column-count: 2;
      --resource-list-column-gap: {{ section.settings.columns_gap | default: 12 }}px;
    }

    /* Ensure product cards use responsive sizing like collection pages */
    [data-testid="product-bundle-grid"] .resource-list__item {
      min-width: 0;
    }
  }

  .product-bundle-desktop slideshow-slides {
    gap: 5px;
  }
  @media screen and (min-width: 750px) {
    .product-bundle-desktop slideshow-slides {
      gap: {{ section.settings.columns_gap | default: 12 }}px !important;
    }
  }

  /* Position arrows outside the carousel â€“ match Explore More Collections (outer/section carousel only) */
  .product-bundle-wrapper {
    position: relative;
    padding: 0;
  }

  .product-bundle-desktop slideshow-component {
    overflow: visible;
  }

  .product-bundle-desktop slideshow-container {
    position: relative;
    overflow: visible;
  }

  .product-bundle-desktop slideshow-arrows {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100%);
    pointer-events: none;
    z-index: var(--layer-heightened);
    display: flex !important;
  }

  .product-bundle-desktop slideshow-arrows[position='center'] {
    justify-content: space-between;
    align-items: center;
    padding: 0;
  }

  .product-bundle-desktop slideshow-arrows .slideshow-control {
    position: absolute;
    margin: 0;
    pointer-events: auto;
    opacity: 1;
    top: 50%;
    transform: translateY(-50%);
    z-index: var(--layer-heightened);
    transition: opacity 0.3s ease-out;
  }

  .product-bundle-desktop slideshow-arrows .slideshow-control--previous {
    left: -60px;
  }

  .product-bundle-desktop slideshow-arrows .slideshow-control--next {
    right: -60px;
  }

  @media screen and (min-width: 750px) {
    .product-bundle-section {
      overflow-x: clip;
    }
  }

  @media (min-width: 1201px) {
    .product-bundle-section .slideshow-control--style-chevron {
      border: 2px solid #7295bb;
    }
    .product-bundle-section .slideshow-control--style-chevron svg path {
      stroke: #7295bb;
      fill: none;
    }
  }

  @media (min-width: 750px) and (max-width: 1200px) {
    .product-bundle-desktop slideshow-arrows .slideshow-control--previous {
      left: 0;
    }
    .product-bundle-desktop slideshow-arrows .slideshow-control--next {
      right: 0;
    }
    .product-bundle-section .slideshow-control--style-chevron {
      background-color: #7295bb;
    }
    .product-bundle-section .slideshow-control--style-chevron svg path {
      stroke: #ffffff;
      fill: none;
    }
  }

  /* Tablet (iPad) - Show 3 items per row */
  @media (min-width: 750px) and (max-width: 1024px) {
    .product-bundle-desktop .resource-list__carousel {
      --column-count: 3;
    }

    [data-testid="product-bundle-grid"] {
      overflow: hidden;
    }

    .product-bundle-desktop .resource-list__slide {
      width: calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
      max-width: calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
      flex: 0 0 calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
    }
  }

  /* Hide scrollbar indicator on desktop */
  @media screen and (min-width: 750px) {
    .product-bundle-scrollbar-indicator {
      display: none !important;
    }
  }

  /* Hide default quick-add on hover for product slider (same as collection page) */
  [data-testid="product-bundle"] product-card[data-collection-page="true"]:is(:hover, :focus-within) .quick-add__button:not(.product-slider-quick-add-button) {
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Buy Bundle Button Styling */
  .product-bundle-button-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 32px;
  }

  .product-bundle-button {
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #7295BB;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 16px;
    line-height: 140%;
    text-transform: uppercase;
    color: #7295BB;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    background: transparent;
    cursor: pointer;
  }

  .product-bundle-button:hover {
    background-color: #7295BB;
    color: #ffffff;
  }

  @media (max-width: 749px) {
    .product-bundle-button-wrapper {
      margin-top: 24px;
    }

    .product-bundle-button {
      font-size: 14px;
    }
  }


  @media screen and (min-width: 750px) {
    .product-bundle-header {
      margin-bottom: 24px;
    }

    .product-bundle-top-label-text {
      font-size: 38px;
    }
  }

  /* Mobile: Add left padding, keep right edge flush for peek */
  @media screen and (max-width: 749px) {
    /* Break out of page-width grid to touch right edge - only for carousel wrapper */
    [data-testid="product-bundle"].section--page-width > .product-bundle-wrapper {
      grid-column: 1 / -1;
      padding-inline-start: var(--page-margin, 16px) !important;
      padding-inline-end: 0 !important;
    }

    /* Keep header and button wrapper in normal grid column */
    [data-testid="product-bundle"].section--page-width > .product-bundle-header,
    [data-testid="product-bundle"].section--page-width > .product-bundle-button-wrapper {
      grid-column: 2;
    }

    .product-bundle-header {
      margin-bottom: 16px;
    }

    [data-testid="product-bundle-grid"] .card-gallery .product-media-container {
      background: url("bg_removal [Background removed].png"), #F7F7F7;
    }

    [data-testid="product-bundle-grid"] .text-block--product_title,
    [data-testid="product-bundle-grid"] .text-block--product_title *,
    [data-testid="product-bundle-grid"] .text-block--product_title p {
      font-size: 16px;
      line-height: 140%;
      color: #1D425A;
    }

    [data-testid="product-bundle-grid"] .product-title-text,
    [data-testid="product-bundle-grid"] .product-title-text *,
    [data-testid="product-bundle-grid"] .product-title-text p {
      font-size: 16px;
      line-height: 140%;
      letter-spacing: 0;
      color: #1D425A;
    }

    .product-bundle-wrapper {
      padding: 0;
      padding-inline-start: 0 !important;
      padding-inline-end: 0 !important;
      overflow: visible;
      width: 100%;
    }

    .product-bundle-desktop slideshow-container {
      overflow: visible;
      width: 100%;
    }

    .product-bundle-desktop slideshow-arrows {
      display: none !important;
    }

    /* Allow peek of next slide on mobile - touch right edge */
    .product-bundle-desktop slideshow-component slideshow-slides,
    .product-bundle-desktop slideshow-component[disabled='true'] slideshow-slides {
      overflow-x: auto !important;
      overflow-y: visible !important;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      scroll-snap-type: x mandatory;
    }

    .product-bundle-desktop slideshow-slides::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    /* Add padding after last slide so it doesn't touch edge when scrolled to end - only for main carousel */
    [data-testid="product-bundle-grid"] > slideshow-component > slideshow-container > slideshow-slides > slideshow-slide:last-child {
      padding-inline-end: var(--page-margin, 16px);
    }

    /* Custom scrollbar indicator */
    .product-bundle-scrollbar-indicator {
      width: auto;
      max-width: calc(100% - var(--page-margin, 16px));
      height: 4px;
      position: relative;
      margin-top: 37px;
      margin-right: var(--page-margin, 16px);
      box-sizing: border-box;
    }

    .product-bundle-scrollbar-track {
      width: 100%;
      height: 4px;
      background-color: #EEEEEE;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }

    .product-bundle-scrollbar-thumb {
      height: 4px;
      background-color: #7295BB;
      border-radius: 10px;
      position: absolute;
      left: 0;
      top: 0;
      transition: width 0.1s ease-out;
      min-width: 20px;
      cursor: grab;
      user-select: none;
    }

    .product-bundle-scrollbar-thumb:active {
      cursor: grabbing;
    }

    .product-bundle-scrollbar-track {
      cursor: pointer;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const desktopCarousel = document.querySelector('[data-testid="product-bundle-grid"]');
    if (!desktopCarousel) return;

    const itemsPerView = parseInt(desktopCarousel.getAttribute('data-items-per-view')) || 4;
    const slideshow = desktopCarousel.querySelector('slideshow-component[ref="productBundleDesktop"]');
    if (!slideshow) return;

    const previousBtn = slideshow.querySelector('slideshow-arrows .slideshow-control--previous');
    const nextBtn = slideshow.querySelector('slideshow-arrows .slideshow-control--next');
    const slides = slideshow.querySelectorAll('slideshow-slide');

    if (!previousBtn || !nextBtn || slides.length === 0) return;

    let currentIndex = 0;
    const totalSlides = slides.length;
    const maxIndex = Math.max(0, totalSlides - itemsPerView);

    // Override previous button
    previousBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      currentIndex = Math.max(0, currentIndex - itemsPerView);
      if (slides[currentIndex]) {
        slideshow.select(currentIndex, e, { animate: true });
      }
    });

    // Override next button
    nextBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      currentIndex = Math.min(maxIndex, currentIndex + itemsPerView);
      if (slides[currentIndex]) {
        slideshow.select(currentIndex, e, { animate: true });
      }
    });

    // Update current index when slideshow changes
    slideshow.addEventListener('slideshow:select', function(event) {
      currentIndex = event.detail.index || 0;
    });

    // Add data-collection-page attribute to product cards to hide default quick-add on hover
    function setupProductCards() {
      const productCards = desktopCarousel.querySelectorAll('product-card');
      productCards.forEach(function(card) {
        card.setAttribute('data-collection-page', 'true');
      });
    }

    // Move product action buttons to be after the price block inside product-card
    function positionProductActions() {
      const productItems = desktopCarousel.querySelectorAll('[data-product-bundle-item="true"]');
      productItems.forEach(function(item) {
        const actions = item.querySelector('.product-card-actions');
        if (!actions) return;

        // Find the product-card element
        const productCard = item.querySelector('product-card');
        if (!productCard) {
          // If no product-card found yet, try again later
          return;
        }

        // Find the product-card__content (where all blocks are)
        const cardContent = productCard.querySelector('.product-card__content');
        if (!cardContent) {
          // If no cardContent found yet, try again later
          return;
        }

        // Check if already inside cardContent
        if (actions.parentNode === cardContent) {
          // Already inside, check if position is correct
          const priceBlock = cardContent.querySelector('product-price');
          if (priceBlock && priceBlock.nextElementSibling === actions) {
            return; // Already in correct position
          }
        }

        // Find the price block (product-price element) inside cardContent
        const priceBlock = cardContent.querySelector('product-price');
        
        if (priceBlock) {
          // Remove from current position if needed
          if (actions.parentNode && actions.parentNode !== cardContent) {
            actions.remove();
          }
          // Insert after price block inside cardContent
          if (priceBlock.nextSibling) {
            cardContent.insertBefore(actions, priceBlock.nextSibling);
          } else {
            cardContent.appendChild(actions);
          }
        } else {
          // If no price block found, append to end of cardContent
          if (actions.parentNode !== cardContent) {
            actions.remove();
            cardContent.appendChild(actions);
          }
        }
      });
    }

    // Setup product cards and position buttons
    function initializeProductBundle() {
      setupProductCards();
      // Run multiple times to ensure it works
      positionProductActions();
      setTimeout(positionProductActions, 50);
      setTimeout(positionProductActions, 200);
    }

    // Initialize after initial load - use multiple attempts
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeProductBundle);
    } else {
      initializeProductBundle();
    }

    // Also initialize after any dynamic updates
    const observer = new MutationObserver(function(mutations) {
      let shouldReposition = false;
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
          shouldReposition = true;
        }
      });
      if (shouldReposition) {
        setTimeout(initializeProductBundle, 50);
      }
    });

    observer.observe(desktopCarousel, {
      childList: true,
      subtree: true
    });

    // Custom scrollbar indicator for mobile
    function setupProductBundleScrollbar() {
      const slides = desktopCarousel.querySelector('.product-bundle-desktop slideshow-component slideshow-slides') || 
                     desktopCarousel.querySelector('.product-bundle-desktop slideshow-slides');
      const scrollbarThumb = document.querySelector('.product-bundle-scrollbar-thumb');
      const scrollbarIndicator = document.querySelector('.product-bundle-scrollbar-indicator');
      
      if (!slides || !scrollbarThumb || !scrollbarIndicator) return;
      function updateScrollbar() {
        // Only show on mobile
        if (window.innerWidth > 749) {
          scrollbarIndicator.style.display = 'none';
          return;
        }

        const scrollLeft = slides.scrollLeft;
        const scrollWidth = slides.scrollWidth;
        const clientWidth = slides.clientWidth;
        const maxScroll = scrollWidth - clientWidth;
        
        if (maxScroll <= 0) {
          scrollbarIndicator.style.display = 'none';
          return;
        }
        
        scrollbarIndicator.style.display = 'block';
        
        // Calculate thumb width and position
        const thumbWidth = (clientWidth / scrollWidth) * 100;
        const thumbPosition = (scrollLeft / maxScroll) * (100 - thumbWidth);
        
        scrollbarThumb.style.width = thumbWidth + '%';
        scrollbarThumb.style.left = thumbPosition + '%';
      }

      // Update on scroll
      slides.addEventListener('scroll', updateScrollbar);
      
      // Update on resize
      const resizeObserver = new ResizeObserver(updateScrollbar);
      resizeObserver.observe(slides);
      
      window.addEventListener('resize', updateScrollbar);
      
      // Initial update
      updateScrollbar();
      
      // Update periodically to catch any changes
      setInterval(updateScrollbar, 100);

      // Make scrollbar interactive - click on track to jump
      const scrollbarTrack = scrollbarIndicator.querySelector('.product-bundle-scrollbar-track');
      if (scrollbarTrack) {
        scrollbarTrack.addEventListener('click', function(e) {
          if (window.innerWidth > 749) return;
          
          const trackRect = scrollbarTrack.getBoundingClientRect();
          const clickX = e.clientX - trackRect.left;
          const trackWidth = trackRect.width;
          const percentage = clickX / trackWidth;
          
          const scrollWidth = slides.scrollWidth;
          const clientWidth = slides.clientWidth;
          const maxScroll = scrollWidth - clientWidth;
          const targetScroll = percentage * maxScroll;
          
          slides.scrollTo({
            left: targetScroll,
            behavior: 'smooth'
          });
        });
      }

      // Make scrollbar thumb draggable
      let isDragging = false;
      let startX = 0;
      let startScrollLeft = 0;

      const handleMouseMove = function(e) {
        if (!isDragging || window.innerWidth > 749) return;
        
        const scrollbarTrack = scrollbarIndicator.querySelector('.product-bundle-scrollbar-track');
        if (!scrollbarTrack) return;
        
        const trackRect = scrollbarTrack.getBoundingClientRect();
        const deltaX = e.clientX - startX;
        const trackWidth = trackRect.width;
        const scrollWidth = slides.scrollWidth;
        const clientWidth = slides.clientWidth;
        const maxScroll = scrollWidth - clientWidth;
        const scrollRatio = maxScroll / trackWidth;
        const newScrollLeft = startScrollLeft + (deltaX * scrollRatio);
        
        slides.scrollLeft = Math.max(0, Math.min(maxScroll, newScrollLeft));
      };

      const handleMouseUp = function() {
        isDragging = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      scrollbarThumb.addEventListener('mousedown', function(e) {
        if (window.innerWidth > 749) return;
        isDragging = true;
        startX = e.clientX;
        startScrollLeft = slides.scrollLeft;
        e.preventDefault();
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });

      // Touch support for mobile
      const handleTouchMove = function(e) {
        if (!isDragging || window.innerWidth > 749) return;
        
        const scrollbarTrack = scrollbarIndicator.querySelector('.product-bundle-scrollbar-track');
        if (!scrollbarTrack) return;
        
        const trackRect = scrollbarTrack.getBoundingClientRect();
        const deltaX = e.touches[0].clientX - startX;
        const trackWidth = trackRect.width;
        const scrollWidth = slides.scrollWidth;
        const clientWidth = slides.clientWidth;
        const maxScroll = scrollWidth - clientWidth;
        const scrollRatio = maxScroll / trackWidth;
        const newScrollLeft = startScrollLeft + (deltaX * scrollRatio);
        
        slides.scrollLeft = Math.max(0, Math.min(maxScroll, newScrollLeft));
      };

      const handleTouchEnd = function() {
        isDragging = false;
        document.removeEventListener('touchmove', handleTouchMove);
        document.removeEventListener('touchend', handleTouchEnd);
      };

      scrollbarThumb.addEventListener('touchstart', function(e) {
        if (window.innerWidth > 749) return;
        isDragging = true;
        startX = e.touches[0].clientX;
        startScrollLeft = slides.scrollLeft;
        e.preventDefault();
        document.addEventListener('touchmove', handleTouchMove);
        document.addEventListener('touchend', handleTouchEnd);
      });
    }

    setupProductBundleScrollbar();
    setTimeout(setupProductBundleScrollbar, 500);
  });
</script>

{% schema %}
{
  "name": "Product Bundle",
  "class": "ui-test-product-bundle",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    },
    {
      "type": "_divider"
    },
    {
      "type": "_product-card"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "top_label",
      "label": "Top Label (Fallback)",
      "default": "bundle",
      "info": "Text displayed above the section title. This is used as fallback if not provided in the metaobject."
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title (Fallback)",
      "default": "PRODUCT BUNDLE",
      "info": "Title displayed above the product slider. This is used as fallback if not provided in the metaobject."
    },
    {
      "type": "header",
      "content": "Content Source"
    },
    {
      "type": "paragraph",
      "content": "Products are automatically loaded from the product metafield 'custom.cb_bundle' which is a metaobject with handle 'cb_bundle'. The metaobject should have 'heading', 'subheading', and 'product' fields. The product field should have a metafield 'custom.cb_products_in_the_bundle' containing a list of products."
    },
    {
      "type": "header",
      "content": "Slider Settings"
    },
    {
      "type": "range",
      "id": "items_per_view",
      "label": "Items per view",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4,
      "info": "Number of products to show at once in the slider"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 8,
      "info": "Maximum number of products to display"
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Horizontal Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "quick_add",
      "label": "Enable quick add",
      "default": true,
      "info": "Show the quick add button (+) on product cards"
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow Style",
      "options": [
        {
          "value": "arrow",
          "label": "Arrows"
        },
        {
          "value": "chevron",
          "label": "Chevrons"
        },
        {
          "value": "arrows_large",
          "label": "Large Arrows"
        },
        {
          "value": "chevron_large",
          "label": "Large Chevrons"
        },
        {
          "value": "blue_arrows",
          "label": "Blue arrows"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "chevron"
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow Background",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ],
      "default": "circle",
      "visible_if": "{{ section.settings.icons_style != 'none' }}"
    },
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page"
        },
        {
          "value": "full-width",
          "label": "Full"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Product Bundle",
      "category": "Products",
      "settings": {
        "top_label": "bundle",
        "section_title": "PRODUCT BUNDLE",
        "items_per_view": 4,
        "max_products": 8,
        "columns_gap": 12,
        "quick_add": true,
        "icons_style": "chevron",
        "icons_shape": "circle",
        "section_width": "page-width",
        "gap": 12,
        "color_scheme": "scheme-1",
        "padding-block-start": 48,
        "padding-block-end": 48
      },
      "blocks": {
        "product-card": {
          "type": "_product-card",
          "name": "Product Card",
          "static": true,
          "settings": {
            "product_card_gap": 4,
            "inherit_color_scheme": true,
            "color_scheme": "",
            "border": "none",
            "border_width": 1,
            "border_opacity": 100,
            "border_radius": 0,
            "padding-block-start": 0,
            "padding-block-end": 0,
            "padding-inline-start": 0,
            "padding-inline-end": 0,
            "show_view_product_button": true
          },
          "blocks": {
            "product-card-gallery": {
              "type": "_product-card-gallery",
              "name": "Product Card Media",
              "settings": {
                "image_ratio": "adapt",
                "border": "none",
                "border_width": 1,
                "border_opacity": 100,
                "border_radius": 0,
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "product_title": {
              "type": "product-title",
              "name": "Product Title",
              "settings": {
                "width": "fit-content",
                "max_width": "normal",
                "alignment": "left",
                "type_preset": "rte",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "wrap": "pretty",
                "color": "var(--color-foreground)",
                "background": false,
                "background_color": "#00000026",
                "corner_radius": 0,
                "padding-block-start": 4,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "price": {
              "type": "price",
              "name": "Product Price",
              "settings": {
                "show_sale_price_first": true,
                "show_installments": false,
                "show_tax_info": false,
                "type_preset": "h6",
                "width": "100%",
                "alignment": "left",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "color": "var(--color-foreground)",
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            }
          },
          "block_order": ["product-card-gallery", "product_title", "price"]
        }
      },
      "block_order": []
    }
  ]
}
{% endschema %}
