{%- comment -%}
  Popular blog posts

  Fetches up to 4 blog posts from BLOG metafield:
    blog.metafields.custom.cb_popular_blogs

  Layout:
  - 1 post: single row
  - 2-4 posts: first on the left, rest stacked on the right
  - Mobile: all stacked
{%- endcomment -%}

{%- assign target_blog = section.settings.blog -%}
{%- if target_blog == blank and blog != blank -%}
  {%- assign target_blog = blog -%}
{%- endif -%}

{%- assign mf = blank -%}
{%- if target_blog != blank -%}
  {%- assign mf = target_blog.metafields.custom.cb_popular_blogs -%}
{%- endif -%}

{%- assign items = blank -%}
{%- if mf != blank -%}
  {%- assign items = mf.value -%}
{%- endif -%}

{%- assign primary = blank -%}
{%- assign resolved_count = 0 -%}

{%- if items != blank -%}
  {%- for raw_item in items limit: 4 -%}
    {%- assign candidate = raw_item -%}
    {%- if raw_item.article != blank -%}
      {%- assign candidate = raw_item.article -%}
    {%- endif -%}
    {%- if candidate != blank and candidate.url != blank -%}
      {%- assign primary = candidate -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- for raw_item in items limit: 4 -%}
    {%- assign candidate = raw_item -%}
    {%- if raw_item.article != blank -%}
      {%- assign candidate = raw_item.article -%}
    {%- endif -%}
    {%- if candidate != blank and candidate.url != blank -%}
      {%- assign resolved_count = resolved_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if resolved_count > 0 and primary != blank -%}
  <div class="section-background color-{{ section.settings.color_scheme }}"></div>

  <div
    class="
      section
      section--{{ section.settings.section_width }}
      color-{{ section.settings.color_scheme }}
      spacing-style
      popular-blog-posts
    "
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    {%- if section.settings.heading != blank -%}
      <div class="popular-blog-posts__header">
        <h2 class="popular-blog-posts__heading">{{ section.settings.heading }}</h2>
      </div>
    {%- endif -%}

    {%- if resolved_count == 1 -%}
      <div class="popular-blog-posts__layout popular-blog-posts__layout--single">
        <article class="popular-blog-posts__card popular-blog-posts__card--primary">
          {%- if primary.image -%}
            <a class="popular-blog-posts__image-link" href="{{ primary.url }}">
              {{
                primary.image
                | image_url: width: 1200
                | image_tag:
                  loading: 'lazy',
                  class: 'popular-blog-posts__image',
                  alt: primary.title
              }}
            </a>
          {%- endif -%}

          <div class="popular-blog-posts__content">
            <a class="popular-blog-posts__title-link" href="{{ primary.url }}">
              <h3 class="popular-blog-posts__title">{{ primary.title }}</h3>
            </a>
            {% render 'blog-read-time', article: primary %}
            <div class="popular-blog-posts__details">
              <span>By: <span class="popular-blog-posts__author-name">{{ primary.author }}</span></span>
              <span class="popular-blog-posts__separator">|</span>
              <span>{{- primary.published_at | time_tag: format: 'date' -}}</span>
            </div>
          </div>
        </article>
      </div>
    {%- else -%}
      <div class="popular-blog-posts__layout popular-blog-posts__layout--split">
        <article class="popular-blog-posts__card popular-blog-posts__card--primary">
          {%- if primary.image -%}
            <a class="popular-blog-posts__image-link" href="{{ primary.url }}">
              {{
                primary.image
                | image_url: width: 1200
                | image_tag:
                  loading: 'lazy',
                  class: 'popular-blog-posts__image',
                  alt: primary.title
              }}
            </a>
          {%- endif -%}

          <div class="popular-blog-posts__content">
            <a class="popular-blog-posts__title-link" href="{{ primary.url }}">
              <h3 class="popular-blog-posts__title">{{ primary.title }}</h3>
            </a>
            {% render 'blog-read-time', article: primary %}
            <div class="popular-blog-posts__details">
              <span>By: <span class="popular-blog-posts__author-name">{{ primary.author }}</span></span>
              <span class="popular-blog-posts__separator">|</span>
              <span>{{- primary.published_at | time_tag: format: 'date' -}}</span>
            </div>
          </div>
        </article>

        <div class="popular-blog-posts__secondary">
          {%- assign rendered_secondary = 0 -%}
          {%- for raw_item in items limit: 4 -%}
            {%- if rendered_secondary >= 3 -%}{%- break -%}{%- endif -%}

            {%- assign candidate = raw_item -%}
            {%- if raw_item.article != blank -%}
              {%- assign candidate = raw_item.article -%}
            {%- endif -%}

            {%- if candidate == blank or candidate.url == blank -%}
              {%- continue -%}
            {%- endif -%}

            {%- if candidate.url == primary.url -%}
              {%- continue -%}
            {%- endif -%}

            {%- assign rendered_secondary = rendered_secondary | plus: 1 -%}
            <article class="popular-blog-posts__card popular-blog-posts__card--secondary">
              {%- if candidate.image -%}
                <a class="popular-blog-posts__thumb-link" href="{{ candidate.url }}">
                  {{
                    candidate.image
                    | image_url: width: 480
                    | image_tag:
                      loading: 'lazy',
                      class: 'popular-blog-posts__thumb',
                      alt: candidate.title
                  }}
                </a>
              {%- endif -%}

              <div class="popular-blog-posts__content popular-blog-posts__content--secondary">
                <a class="popular-blog-posts__title-link" href="{{ candidate.url }}">
                  <h3 class="popular-blog-posts__title popular-blog-posts__title--secondary">{{ candidate.title }}</h3>
                </a>
                {% render 'blog-read-time', article: candidate %}
                <div class="popular-blog-posts__details">
                  <span>By: <span class="popular-blog-posts__author-name">{{ candidate.author }}</span></span>
                  <span class="popular-blog-posts__separator">|</span>
                  <span>{{- candidate.published_at | time_tag: format: 'date' -}}</span>
                </div>
              </div>
            </article>
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </div>
{%- elsif request.design_mode -%}
  <div class="section-background color-{{ section.settings.color_scheme }}"></div>
  <div
    class="
      section
      section--{{ section.settings.section_width }}
      color-{{ section.settings.color_scheme }}
      spacing-style
      popular-blog-posts
    "
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    <p style="margin: 0;">
      {%- if target_blog == blank -%}
        Select a Blog in this sectionâ€™s settings, or add this section to a blog template.
      {%- elsif mf == blank -%}
        Metafield <code>custom.cb_popular_blogs</code> is not set on blog <strong>{{ target_blog.title }}</strong>.
      {%- else -%}
        Metafield <code>custom.cb_popular_blogs</code> exists (type: <code>{{ mf.type }}</code>) but no items resolved.
      {%- endif -%}
    </p>
  </div>
{%- endif -%}

{% stylesheet %}
  .popular-blog-posts {
    min-width: 0;
  }

  .popular-blog-posts__header {
    margin-bottom: var(--gap-md, 16px);
  }

  .popular-blog-posts__heading {
    margin: 0;
    font-weight: 500;
    font-size: 24px;
    line-height: 120%;
  }

  @media (min-width: 750px) {
    .popular-blog-posts__heading {
      font-size: 32px;
    }
  }

  .popular-blog-posts__layout {
    min-width: 0;
  }

  /* Desktop: first on left, rest stacked on right */
  .popular-blog-posts__layout--split {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: var(--gap-lg, 24px);
    align-items: start;
  }

  .popular-blog-posts__secondary {
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--gap-md, 16px);
  }

  /* Mobile: all stacked */
  @media (max-width: 749px) {
    .popular-blog-posts__layout--split {
      grid-template-columns: 1fr;
    }

    .popular-blog-posts__secondary {
      gap: var(--gap-sm, 12px);
    }
  }

  .popular-blog-posts__card {
    min-width: 0;
  }

  .popular-blog-posts__image-link,
  .popular-blog-posts__thumb-link {
    display: block;
    text-decoration: none;
  }

  .popular-blog-posts__image {
    width: 100%;
    height: auto;
    display: block;
    aspect-ratio: 16 / 9;
    object-fit: cover;
  }

  .popular-blog-posts__card--secondary {
    display: flex;
    gap: var(--gap-md, 16px);
    align-items: flex-start;
    min-width: 0;
  }

  /*
    Responsive thumbnail sizing:
    - Let the thumbnail width scale with viewport, but stay within min/max bounds
    - Use aspect-ratio to keep it landscape without hard-coding height
  */
  .popular-blog-posts__thumb-link {
    flex: 0 0 clamp(96px, 18vw, 220px);
    width: clamp(96px, 18vw, 220px);
  }

  .popular-blog-posts__thumb {
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    display: block;
    flex: 0 0 auto;
  }

  /* Mobile: secondary thumbnails in portrait (keep primary image unchanged) */
  @media (max-width: 749px) {
    .popular-blog-posts__thumb {
      aspect-ratio: 4 / 4.99;
    }
  }

  .popular-blog-posts__content {
    padding-top: 10px;
    min-width: 0;
  }

  .popular-blog-posts__content--secondary {
    padding-top: 0;
    flex: 1 1 auto;
    min-width: 0;
  }

  .popular-blog-posts__title-link {
    display: block;
    color: var(--color-foreground);
    text-decoration: none;
    min-width: 0;
    max-width: 100%;
  }

  .popular-blog-posts__title-link:hover {
    color: #7295bb;
  }

  .popular-blog-posts__title {
    display: block;
    margin: 0;
    font-weight: 500;
    line-height: 120%;
    font-size: 20px;
    overflow-wrap: anywhere;
    max-width: 100%;

    /* Allow wrapping (2 lines max) */
    white-space: normal;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }

  .popular-blog-posts__title--secondary {
    font-size: 16px;
  }

  @media (min-width: 750px) {
    .popular-blog-posts__title {
      font-size: 28px;
    }
  }

  /* Force the meta content onto separate lines */
  .popular-blog-posts .blog-read-time {
    display: block;
    margin-top: 6px;
  }

  .popular-blog-posts__details {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
    font-size: 14px;
    color: var(--color-foreground);
    min-width: 0;
    flex-wrap: wrap;
  }

  @media (min-width: 750px) {
    .popular-blog-posts__details {
      gap: 9px;
    }
  }

  .popular-blog-posts__author-name {
    text-decoration: underline;
  }

  .popular-blog-posts__separator {
    opacity: 0.7;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Popular blog posts",
  "tag": "section",
  "class": "popular-blog-posts",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog",
      "info": "If not set, uses the current blog page's blog."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Popular blogs"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        { "value": "page-width", "label": "Page" },
        { "value": "full-width", "label": "Full" }
      ],
      "default": "page-width"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Popular blog posts",
      "category": "Blog"
    }
  ]
}
{% endschema %}

