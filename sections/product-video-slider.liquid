{% liquid
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 1
  assign gap = section.settings.gap | default: 16
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% if section.settings.section_width == 'page-width' %}
      overflow: visible;
    {% endif %}
  "
>
  <div class="product-video-slider__header">
    {% if heading != blank %}
      <h2 class="product-video-slider__heading">{{ heading }}</h2>
    {% endif %}
    {% if subheading != blank %}
      <h3 class="product-video-slider__subheading">{{ subheading }}</h3>
    {% endif %}
  </div>

  {% if section.blocks.size > 0 %}
    {% liquid
      if section.settings.show_arrows == false
        assign effective_icons_style = 'none'
      else
        assign effective_icons_style = section.settings.icons_style
      endif

      assign slideshow_gutters = null
      assign gutter_style = '--gutter-slide-width: 0px;'
    %}

    {% capture slides %}
      {% for block in section.blocks %}
        {% if forloop.index0 > 0 %}<!--@list/split-->{% endif %}
        {% liquid
          assign block_video = block.settings.video
          assign block_image = block.settings.image
          assign block_product = block.settings.product
          assign video_to_show = null
          assign preview_image = null

          if block_video != blank
            assign video_to_show = block_video
            assign preview_image = block_video.preview_image
          elsif block_image != blank
            assign video_to_show = block_image
            assign preview_image = block_image
          else
            assign preview_image = block_product.featured_image
          endif
        %}
        
        <div class="product-video-slider__item" {{ block.shopify_attributes }}>
          <div class="product-video-slider__video-wrapper">
            {% if video_to_show != blank %}
              {% render 'video',
                video: video_to_show,
                video_loop: true,
                video_autoplay: false,
                disable_controls: true,
                section_id: section.id,
                video_class: 'product-video-slider__video',
                video_preview_image: preview_image
              %}
            {% elsif block_image != blank %}
              <div class="product-video-slider__image-wrapper">
                {{
                  block_image
                  | image_url: width: 3840
                  | image_tag: widths: '240, 352, 832, 1200, 1600, 1920, 2560, 3840', sizes: '100vw', loading: 'lazy', class: 'product-video-slider__image', alt: block_image.alt
                }}
              </div>
            {% else %}
              <div class="product-video-slider__placeholder-video">
                {{ 'hero-apparel-3' | placeholder_svg_tag: 'product-video-slider__placeholder-svg' }}
              </div>
            {% endif %}
          </div>
          
          {% if block_product != blank %}
            <div class="product-video-slider__product-info">
              {% if block_product.featured_image != blank %}
                <div class="product-video-slider__product-image-wrapper">
                  <a href="{{ block_product.url }}" class="product-video-slider__product-image-link">
                    {{
                      block_product.featured_image
                      | image_url: width: 200
                      | image_tag: widths: '100, 200', sizes: '100px', loading: 'lazy', class: 'product-video-slider__product-image', alt: block_product.featured_image.alt
                    }}
                  </a>
                </div>
              {% endif %}
              <div class="product-video-slider__product-details">
                <h4 class="product-video-slider__product-title">
                  <a href="{{ block_product.url }}" class="product-video-slider__product-link">
                    {{ block_product.title }}
                  </a>
                </h4>
                <div class="product-video-slider__product-price">
                  {% render 'price', product_resource: block_product, show_sale_price_first: true %}
                </div>
              </div>
              {% if settings.quick_add and block_product.available %}
                <div class="product-video-slider__quick-add-wrapper">
                  {% liquid
                    assign product_form_id = 'QuickAdd-ProductForm-' | append: block_product.id | append: '-' | append: block.id
                    assign variant = block_product.selected_or_first_available_variant
                  %}
                  <a href="{{ block_product.url }}" class="product-video-slider__product-url" ref="productCardLink" style="display: none;"></a>
                  <quick-add-component
                    class="quick-add color-{{ section.settings.color_scheme }}"
                    ref="quickAdd"
                    data-product-title="{{ block_product.title }}"
                    data-quick-add-button="choose"
                    data-product-options-count="{{ block_product.options.size }}"
                  >
                    <product-form-component
                      data-section-id="{{ section.id }}"
                      data-product-id="{{ block_product.id }}"
                      on:submit="/handleSubmit"
                      class="quick-add__product-form-component"
                    >
                      <div
                        class="visually-hidden"
                        aria-live="assertive"
                        role="status"
                        aria-atomic="true"
                        ref="liveRegion"
                      ></div>
                      {%- form 'product', block_product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                        <input
                          type="hidden"
                          name="id"
                          ref="variantId"
                          value="{{ variant.id }}"
                          {% if variant.available == false %}
                            disabled
                          {% endif %}
                        >
                        <input
                          type="hidden"
                          name="quantity"
                          value="{% if variant.quantity_rule.min %}{{ variant.quantity_rule.min }}{% else %}1{% endif %}"
                        >
                        <button
                          class="button quick-add__button quick-add__button--choose add-to-cart-button product-video-slider__plus-button"
                          type="button"
                          name="add"
                          on:click="quick-add-component/handleClick"
                        >
                          <span class="product-video-slider__plus-text">+</span>
                        </button>
                      {%- endform -%}
                    </product-form-component>
                  </quick-add-component>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endcapture %}

    {% liquid
      assign slide_content = slides | strip
      assign slides_array = slide_content | split: '<!--@list/split-->'
    %}

    <div class="product-video-slider__carousel-wrapper">
      <div
        class="product-video-slider__carousel resource-list__carousel"
        style="{{ gutter_style }} --resource-list-column-gap-desktop: {{ gap }}px; --resource-list-column-gap: {{ gap }}px; --column-count: {{ columns_desktop }}; --column-count-mobile: {{ columns_mobile }}; --slide-width-max: 450px;"
      >
        {% capture slideshow_slides %}
          {% for item in slides_array %}
            {% render 'slideshow-slide',
              index: forloop.index0,
              children: item,
              class: 'resource-list__slide product-video-slider__slide'
            %}
          {% endfor %}
        {% endcapture %}
        
        {% render 'slideshow',
          ref: 'productVideoSlider',
          class: 'product-video-slider__slideshow resource-list__carousel',
          slides: slideshow_slides,
          show_arrows: section.settings.show_arrows,
          icon_style: effective_icons_style,
          icon_shape: section.settings.icons_shape,
          auto_hide_controls: false,
          infinite: false,
          initial_slide: 0,
          slide_count: slides_array.size,
          slideshow_gutters: slideshow_gutters
        %}
      </div>
    </div>
  {% else %}
    <div class="product-video-slider__placeholder">
      <p>Please add video items to display.</p>
    </div>
  {% endif %}
</div>

{% stylesheet %}
  @media screen and (max-width: 749px) {
    .section--page-width {
      overflow: visible !important;
    }
  }
  
  .product-video-slider__header {
    text-align: center;
    margin-bottom: 32px;
  }

  .product-video-slider__heading {
    font-family: 'Sacramento', cursive;
    font-style: normal;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    text-align: center;
    color: #7295BB;
    margin: 0 0 16px 0;
  }

  .product-video-slider__subheading {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 24px;
    line-height: 150%;
    text-align: center;
    text-transform: uppercase;
    color: #1D425A;
    margin: 0;
  }

  @media screen and (min-width: 750px) {
    .product-video-slider__heading {
      font-size: 38px;
    }
    
    .product-video-slider__subheading {
      font-size: 32px;
    }
  }

  .product-video-slider__item {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    touch-action: manipulation;
  }
  
  .product-video-slider__image-wrapper {
    width: 100%;
    aspect-ratio: 204 / 321;
    overflow: hidden;
    border-radius: 4px;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__image-wrapper {
      aspect-ratio: 281 / 442;
    }
  }
  
  .product-video-slider__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .product-video-slider__product-info {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px;
    background-color: #FFFFFF;
    border-radius: 4px;
    box-sizing: border-box;
    position: relative;
    width: 100%;
  }
  
  .product-video-slider__product-image-wrapper {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    overflow: visible;
    border-radius: 4px;
    background-color: #F7F7F7;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__product-image-wrapper {
      width: 53px;
      height: 53px;
    }
  }
  
  .product-video-slider__product-image-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background-color: transparent;
  }
  
  .product-video-slider__product-image {
    object-fit: cover;
    display: block;
    background-color: transparent;
    margin: auto;
  }
  
  .product-video-slider__product-image-wrapper img.product-video-slider__product-image,
  .product-video-slider__product-image-wrapper img {
    background-color: #F7F7F7 !important;
  }
  
  .product-video-slider__product-details {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .product-video-slider__product-title {
    margin: 0;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 16px;
    color: #1D425A;
    display: flex;
    align-items: center;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__product-title {
      font-size: 14px;
      line-height: 18px;
    }
  }
  
  .product-video-slider__product-link {
    color: inherit;
    text-decoration: none;
    transition: opacity 0.2s ease;
  }
  
  .product-video-slider__product-link:hover {
    opacity: 0.8;
  }
  
  .product-video-slider__product-price {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 160%;
    color: #1D425A;
  }
  
  .product-video-slider__product-price .price {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 160%;
    color: #1D425A;
  }
  
  .product-video-slider__product-price .compare-at-price,
  .product-video-slider__product-price .price-discount-badge,
  .product-video-slider__product-price .price-snippet .compare-at-price {
    display: none !important;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__product-price {
      font-size: 14px;
      line-height: 160%;
    }
    
    .product-video-slider__product-price .price {
      font-size: 14px;
      line-height: 160%;
    }
  }
  
  .product-video-slider__quick-add-wrapper {
    position: relative;
    width: 20.99px;
    height: 20.99px;
    pointer-events: all;
    flex-shrink: 0;
  }
  
  .product-video-slider__quick-add-wrapper .quick-add {
    position: relative;
    inset: auto;
    pointer-events: all;
  }
  
  .product-video-slider__quick-add-wrapper .quick-add__button--add {
    display: none !important;
  }
  
  .product-video-slider__quick-add-wrapper .quick-add__button--choose {
    position: relative;
    right: auto;
    bottom: auto;
    width: 20.99px;
    height: 20.99px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    border-radius: 50%;
    border: 1px solid #1D425A;
    background: transparent;
    min-width: 20.99px;
  }
  
  .product-video-slider__quick-add-wrapper .quick-add__button--choose:hover {
    opacity: 0.8;
  }
  
  .product-video-slider__plus-text {
    font-family: 'Geologica', sans-serif;
    font-style: normal;
    font-weight: 100;
    font-size: 19.5279px;
    line-height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #1D425A;
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    position: relative;
    top: -1px;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__quick-add-wrapper .quick-add__button--choose {
      width: 31.61px;
      height: 31.61px;
      border: 0.735105px solid #7295BB;
      min-width: 31.61px;
    }
    
    .product-video-slider__plus-text {
      font-size: 29.4042px;
      line-height: 37px;
      color: #7295BB;
      top: -2px;
    }
  }

  .product-video-slider__video-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 204 / 321;
    overflow: hidden;
    border-radius: 4px;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__video-wrapper {
      aspect-ratio: 281 / 442;
    }
  }

  .product-video-slider__video {
    width: 100%;
    height: 100%;
  }

  .product-video-slider__video-wrapper deferred-media {
    width: 100%;
    height: 100%;
    display: block;
  }

  .product-video-slider__video-wrapper deferred-media video,
  .product-video-slider__video-wrapper deferred-media iframe {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Custom play icon for product video slider */
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-play svg {
    display: none !important;
  }
  
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-play {
    width: 49px !important;
    height: 49px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-play::after {
    content: '';
    display: block;
    width: 49px;
    height: 49px;
    background-image: url("data:image/svg+xml,%3Csvg width='49' height='49' viewBox='0 0 49 49' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-2.28349' y='-2.28349' width='53.0909' height='53.0909'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.14px);clip-path:url(%23bgblur_0_860_8379_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='2.28349' cx='24.2621' cy='24.2621' r='24.2621' fill='%23222222' fill-opacity='0.36'/%3E%3Cpath d='M19 15L19 33L31 24L19 15Z' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_8379_clip_path' transform='translate(2.28349 2.28349)'%3E%3Ccircle cx='24.2621' cy='24.2621' r='24.2621'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  /* Custom pause icon for product video slider */
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-pause svg {
    display: none !important;
  }
  
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-pause {
    width: 49px !important;
    height: 49px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  
  .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-pause::after {
    content: '';
    display: block;
    width: 49px;
    height: 49px;
    background-image: url("data:image/svg+xml,%3Csvg width='49' height='49' viewBox='0 0 49 49' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-2.28349' y='-2.28349' width='53.0909' height='53.0909'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.14px);clip-path:url(%23bgblur_0_860_8379_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='2.28349' cx='24.2621' cy='24.2621' r='24.2621' fill='%23222222' fill-opacity='0.36'/%3E%3Crect x='18' y='14' width='4' height='20' fill='white'/%3E%3Crect x='27' y='14' width='4' height='20' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_8379_clip_path' transform='translate(2.28349 2.28349)'%3E%3Ccircle cx='24.2621' cy='24.2621' r='24.2621'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  @media screen and (min-width: 750px) {
    .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-play {
      width: 70px !important;
      height: 70px !important;
    }
    
    .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-play::after {
      width: 70px;
      height: 70px;
      background-image: url("data:image/svg+xml,%3Csvg width='70' height='70' viewBox='0 0 70 70' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-3.2696' y='-3.2696' width='76.0182' height='76.0182'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.63px);clip-path:url(%23bgblur_0_860_7705_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='3.2696' cx='34.7395' cy='34.7395' r='34.7395' fill='%23222222' fill-opacity='0.36'/%3E%3Cpath d='M27 21L27 48L43 34.5L27 21Z' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_7705_clip_path' transform='translate(3.2696 3.2696)'%3E%3Ccircle cx='34.7395' cy='34.7395' r='34.7395'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    }
    
    .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-pause {
      width: 70px !important;
      height: 70px !important;
    }
    
    .product-video-slider__video-wrapper .deferred-media__poster-icon.icon-pause::after {
      width: 70px;
      height: 70px;
      background-image: url("data:image/svg+xml,%3Csvg width='70' height='70' viewBox='0 0 70 70' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-3.2696' y='-3.2696' width='76.0182' height='76.0182'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.63px);clip-path:url(%23bgblur_0_860_7705_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='3.2696' cx='34.7395' cy='34.7395' r='34.7395' fill='%23222222' fill-opacity='0.36'/%3E%3Crect x='25' y='20' width='6' height='30' fill='white'/%3E%3Crect x='39' y='20' width='6' height='30' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_7705_clip_path' transform='translate(3.2696 3.2696)'%3E%3Ccircle cx='34.7395' cy='34.7395' r='34.7395'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    }
  }

  .product-video-slider__carousel-wrapper {
    width: 100%;
    position: relative;
  }

  /* Use resource-list__carousel base styles, just override what's needed */
  .product-video-slider__carousel.resource-list__carousel {
    width: 100%;
  }
  
  /* Ensure arrows are visible and properly positioned */
  .product-video-slider__carousel slideshow-arrows {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
  
  /* Override base CSS that hides disabled controls - show them but make them semi-transparent */
  .product-video-slider__carousel .slideshow-control {
    display: flex !important;
  }
  
  .product-video-slider__carousel .slideshow-control[disabled] {
    display: flex !important;
    opacity: 0.3;
    pointer-events: none;
  }
  
  .product-video-slider__carousel .slideshow-control:not([disabled]) {
    opacity: 1;
    pointer-events: auto;
  }
  
  /* Let resource-list__carousel base styles handle all slide sizing via container queries */
  /* Just ensure content visibility for our custom slides */
  .product-video-slider__carousel .product-video-slider__slide {
    content-visibility: visible !important;
  }
  
  .product-video-slider__carousel slideshow-slide[aria-hidden='true'],
  .product-video-slider__carousel slideshow-slide[aria-hidden='false'] {
    content-visibility: visible !important;
    opacity: 1 !important;
    display: block !important;
  }
  
  /* Make the center slide larger - dynamically applied via JavaScript */
  @container resource-list-carousel (min-width: 750px) {
    .product-video-slider__carousel slideshow-slide.product-video-slider__center-slide {
      --section-slide-width: calc(
        ((100% - (var(--resource-list-column-gap) * (var(--column-count) - 1)) - var(--peek-next-slide-size, 0px)) / var(--column-count)) * 1.15
      );
      --slide-width: var(--section-slide-width) !important;
    }
  }
  
  /* Apply the width explicitly for center slide on desktop */
  @media screen and (min-width: 750px) {
    .product-video-slider__carousel.resource-list__carousel slideshow-slide.product-video-slider__center-slide {
      width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.15
      ) !important;
      min-width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.15
      ) !important;
      max-width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.15
      ) !important;
      flex-shrink: 0 !important;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
  }
  
  /* For mobile, make the center item larger */
  @container resource-list-carousel (max-width: 749px) {
    .product-video-slider__carousel slideshow-slide.product-video-slider__center-slide {
      --slide-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.15) !important;
    }
  }
  
  @media screen and (max-width: 749px) {
    .product-video-slider__carousel.resource-list__carousel slideshow-slide.product-video-slider__center-slide {
      width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.15) !important;
      min-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.15) !important;
      max-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.15) !important;
      flex-shrink: 0 !important;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
  }


  .product-video-slider__placeholder {
    text-align: center;
    padding: 40px 20px;
  }
  
{% endstylesheet %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.product-video-slider__carousel');
    if (!carousel) return;
    
    const slidesContainer = carousel.querySelector('slideshow-slides');
    if (!slidesContainer) return;
    
    const slides = Array.from(carousel.querySelectorAll('slideshow-slide'));
    if (slides.length === 0) return;
    
    let currentCenterSlide = null;
    let isUpdating = false;
    let rafId = null;
    
    function updateCenterSlide() {
      if (isUpdating) return;
      isUpdating = true;
      
      // Use requestAnimationFrame for smooth updates
      if (rafId) {
        cancelAnimationFrame(rafId);
      }
      
      rafId = requestAnimationFrame(function() {
        // Get container dimensions
        const containerRect = slidesContainer.getBoundingClientRect();
        const containerCenter = containerRect.left + containerRect.width / 2;
        
        // Find the slide closest to the center
        let centerSlide = null;
        let minDistance = Infinity;
        
        slides.forEach(slide => {
          const slideRect = slide.getBoundingClientRect();
          const slideCenter = slideRect.left + slideRect.width / 2;
          const distance = Math.abs(containerCenter - slideCenter);
          
          // Only consider slides that are at least partially visible
          if (slideRect.right > containerRect.left && slideRect.left < containerRect.right) {
            if (distance < minDistance) {
              minDistance = distance;
              centerSlide = slide;
            }
          }
        });
        
        // Only update if the center slide actually changed
        if (centerSlide && centerSlide !== currentCenterSlide) {
          // Remove center class from previous slide
          if (currentCenterSlide) {
            currentCenterSlide.classList.remove('product-video-slider__center-slide');
          }
          
          // Add center class to new slide
          centerSlide.classList.add('product-video-slider__center-slide');
          currentCenterSlide = centerSlide;
        }
        
        isUpdating = false;
        rafId = null;
      });
    }
    
    // Initial update with delay to ensure DOM is ready
    setTimeout(function() {
      updateCenterSlide();
    }, 200);
    
    // Update on scroll with debouncing
    let scrollTimeout;
    let lastScrollTime = 0;
    slidesContainer.addEventListener('scroll', function() {
      const now = Date.now();
      // Throttle to max once per 100ms
      if (now - lastScrollTime < 100) {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateCenterSlide, 150);
        return;
      }
      lastScrollTime = now;
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateCenterSlide, 100);
    }, { passive: true });
    
    // Update on resize with debouncing
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(updateCenterSlide, 200);
    });
    
    // Update when slideshow component changes slide (for arrow navigation)
    const slideshowComponent = carousel.closest('slideshow-component');
    if (slideshowComponent) {
      // Listen for slide changes via MutationObserver (less frequent than scroll)
      const observer = new MutationObserver(function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateCenterSlide, 150);
      });
      
      observer.observe(slidesContainer, {
        attributes: true,
        attributeFilter: ['aria-hidden'],
        childList: false,
        subtree: true
      });
    }
  });
</script>

{% schema %}
{
  "name": "Product Video Slider",
  "tag": "section",
  "class": "section-wrapper",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "blocks": [
    {
      "type": "video_item",
      "name": "Video Item",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image (fallback if no video)"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Associated Product"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Watch Our Products"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Products per row (Desktop)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Products per row (Mobile)",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "1"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between products",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": true
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow style",
      "default": "arrow",
      "options": [
        {
          "value": "arrow",
          "label": "Arrows"
        },
        {
          "value": "chevron",
          "label": "Chevrons"
        },
        {
          "value": "none",
          "label": "None"
        }
      ]
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow background",
      "default": "none",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ]
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "default": "page-width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ]
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Product Video Slider",
      "category": "Products"
    }
  ]
}
{% endschema %}

