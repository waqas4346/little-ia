

{% comment %}
  This section is only to be called by the Section Rendering API. Faster to render a single card than the entire product grid.

  HTML updated based on client-side interactions needs to be rendered here.  It is not important to have the exact
  same HTML structure as the final rendered product card. The variant-picker.js script will morph specific elements as needed.
{% endcomment %}

{% liquid
  if product == blank
    assign product = closest.product
  endif

  if settings.transition_to_main_product
    assign featured_media_url = product.selected_or_first_available_variant.featured_image | image_url: width: 500
    if featured_media_url == blank
      assign featured_media_url = product.featured_media.preview_image | image_url: width: 500
    endif
  endif

  assign url = product.selected_or_first_available_variant.url
  unless url
    assign url = product.first_available_variant.url
  endunless
  unless url
    assign url = product.url
  endunless

  assign sku = product.selected_or_first_available_variant.sku
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
  >
{%- endif -%}

<product-card
  class="product-card"
  data-product-id="{{ product.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
>
  <a
    href="{{ url }}"
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
    "
    style="
      --product-card-gap: 4px;
    "
  >
    <variant-picker>
      <script type="application/json">
        {{ product.selected_or_first_available_variant | json }}
      </script>
    </variant-picker>
    
    {% comment %} Embed product JSON data for quick-add functionality - eliminates need for separate fetch {% endcomment %}
    <script type="application/json" data-product-json>
      {
        "id": {{ product.id | json }},
        "title": {{ product.title | json }},
        "handle": {{ product.handle | json }},
        "url": {{ product.url | json }},
        "available": {{ product.available | json }},
        "variants": [
          {% for variant in product.variants %}
            {
              "id": {{ variant.id | json }},
              "title": {{ variant.title | json }},
              "available": {{ variant.available | json }},
              "url": {{ variant.url | json }},
              "quantity_rule": {
                "min": {{ variant.quantity_rule.min | default: 1 | json }}
              }
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ],
        "options": [
          {% for option in product.options_with_values %}
            {
              "name": {{ option.name | json }},
              "values": {{ option.values | json }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }
    </script>
    
    {% comment %} Product Card Gallery - Match card-gallery snippet structure for proper hover and slider functionality {% endcomment %}
    {% if product.featured_media %}
      {% liquid
        assign image_sizes = '(min-width: 750px) 50vw, 100vw'
        
        # Check if there are generic media that are not variant images
        assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src'
        assign generic_media_size = product.media.size | minus: variant_images.size
        
        # Sort media so product.featured_media.preview_image comes first
        assign other_media = product.media | reject: 'src', product.featured_media
        assign media_list_to_show = product.featured_media | concat: other_media
        
        # Determine if we should show arrows
        assign show_arrows = false
        if product.media.size > 2 and generic_media_size > 0
          assign show_arrows = true
        endif
        
        # Determine max visible slides based on settings
        assign max_visible_slide_count = 1
        if settings.product_card_carousel
          assign max_visible_slide_count = 5
        elsif settings.show_second_image_on_hover
          assign max_visible_slide_count = 2
        endif
        
        # Build slideshow attributes
        assign slideshow_attributes = 'data-generic-media-size="' | append: generic_media_size | append: '"'
        if settings.product_card_carousel == false
          assign slideshow_attributes = slideshow_attributes | append: ' disabled="true"'
        endif
        
        # Build slides
        capture slides
          for media in media_list_to_show
            assign loading = 'lazy'
            assign sizes = 'auto, ' | append: image_sizes
            
            assign hidden = false
            assign attributes = ''
            if variant_images contains media.src
              assign attributes = 'variant-image'
              if forloop.first == false
                assign hidden = true
              endif
            endif
            
            # Count visible slides
            if forloop.first
              assign visible_slide_count = 0
            endif
            unless hidden
              assign visible_slide_count = visible_slide_count | plus: 1
            endunless
            if hidden == false and visible_slide_count > max_visible_slide_count
              continue
            endif
            
            # Load first visible image eagerly
            if forloop.first and hidden == false
              assign loading = 'eager'
              assign sizes = image_sizes
            endif
            
            assign class = 'product-media-container media-fit product-media-container--' | append: media.media_type
            
            capture slideshow_children
              render 'product-media', media: media, sizes: sizes, loading: loading, preview_image_only: true
            endcapture
            
            render 'slideshow-slide', slide_id: media.id, index: forloop.index0, hidden: hidden, class: class, attributes: attributes, children: slideshow_children
          endfor
        endcapture
        
        # Build product URL for card gallery link
        assign product_url = product.selected_or_first_available_variant.url
        unless product_url
          assign product_url = product.first_available_variant.url
        endunless
        unless product_url
          assign product_url = product.url
        endunless
      %}
      
      <div
        ref="cardGallery"
        class="card-gallery card-gallery-{{ section.id }}-{{ product.id }} spacing-style border-style"
        data-product-id="{{ product.id }}"
        {% if settings.show_second_image_on_hover %}
          on:pointerenter="/previewImage"
          on:pointerleave="/resetImage"
        {% endif %}
        {% if settings.transition_to_main_product %}
          data-view-transition-to-main-product
        {% endif %}
        data-image-ratio="adapt"
      >
        <a
          class="contents"
          ref="cardGalleryLink"
          href="{{ product_url }}"
          aria-label="{{ product.title }}"
        >
          {% render 'slideshow',
            ref: 'slideshow',
            initial_slide: 0,
            slides: slides,
            slide_count: media_list_to_show.size,
            show_arrows: show_arrows,
            attributes: slideshow_attributes
          %}
          {%- comment -%} Mobile scrollbar indicator {%- endcomment -%}
          <div class="product-card-scrollbar-indicator">
            <div class="product-card-scrollbar-track">
              <div class="product-card-scrollbar-thumb"></div>
            </div>
          </div>
        </a>
        
        {% render 'product-card-badges', product: product, settings: settings %}
        {% if settings.quick_add or settings.mobile_quick_add %}
          {% render 'quick-add', product: product, section_id: section.id %}
        {% endif %}
      </div>
    {% else %}
      <div class="card-gallery">
        <div class="product-card__placeholder-image">
          {{ 'product-1' | placeholder_svg_tag }}
        </div>
      </div>
    {% endif %}
    
    {% comment %} Product Title - match product-title block structure {% endcomment %}
    {% assign product_title = '<p>' | append: product.title | append: '</p>' %}
    <a
      class="contents user-select-text"
      ref="productTitleLink"
      href="{{ url }}"
    >
      {% render 'text', fallback_text: product_title, class: 'product-title-text' %}
    </a>

    <product-price>
      {% render 'price', product_resource: product, show_unit_price: true, show_sale_price_first: true %}
    </product-price>

    {% comment %} Add product-card-actions (View Product and + buttons) like product-slider {% endcomment %}
    {% render 'product-card-actions', 
      product: product, 
      section_id: section.id
    %}
  </div>
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}

{% schema %}
{
  "name": "t:names.product_card_rendering",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "t:settings.product"
    }
  ]
}
{% endschema %}
