{% liquid
  assign section_heading = section.settings.heading | default: 'Build Your Set'
  assign section_subheading = section.settings.subheading | default: 'Select a theme'
  assign select_product_text = section.settings.select_product_text | default: 'Select a product'
  assign collection_count = 0
  if section.settings.collection_list != blank
    for collection in section.settings.collection_list
      assign collection_count = collection_count | plus: 1
    endfor
  endif
  assign is_single_collection = false
  if collection_count == 1
    assign is_single_collection = true
  endif
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  data-testid="build-your-set"
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
    gap-style
    build-your-set-section
  "
  style=" 
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
>
  <div class="build-your-set-header">
    {% if section_heading != blank %}
      <div class="build-your-set-top-label">
        <span class="build-your-set-top-label-text">{{ section_heading }}</span>
      </div>
    {% endif %}
    
    {% unless is_single_collection %}
      {% if section_subheading != blank %}
        <div class="build-your-set-section-title">
          <span class="build-your-set-section-title-label">{{ section_subheading }}</span>
        </div>
      {% endif %}
    {% endunless %}
  </div>

    {% comment %} Collection slider {% endcomment %}
    {% if section.settings.collection_list != blank and collection_count > 1 %}
      <div class="build-your-set-collection-slider-wrapper">
        <button 
          type="button"
          class="build-your-set-collection-arrow build-your-set-collection-arrow--prev"
          aria-label="Previous collections"
          data-collection-arrow="prev"
        >
          <svg width="11" height="19" viewBox="0 0 11 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9.36328 2.31564L1.26025 9.83979L9.36328 17.364" stroke="#7295BB" stroke-width="2.31515" stroke-linecap="square" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="build-your-set-collection-slider" data-collection-slider>
          {% for collection in section.settings.collection_list %}
            {% liquid
              assign collection_name = collection.title | default: 'Collection'
            %}
            <button
              type="button"
              class="build-your-set-collection-item {% if forloop.first %}active{% endif %}"
              data-collection-id="{{ collection.id }}"
              data-collection-handle="{{ collection.handle }}"
              aria-label="{{ collection_name }}"
            >
              <div class="build-your-set-collection-image-wrapper">
                {% if collection.featured_image != blank %}
                  {{
                    collection.featured_image
                    | image_url: width: 400
                    | image_tag:
                      loading: 'lazy',
                      class: 'build-your-set-collection-image',
                      alt: collection.featured_image.alt | default: collection_name,
                      width: 200,
                      height: 200
                  }}
                {% else %}
                  <div class="build-your-set-collection-image-placeholder">
                    {{ 'collection-1' | placeholder_svg_tag: 'placeholder' }}
                  </div>
                {% endif %}
              </div>
              <div class="build-your-set-collection-label">{{ collection_name }}</div>
            </button>
          {% endfor %}
        </div>
        <button 
          type="button"
          class="build-your-set-collection-arrow build-your-set-collection-arrow--next"
          aria-label="Next collections"
          data-collection-arrow="next"
        >
          <svg width="11" height="19" viewBox="0 0 11 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1.63672 16.6844L9.73975 9.16021L1.63672 1.63596" stroke="#7295BB" stroke-width="2.31515" stroke-linecap="square" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    {% endif %}

    {% comment %} Select a product text {% endcomment %}
    {% unless is_single_collection %}
      {% if select_product_text != blank %}
        <div class="build-your-set-select-product-text">
          <span class="build-your-set-select-product-text-label">{{ select_product_text }}</span>
        </div>
      {% endif %}
    {% endunless %}

    {% comment %} Product grids for each collection {% endcomment %}
    {% if section.settings.collection_list != blank and collection_count > 0 %}
      <div class="build-your-set-products-wrapper" data-products-wrapper data-show-view-product-button="{{ section.settings.show_view_product_button }}">
      {% for collection in section.settings.collection_list %}
        {% liquid
          assign is_first = forloop.first
        %}
        {% if collection != blank and collection.products_count > 0 %}
          {% paginate collection.products by 16 %}
            <div
              class="build-your-set-product-grid-wrapper {% unless is_first %}hidden{% endunless %}"
              data-collection-id="{{ collection.id }}"
              data-collection-handle="{{ collection.handle }}"
              {% unless is_first %}style="display: none;"{% endunless %}
            >
              {% capture list_items %}
                {% for product in collection.products %}
                  <li class="product-grid__item" data-product-id="{{ product.id }}" data-product-handle="{{ product.handle }}" data-collection-handle="{{ collection.handle }}" data-page="{{ paginate.current_page }}">
                    {% # theme-check-disable UniqueStaticBlockId %}
                      {% content_for 'block', type: '_product-card', id: 'product-card', closest.product: product %}
                    {% # theme-check-enable UniqueStaticBlockId %}
                  </li>
                {% endfor %}
              {% endcapture %}

              <ul
                class="product-grid product-grid--{{ section.id }} product-grid--{{ section.settings.layout_type }}"
                data-testid="build-your-set-product-grid"
                product-grid-view="default"
                role="list"
                data-product-card-size="{{ section.settings.product_card_size }}"
                style="--mobile-columns: {% if section.settings.mobile_product_card_size == 'large' %}1{% else %}2{% endif %};"
              >
                {{ list_items }}
              </ul>
              
              {% comment %} Pagination controls {% endcomment %}
              {% if paginate.pages > 1 %}
                <div class="build-your-set-pagination-wrapper" data-pagination-wrapper data-collection-handle="{{ collection.handle }}">
                  {% render 'pagination-controls', paginate: paginate %}
                </div>
              {% endif %}
            </div>
          {% endpaginate %}
        {% endif %}
      {% endfor %}
      </div>
    {% endif %}
  
  {% comment %} Build Your Set Sticky Bar {% endcomment %}
      {% render 'build-your-set-sticky-bar' %}
      {% render 'build-your-set-personalisation-modal' %}
</div>

{% style %}
  .build-your-set-header {
    text-align: center;
    margin-bottom: 16px;
  }

  .build-your-set-top-label {
    text-align: center;
    margin-bottom: 0;
  }

  .build-your-set-top-label-text {
    margin: 0;
    font-family: 'Sacramento', cursive, sans-serif;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    color: #7295BB;
    text-align: center;
    text-transform: lowercase;
    display: block;
  }

  .build-your-set-section-title {
    text-align: center;
    margin-bottom: 0;
  }

  .build-your-set-section-title-label {
    margin: 0;
    font-family: 'FuturaPT-Demi', 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 28px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  .build-your-set-collection-slider-wrapper {
    margin: 32px 0;
    position: relative;
    display: flex;
    align-items: center;
    gap: 16px;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }

  .build-your-set-collection-slider {
    display: flex;
    gap: 18px 24px;
    padding: 0 16px;
    justify-content: center;
    align-items: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
    flex: 1;
    width: 100%;
    max-width: 100%;
    min-width: 0;
  }

  .build-your-set-collection-slider--has-overflow {
    justify-content: flex-start;
  }

  .build-your-set-collection-slider::-webkit-scrollbar {
    display: none;
  }

  .build-your-set-collection-arrow {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    min-width: 44px;
    min-height: 44px;
    z-index: 2;
  }

  .build-your-set-collection-arrow:hover {
    opacity: 0.7;
  }

  .build-your-set-collection-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .build-your-set-collection-arrow--hidden {
    display: none !important;
  }

  .build-your-set-collection-arrow svg {
    width: 11px;
    height: 19px;
  }

  .build-your-set-collection-arrow--prev {
    order: 1;
  }

  .build-your-set-collection-slider {
    order: 2;
  }

  .build-your-set-collection-arrow--next {
    order: 3;
  }

  .build-your-set-collection-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: opacity 0.2s ease;
    min-width: 62px;
    flex-shrink: 0;
    flex-basis: auto;
    width: auto;
    max-width: 120px;
  }

  .build-your-set-collection-item:hover {
    opacity: 0.8;
  }

  .build-your-set-collection-image-wrapper {
    width: 62px;
    height: 62px;
    border-radius: 100000px;
    overflow: hidden;
    border: none;
    transition: border-color 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    position: relative;
    box-sizing: border-box;
    padding: 0;
  }

  .build-your-set-collection-item.active .build-your-set-collection-image-wrapper {
    border: 1px solid #1D425A;
    padding: 1px;
    box-sizing: border-box;
  }

  .build-your-set-collection-image,
  .build-your-set-collection-image-placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 100000px;
    box-sizing: border-box;
  }

  .build-your-set-collection-item.active .build-your-set-collection-image,
  .build-your-set-collection-item.active .build-your-set-collection-image-placeholder {
    width: calc(100% - 2px);
    height: calc(100% - 2px);
    margin: 1px;
  }

  .build-your-set-collection-image-placeholder {
    width: 62px;
    height: 62px;
  }

  .build-your-set-collection-image-placeholder svg {
    width: 100%;
    height: 100%;
  }

  .build-your-set-collection-label {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 140%;
    text-align: center;
    text-transform: uppercase;
    color: #787878;
    margin-top: 5px;
    pointer-events: none;
    transition: color 0.2s ease;
    white-space: normal;
    word-wrap: break-word;
    overflow: visible;
  }

  .build-your-set-collection-item.active .build-your-set-collection-label {
    color: #1D425A;
  }

  .build-your-set-select-product-text {
    text-align: center;
    margin: 32px 0 24px;
  }

  .build-your-set-select-product-text-label {
    margin: 0;
    font-family: 'FuturaPT-Demi', 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 28px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  .build-your-set-products-wrapper {
    width: 100%;
  }

  .build-your-set-product-grid-wrapper {
    width: 100%;
  }

  .build-your-set-product-grid-wrapper.hidden {
    display: none !important;
  }

  /* Product grid styles matching collection page */
  .build-your-set-product-grid-wrapper {
    width: 100%;
    container-type: inline-size;
    container-name: product-grid;
  }

  .build-your-set-product-grid-wrapper .product-grid {
    --product-grid-gap-mobile: {{ section.settings.columns_gap_vertical | at_most: 12 }}px {{ section.settings.columns_gap_horizontal | at_most: 12 }}px;
    --product-grid-gap-desktop: {{ section.settings.columns_gap_vertical }}px {{ section.settings.columns_gap_horizontal }}px;
    --product-grid-gap: var(--product-grid-gap-mobile);
    --mobile-columns: {% if section.settings.mobile_product_card_size == 'large' %}1{% else %}2{% endif %};
    isolation: isolate;
    display: grid;
    grid-template-columns: repeat(var(--mobile-columns), 1fr);
    gap: var(--product-grid-gap-mobile);
    margin: auto;
    padding: 0;
    list-style: none;
  }

  /* Desktop styles - matching base.css pattern */
  @media screen and (min-width: 750px) {
    .build-your-set-product-grid-wrapper .product-grid {
      --product-grid-gap: var(--product-grid-gap-desktop);
      gap: var(--product-grid-gap);
    }

    {% case section.settings.layout_type %}
      {% when 'grid' %}
        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--grid {
          /* Use responsive columns to prevent overflow */
          --product-grid-columns-desktop: repeat(4, minmax(0, 1fr));
          grid-template-columns: var(--product-grid-columns-desktop);
        }
      {% when 'organic' %}
        {% assign large_span = 2 %}
        {% assign row_cycle = 3 %}
        {% assign product_cycle = row_cycle | times: 2 %}
        {% assign right_large_start_col = 3 %}
        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-of-type({{ product_cycle }}n + 1) {
          grid-column: 1 / span {{ large_span }};
        }

        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-of-type({{ product_cycle }}n + 2),
        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-of-type({{ product_cycle }}n + 5) {
          align-self: end;
        }

        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-of-type({{ product_cycle }}n + {{ product_cycle }}) {
          grid-column: {{ right_large_start_col }} / span {{ large_span }};
        }

        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--organic {
          --product-grid-columns-desktop: repeat(4, 1fr);
          grid-template-columns: var(--product-grid-columns-desktop);
        }
    {% endcase %}
  }

  /* Small desktop/tablet: match collection behavior (3 columns, wrap instead of overflow) */
  @media screen and (min-width: 750px) and (max-width: 1023px) {
    {% case section.settings.layout_type %}
      {% when 'grid' %}
        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--grid {
          --product-grid-columns-desktop: repeat(3, minmax(0, 1fr));
          grid-template-columns: var(--product-grid-columns-desktop);
        }
    {% endcase %}
  }

  /* Tablet (iPad) - Show 3 columns default for grid layout */
  @media (min-width: 1024px) and (max-width: 1366px) {
    {% case section.settings.layout_type %}
      {% when 'grid' %}
        .build-your-set-product-grid-wrapper .product-grid--{{ section.id }}.product-grid--grid {
          --product-grid-columns-desktop: repeat(3, 1fr) !important;
          grid-template-columns: var(--product-grid-columns-desktop) !important;
        }
    {% endcase %}
  }

  /* Product card title styling matching collection page */
  .build-your-set-products-wrapper .product-card .product-title-text,
  .build-your-set-products-wrapper .product-card .product-title-text p,
  .build-your-set-products-wrapper .product-card .text-block.product-title-text,
  .build-your-set-products-wrapper .product-card .text-block.product-title-text p {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    line-height: 140%;
    color: #1D425A;
  }

  @media screen and (min-width: 750px) {
    .build-your-set-products-wrapper .product-card .product-title-text,
    .build-your-set-products-wrapper .product-card .product-title-text p,
    .build-your-set-products-wrapper .product-card .text-block.product-title-text,
    .build-your-set-products-wrapper .product-card .text-block.product-title-text p {
      font-size: 20px;
      line-height: 140%;
      color: #1D425A;
    }
  }

  @media screen and (max-width: 1023px) {
    .build-your-set-products-wrapper .product-card .product-title-text,
    .build-your-set-products-wrapper .product-card .product-title-text p,
    .build-your-set-products-wrapper .product-card .text-block.product-title-text,
    .build-your-set-products-wrapper .product-card .text-block.product-title-text p {
      font-size: 16px;
      line-height: 140%;
      color: #1D425A;
    }
  }

  /* When show_view_product_button is false: Show quick add on hover, hide product-card-actions */
  /* Set CSS variable to ensure quick add is displayed */
  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"] {
    --quick-add-display: flex !important;
    --quick-add-mobile-display: flex !important;
    --quick-add-mobile-opacity: 1 !important;
  }

  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"] .quick-add__button {
    display: flex !important;
  }

  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"]:is(:hover, :focus-within) .quick-add__button {
    opacity: 1 !important;
    pointer-events: all !important;
    visibility: visible !important;
    display: flex !important;
  }

  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"] .product-card-actions {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"]:is(:hover, :focus-within) .product-card-actions,
  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"]:is(:hover, :focus-within) .product-card-actions__view-product-button,
  .build-your-set-products-wrapper[data-show-view-product-button="false"] product-card[data-build-your-set="true"]:is(:hover, :focus-within) .product-card-actions__quick-add-wrapper {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
    visibility: hidden !important;
  }

  /* When show_view_product_button is true: Hide quick add, show product-card-actions (collection page behavior) */
  .build-your-set-products-wrapper[data-show-view-product-button="true"] product-card[data-build-your-set="true"]:is(:hover, :focus-within) .quick-add__button {
    opacity: 0 !important;
    pointer-events: none !important;
  }

  @media screen and (min-width: 750px) {
    .build-your-set-header {
      margin-bottom: 24px;
    }

    .build-your-set-top-label-text {
      font-size: 38px;
    }

    .build-your-set-collection-slider {
      padding: 0 24px;
      gap: 18px 24px;
    }

    .build-your-set-collection-image-wrapper {
      width: 62px;
      height: 62px;
    }

    .build-your-set-collection-image-placeholder {
      width: 62px;
      height: 62px;
    }

    .build-your-set-collection-item {
      width: auto;
      min-width: 62px;
      max-width: 120px;
    }

    .build-your-set-collection-label {
      font-size: 14px;
    }
  }

  @media (max-width: 767px) {
    .build-your-set-header {
      margin-bottom: 16px;
    }

    .build-your-set-collection-slider-wrapper {
      margin: 24px 0;
    }

    .build-your-set-collection-slider {
      padding: 0 16px;
      gap: 18px;
      justify-content: flex-start;
    }

    .build-your-set-collection-image-wrapper {
      width: 62px;
      height: 62px;
    }

    .build-your-set-collection-image-placeholder {
      width: 62px;
      height: 62px;
    }

    .build-your-set-collection-item {
      width: auto;
      min-width: 62px;
      max-width: 120px;
    }

    .build-your-set-collection-label {
      font-size: 14px;
    }

    .build-your-set-select-product-text {
      margin: 24px 0 16px;
    }

    .build-your-set-select-product-text-label {
      font-size: 20px;
    }

    /* Hide arrows on mobile - allow touch scrolling */
    .build-your-set-collection-arrow {
      display: none !important;
    }
  }
{% endstyle %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Clear build-your-set session cart on page reload
    const storageKey = 'build-your-set-session-cart';
    try {
      sessionStorage.removeItem(storageKey);
      // Dispatch event to notify sticky bar that session was cleared
      document.dispatchEvent(new CustomEvent('build-your-set-cleared', {
        bubbles: true,
        cancelable: true
      }));
    } catch (error) {
      console.warn('Build Your Set: Error clearing session storage on page load', error);
    }
    
    const section = document.querySelector('[data-testid="build-your-set"]');
    if (!section) return;

    const collectionSlider = section.querySelector('[data-collection-slider]');
    const collectionItems = section.querySelectorAll('.build-your-set-collection-item');
    const productsWrapper = section.querySelector('[data-products-wrapper]');
    const productGridWrappers = section.querySelectorAll('.build-your-set-product-grid-wrapper');
    const prevArrow = section.querySelector('[data-collection-arrow="prev"]');
    const nextArrow = section.querySelector('[data-collection-arrow="next"]');
    
    if (!productsWrapper) return;

    // Setup collection slider scroll functionality (only if collection slider exists)
    if (prevArrow && nextArrow && collectionSlider) {
      setupCollectionSlider(collectionSlider, prevArrow, nextArrow);
    }

    // Initialize product cards - set data attributes
    function initializeProductCards(wrapper) {
      if (!wrapper) return;
      
      const productsWrapper = section.querySelector('[data-products-wrapper]');
      const showViewProductButton = productsWrapper?.dataset.showViewProductButton === 'true';
      
      const productCards = wrapper.querySelectorAll('product-card, product-card-link');
      productCards.forEach(function(card) {
        card.setAttribute('data-build-your-set', 'true');
        card.removeAttribute('data-collection-page');
        
        if (showViewProductButton) {
          card.setAttribute('data-view-product-button-setting', 'true');
        } else {
          card.removeAttribute('data-view-product-button-setting');
        }
      });
      
      // Trigger product grid update event
      window.dispatchEvent(new CustomEvent('product-grid:updated'));
    }
    
    // Initialize first collection's product cards
    if (productGridWrappers.length > 0) {
      const firstWrapper = productGridWrappers[0];
      if (!firstWrapper.classList.contains('hidden')) {
        initializeProductCards(firstWrapper);
      }
    }

    // Handle pagination clicks for Build Your Set
    async function handleBuildYourSetPagination(pageNumber, collectionHandle) {
      const activeWrapper = section.querySelector('.build-your-set-product-grid-wrapper:not(.hidden)');
      if (!activeWrapper) return;
      
      if (!collectionHandle) {
        collectionHandle = activeWrapper.dataset.collectionHandle;
      }
      if (!collectionHandle) return;
      
      // Get the section ID (normalize it by removing the prefix if present)
      const sectionElement = section.closest('.shopify-section');
      if (!sectionElement) {
        console.error('Build Your Set section element not found');
        return;
      }
      
      let sectionId = sectionElement.id;
      // Remove 'shopify-section-' prefix if present
      if (sectionId.startsWith('shopify-section-')) {
        sectionId = sectionId.replace('shopify-section-', '');
      }
      
      // Build URL with page parameter for section rendering API
      const url = new URL(window.location.href);
      url.pathname = `/collections/${collectionHandle}`;
      if (pageNumber && pageNumber !== '1') {
        url.searchParams.set('page', pageNumber);
      } else {
        url.searchParams.delete('page');
      }
      // Add section_id parameter for section rendering API
      url.searchParams.set('section_id', sectionId);
      url.searchParams.sort();
      
      try {
        // Fetch section HTML using Shopify's section rendering API
        const response = await fetch(url.toString());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const sectionHTML = await response.text();
        
        // Parse the fetched section HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(sectionHTML, 'text/html');
        
        const fetchedSection = doc.querySelector('[data-testid="build-your-set"]');
        if (!fetchedSection) {
          console.error('Build Your Set section not found in response');
          return;
        }
        
        const fetchedWrapper = Array.from(fetchedSection.querySelectorAll('.build-your-set-product-grid-wrapper')).find(function(w) {
          return w.dataset.collectionHandle === collectionHandle;
        });
        
        if (!fetchedWrapper) {
          console.error('Collection wrapper not found in response');
          return;
        }
        
        const fetchedProductGrid = fetchedWrapper.querySelector('.product-grid');
        const fetchedPagination = fetchedWrapper.querySelector('.build-your-set-pagination-wrapper');
        
        if (!fetchedProductGrid) {
          console.error('Product grid not found in response');
          return;
        }
        
        // Update the product grid
        const currentProductGrid = activeWrapper.querySelector('.product-grid');
        if (currentProductGrid) {
          currentProductGrid.innerHTML = fetchedProductGrid.innerHTML;
        }
        
        // Update pagination
        const currentPaginationWrapper = activeWrapper.querySelector('.build-your-set-pagination-wrapper');
        if (fetchedPagination) {
          if (currentPaginationWrapper) {
            currentPaginationWrapper.innerHTML = fetchedPagination.innerHTML;
          } else {
            activeWrapper.insertAdjacentHTML('beforeend', fetchedPagination.outerHTML);
          }
        } else if (currentPaginationWrapper) {
          currentPaginationWrapper.remove();
        }
        
        // Re-initialize product cards and pagination listeners
        initializeProductCards(activeWrapper);
        
        // Setup pagination listeners after a short delay to ensure DOM is ready
        setTimeout(function() {
          setupPaginationClickListeners();
        }, 50);
        
        // Scroll to top of section
        activeWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (error) {
        console.error('Error loading paginated products:', error);
      }
    }
    
    function setupPaginationClickListeners() {
      const paginationLinks = section.querySelectorAll('.build-your-set-pagination-wrapper a.pagination__link');
      paginationLinks.forEach(function(link) {
        // Skip if listener already attached
        if (link.dataset.buildYourSetListener === 'true') return;
        link.dataset.buildYourSetListener = 'true';
        
        link.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const href = link.getAttribute('href');
          if (!href) return;
          
          // Create URL object, handling both absolute and relative URLs
          const url = href.startsWith('http') 
            ? new URL(href) 
            : new URL(href, window.location.origin);
          
          const page = url.searchParams.get('page') || '1';
          
          const activeWrapper = section.querySelector('.build-your-set-product-grid-wrapper:not(.hidden)');
          const collectionHandle = activeWrapper?.dataset.collectionHandle;
          
          if (collectionHandle) {
            handleBuildYourSetPagination(page, collectionHandle);
          }
        });
      });
    }
    
    // Setup initial pagination listeners
    setTimeout(setupPaginationClickListeners, 100);

    // Handle collection item clicks (only if there are multiple collections)
    if (collectionItems.length > 1) {
      collectionItems.forEach(function(item) {
      item.addEventListener('click', function() {
        // Remove active class from all items
        collectionItems.forEach(function(ci) {
          ci.classList.remove('active');
        });

        // Add active class to clicked item
        item.classList.add('active');

        // Get collection handle and id
        const handle = item.dataset.collectionHandle;
        const collectionId = item.dataset.collectionId;

        // Hide all product grids
        productGridWrappers.forEach(function(wrapper) {
          wrapper.classList.add('hidden');
          wrapper.style.display = 'none';
        });

        // Show selected collection's product grid
        const selectedWrapper = Array.from(productGridWrappers).find(function(wrapper) {
          return wrapper.dataset.collectionHandle === handle ||
                 wrapper.dataset.collectionId === collectionId;
        });

        if (selectedWrapper) {
          selectedWrapper.classList.remove('hidden');
          selectedWrapper.style.display = 'block';
          
          // Initialize product cards attributes
          initializeProductCards(selectedWrapper);
        }
      });
    });
    }

    // Function to setup collection slider with arrows
    function setupCollectionSlider(slider, prevBtn, nextBtn) {
      if (!slider || !prevBtn || !nextBtn) return;
      
      // Calculate scroll amount based on item width + gap
      function getScrollAmount() {
        const firstItem = slider.querySelector('.build-your-set-collection-item');
        if (!firstItem) return 80;
        const itemWidth = firstItem.offsetWidth;
        const gap = 24; // Match CSS gap (horizontal)
        return itemWidth + gap;
      }

      const scrollAmount = getScrollAmount();
      
      // Update arrow visibility based on scroll position
      function updateArrows() {
        if (!slider || !prevBtn || !nextBtn) return;
        
        const scrollLeft = slider.scrollLeft;
        const scrollWidth = slider.scrollWidth;
        const clientWidth = slider.clientWidth;
        
        // Check if there's overflow (need to scroll)
        const hasOverflow = scrollWidth > clientWidth + 1; // Small threshold for rounding
        
        if (!hasOverflow) {
          // No overflow - hide both arrows and center the slider
          prevBtn.classList.add('build-your-set-collection-arrow--hidden');
          nextBtn.classList.add('build-your-set-collection-arrow--hidden');
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          slider.classList.remove('build-your-set-collection-slider--has-overflow');
          return;
        }
        
        // Has overflow - show arrows and align left
        prevBtn.classList.remove('build-your-set-collection-arrow--hidden');
        nextBtn.classList.remove('build-your-set-collection-arrow--hidden');
        slider.classList.add('build-your-set-collection-slider--has-overflow');
        
        const isAtStart = scrollLeft <= 5; // Small threshold for rounding
        const isAtEnd = scrollLeft >= scrollWidth - clientWidth - 5;
        
        prevBtn.disabled = isAtStart;
        nextBtn.disabled = isAtEnd;
        
        // Update opacity based on scroll position
        if (isAtStart) {
          prevBtn.classList.add('build-your-set-collection-arrow--hidden');
        } else {
          prevBtn.classList.remove('build-your-set-collection-arrow--hidden');
        }
        
        if (isAtEnd) {
          nextBtn.classList.add('build-your-set-collection-arrow--hidden');
        } else {
          nextBtn.classList.remove('build-your-set-collection-arrow--hidden');
        }
      }

      // Initial check - wait for layout and images to load
      function initialCheck() {
        requestAnimationFrame(function() {
          updateArrows();
          // Double check after a short delay to account for image loading
          setTimeout(function() {
            updateArrows();
          }, 100);
        });
      }
      
      initialCheck();

      // Previous button - scroll left
      prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (slider.scrollLeft <= 0) return;
        
        const amount = getScrollAmount();
        slider.scrollBy({
          left: -amount,
          behavior: 'smooth'
        });
      });

      // Next button - scroll right
      nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const maxScroll = slider.scrollWidth - slider.clientWidth;
        if (slider.scrollLeft >= maxScroll) return;
        
        const amount = getScrollAmount();
        slider.scrollBy({
          left: amount,
          behavior: 'smooth'
        });
      });

      // Update arrows on scroll
      slider.addEventListener('scroll', function() {
        requestAnimationFrame(updateArrows);
      });

      // Update arrows on resize
      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          updateArrows();
        }, 100);
      });

      // Update arrows after a delay to ensure accurate measurements
      setTimeout(updateArrows, 200);
      
      // Update arrows when images load (they might affect layout)
      const images = slider.querySelectorAll('.build-your-set-collection-image');
      images.forEach(function(img) {
        if (img.complete) {
          updateArrows();
        } else {
          img.addEventListener('load', function() {
            updateArrows();
          });
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Build Your Set",
  "class": "ui-test-build-your-set",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    },
    {
      "type": "_divider"
    },
    {
      "type": "_product-card"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "collection_list",
      "id": "collection_list",
      "label": "Collections",
      "limit": 10,
      "info": "Select collections to display in the Build Your Set section"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build Your Set"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Select a theme"
    },
    {
      "type": "text",
      "id": "select_product_text",
      "label": "Select Product Text",
      "default": "Select a product"
    },
    {
      "type": "header",
      "content": "Product Grid Settings"
    },
    {
      "type": "checkbox",
      "id": "show_view_product_button",
      "label": "Show View Product Button",
      "default": false,
      "info": "When enabled, shows the View Product button and + icon on hover (collection page behavior). When disabled, shows the quick add button on hover."
    },
    {
      "type": "select",
      "id": "layout_type",
      "label": "Layout Type",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "organic",
          "label": "Organic"
        }
      ],
      "default": "grid"
    },
    {
      "type": "select",
      "id": "product_card_size",
      "label": "Product Card Size",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        },
        {
          "value": "extra-large",
          "label": "Extra Large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "mobile_product_card_size",
      "label": "Mobile Product Card Size",
      "options": [
        {
          "value": "small",
          "label": "Small (2 columns)"
        },
        {
          "value": "large",
          "label": "Large (1 column)"
        }
      ],
      "default": "small"
    },
    {
      "type": "range",
      "id": "columns_gap_horizontal",
      "label": "Horizontal Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "columns_gap_vertical",
      "label": "Vertical Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 32
    },
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page"
        },
        {
          "value": "full-width",
          "label": "Full"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Build Your Set",
      "category": "Products",
      "settings": {
        "heading": "Build Your Set",
        "subheading": "Select a theme",
        "select_product_text": "Select a product",
        "layout_type": "grid",
        "product_card_size": "medium",
        "mobile_product_card_size": "small",
        "columns_gap_horizontal": 12,
        "columns_gap_vertical": 32,
        "section_width": "page-width",
        "gap": 12,
        "color_scheme": "scheme-1",
        "padding-block-start": 48,
        "padding-block-end": 48
      },
          "blocks": {
            "product-card": {
              "type": "_product-card",
              "name": "Product Card",
              "static": true,
              "settings": {
                "product_card_gap": 4,
                "inherit_color_scheme": true,
                "color_scheme": "",
                "border": "none",
                "border_width": 1,
                "border_opacity": 100,
                "border_radius": 0,
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0,
                "show_view_product_button": false,
                "disable_product_link": true
              },
          "blocks": {
            "product-card-gallery": {
              "type": "_product-card-gallery",
              "name": "Product Card Media",
              "settings": {
                "image_ratio": "adapt",
                "border": "none",
                "border_width": 1,
                "border_opacity": 100,
                "border_radius": 0,
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "product_title": {
              "type": "product-title",
              "name": "Product Title",
              "settings": {
                "width": "fit-content",
                "max_width": "normal",
                "alignment": "left",
                "type_preset": "rte",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "wrap": "pretty",
                "color": "var(--color-foreground)",
                "background": false,
                "background_color": "#00000026",
                "corner_radius": 0,
                "padding-block-start": 4,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            },
            "price": {
              "type": "price",
              "name": "Product Price",
              "settings": {
                "show_sale_price_first": true,
                "show_installments": false,
                "show_tax_info": false,
                "type_preset": "h6",
                "width": "100%",
                "alignment": "left",
                "font": "var(--font-body--family)",
                "font_size": "1rem",
                "line_height": "normal",
                "letter_spacing": "normal",
                "case": "none",
                "color": "var(--color-foreground)",
                "padding-block-start": 0,
                "padding-block-end": 0,
                "padding-inline-start": 0,
                "padding-inline-end": 0
              }
            }
          },
          "block_order": ["product-card-gallery", "product_title", "price"]
        }
      },
      "block_order": []
    }
  ]
}
{% endschema %}
