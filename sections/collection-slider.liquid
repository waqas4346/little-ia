{% liquid
  assign items_per_view = section.settings.items_per_view | default: 4
  assign collection_list = section.settings.collection_list
  
  # If no collections specified, try to use all collections
  # Note: In Shopify, you typically need to specify collections via collection_list
  # But we'll try to handle the case where collections might be available
  if collection_list == blank or collection_list.count == 0
    # Try to use collections object if available
    assign all_collections = collections
    if all_collections == blank
      assign all_collections = null
      assign max_items = 0
    else
      assign max_items = all_collections.size
    endif
  else
    assign all_collections = collection_list
    assign max_items = collection_list.count
  endif
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  data-testid="collection-slider"
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
    gap-style
    collection-slider-section
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
>
  <div class="collection-slider-header">
    {% if section.settings.top_label != blank %}
      <div class="collection-slider-top-label">
        <span class="collection-slider-top-label-text">{{ section.settings.top_label }}</span>
      </div>
    {% endif %}
    
    {% if section.settings.section_title != blank %}
      <div class="collection-slider-section-title">
        <span class="collection-slider-section-title-label">{{ section.settings.section_title }}</span>
      </div>
    {% endif %}
  </div>

  {% capture list_items %}
    {% if all_collections != blank and max_items > 0 %}
      {% for collection in all_collections limit: max_items %}
        <div class="resource-list__item collection-slider-item">
          <div class="collection-slider-card">
            <a href="{{ collection.url }}" class="collection-slider-card__link">
              <div class="collection-slider-card__image-wrapper">
                {% if collection.featured_image %}
                  {{
                    collection.featured_image
                    | image_url: width: 800
                    | image_tag: loading: 'lazy', class: 'collection-slider-card__image', alt: collection.title
                  }}
                {% else %}
                  <div class="collection-slider-card__placeholder">
                    {{ collection.title | truncate: 60 }}
                  </div>
                {% endif %}
                <div class="collection-slider-card__title-overlay" style="--title-position: {{ section.settings.title_position }}; --title-margin-bottom: 24px;">
                  <span class="collection-slider-card__title">{{ collection.title }}</span>
                </div>
              </div>
            </a>
          </div>
        </div>
        {% unless forloop.last %}
          <!--@list/split-->
        {% endunless %}
      {% endfor %}
    {% endif %}
  {% endcapture %}

  {% liquid
    assign list_items_array = list_items | strip | split: '<!--@list/split-->'
    
    # Prepare carousel settings - no gutters to maximize width
    assign slideshow_gutters = null
    assign gutter_style = '--gutter-slide-width: 0px;'

    assign show_arrows = false
    if section.settings.icons_style != 'none'
      assign show_arrows = true
    endif

    # For mobile: group items into slides of 4 (2x2 grid)
    # For desktop: each item is a slide, showing 4 at once
    assign items_per_slide_mobile = 4
    assign total_slides_mobile = list_items_array.size | divided_by: items_per_slide_mobile
    assign remainder_mobile = list_items_array.size | modulo: items_per_slide_mobile
    if remainder_mobile > 0
      assign total_slides_mobile = total_slides_mobile | plus: 1
    endif
  %}

  {% capture slides %}
    {% comment %} Desktop: each item is a separate slide {% endcomment %}
    {% for item in list_items_array %}
      {% render 'slideshow-slide'
        index : forloop.index0,
        children : item,
        class : 'resource-list__slide collection-slider-slide collection-slider-slide-desktop'
      %}
    {% endfor %}
  {% endcapture %}

  {% capture slides_mobile %}
    {% comment %} Mobile: group items into slides of 4 {% endcomment %}
    {% assign slide_index = 0 %}
    {% for i in (0..total_slides_mobile) %}
      {% if forloop.index0 < total_slides_mobile %}
        {% capture mobile_slide_content %}
          <div class="collection-slider-mobile-grid">
            {% assign start_index = forloop.index0 | times: items_per_slide_mobile %}
            {% assign end_index = start_index | plus: items_per_slide_mobile | minus: 1 %}
            {% for j in (start_index..end_index) %}
              {% if j < list_items_array.size %}
                {{ list_items_array[j] }}
              {% endif %}
            {% endfor %}
          </div>
        {% endcapture %}
        {% render 'slideshow-slide'
          index : slide_index,
          children : mobile_slide_content,
          class : 'resource-list__slide collection-slider-slide collection-slider-slide-mobile'
        %}
        {% assign slide_index = slide_index | plus: 1 %}
      {% endif %}
    {% endfor %}
  {% endcapture %}

  {% comment %} Desktop carousel {% endcomment %}
  <div class="collection-slider-wrapper">
    <div
      class="resource-list resource-list__carousel collection-slider-carousel collection-slider-desktop"
      style="{{ gutter_style }} --column-count: {{ items_per_view }}; --resource-list-column-gap-desktop: {{ section.settings.columns_gap | default: 12 }}px; --peek-next-slide-size: 0px;"
      data-testid="collection-slider-grid"
      data-items-per-view="{{ items_per_view }}"
    >
      {% render 'slideshow',
        ref: 'collectionSliderDesktop',
        class: 'resource-list__carousel',
        slides: slides,
        show_arrows: show_arrows,
        icon_style: section.settings.icons_style,
        icon_shape: section.settings.icons_shape,
        auto_hide_controls: false,
        infinite: false,
        initial_slide: 0,
        slide_count: max_items,
        slideshow_gutters: slideshow_gutters,
        arrows_position: 'center'
      %}
    </div>
  </div>

  {% comment %} Mobile carousel {% endcomment %}
  <div
    class="resource-list__carousel collection-slider-carousel collection-slider-mobile hidden--desktop"
    style="--gutter-slide-width: 0px;"
    data-testid="collection-slider-grid-mobile"
  >
    {% render 'slideshow',
      ref: 'collectionSliderMobile',
      class: 'resource-list__carousel',
      slides: slides_mobile,
      show_arrows: false,
      icon_style: 'none',
      icon_shape: 'none',
      auto_hide_controls: false,
      infinite: false,
      initial_slide: 0,
      slide_count: total_slides_mobile,
      slideshow_gutters: ''
    %}
    <div class="collection-slider-scrollbar-indicator">
      <div class="collection-slider-scrollbar-track">
        <div class="collection-slider-scrollbar-thumb"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .collection-slider-header {
    text-align: center;
    margin-bottom: 16px;
  }

  @media screen and (min-width: 750px) {
    .collection-slider-header {
      margin-bottom: 24px;
    }
  }

  .collection-slider-top-label {
    text-align: center;
    margin-bottom: 0;
  }

  .collection-slider-top-label-text {
    margin: 0;
    font-family: 'Sacramento', cursive, sans-serif;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    color: #7295BB;
    text-align: center;
    text-transform: lowercase;
    display: block;
  }

  .collection-slider-section-title {
    text-align: center;
    margin-bottom: 0;
  }

  .collection-slider-section-title-label {
    margin: 0;
    font-family: 'Futura PT', 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 28px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  /* Collection slider card styling */
  .collection-slider-card {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .collection-slider-card__link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
  }

  .collection-slider-card__image-wrapper {
    height: 417px;
    overflow: hidden;
  }

  .collection-slider-card__image-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0) 53.36%, #000000 121.94%);
    z-index: 1;
    pointer-events: none;
  }

  .collection-slider-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .collection-slider-card__placeholder {
    width: 100%;
    height: 100%;
    background: #F7F7F7;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--padding-lg);
    font-size: var(--font-size--lg);
    color: var(--color-foreground);
    text-align: center;
  }

  .collection-slider-card__title-overlay {
    position: absolute;
    left: 0;
    right: 0;
    bottom: var(--title-margin-bottom);
    display: flex;
    justify-content: var(--title-position);
    align-items: center;
    padding: 0 24px;
    pointer-events: none;
    z-index: 2;
  }

  .collection-slider-card__title {
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-style: normal;
    font-size: 22px;
    line-height: 150%;
    letter-spacing: 0;
    text-transform: uppercase;
    color: #FFFFFF;
    text-align: center;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transition: text-decoration 0.3s ease;
  }

  .collection-slider-card__link:hover .collection-slider-card__title {
    text-decoration: underline;
  }

  /* Collection slider carousel container */
  .collection-slider-carousel {
    position: relative;
  }

  /* Remove horizontal padding from section */
  .collection-slider-section {
    padding-inline: 0 !important;
  }

  /* Allow overflow for arrows to show outside, but clip slides */
  .collection-slider-desktop slideshow-component {
    overflow: visible;
  }

  .collection-slider-desktop slideshow-container {
    position: relative;
    overflow: hidden;
  }

  /* Ensure carousel container allows arrows to show */
  .collection-slider-desktop.resource-list__carousel {
    overflow: visible;
  }

  /* Hide mobile carousel on desktop */
  .collection-slider-mobile {
    display: none;
  }

  @media (max-width: 768px) {
    .collection-slider-desktop {
      display: none;
    }
    
    .collection-slider-mobile {
      display: block;
    }
  }

  /* Desktop slider styling */
  .collection-slider-desktop .resource-list__carousel {
    --column-count: {{ section.settings.items_per_view | default: 4 }};
    --resource-list-column-gap-desktop: {{ section.settings.columns_gap | default: 12 }}px;
  }

  /* Ensure gap is applied to slideshow slides on desktop */
  .collection-slider-desktop slideshow-slides {
    gap: {{ section.settings.columns_gap | default: 12 }}px !important;
  }

  /* Position arrows outside the carousel on desktop */
  .collection-slider-wrapper {
    position: relative;
    padding: 0;
    overflow: visible;
  }

  .collection-slider-desktop slideshow-container {
    position: relative;
    overflow: visible;
  }

  .collection-slider-desktop slideshow-component {
    overflow: visible;
  }

  .collection-slider-desktop slideshow-arrows {
    position: absolute;
    inset: 0;
    left: auto;
    right: auto;
    width: calc(100% + 120px);
    max-width: none;
    pointer-events: none;
    z-index: var(--layer-heightened);
    margin-left: -60px;
    margin-right: -60px;
    display: flex !important;
  }

  .collection-slider-desktop slideshow-arrows[position='center'] {
    justify-content: space-between;
    align-items: center;
    padding: 0;
  }

  .collection-slider-desktop slideshow-arrows .slideshow-control {
    position: absolute;
    margin: 0;
    pointer-events: auto;
    top: 50%;
    transform: translateY(-50%);
    opacity: 1;
    transition: opacity 0.3s ease-out;
  }

  /* Arrows are now always visible - hover rules no longer needed */
  /* .collection-slider-wrapper:hover .collection-slider-desktop slideshow-arrows .slideshow-control,
  .collection-slider-wrapper:hover .collection-slider-desktop slideshow-component > slideshow-container > slideshow-arrows .slideshow-control,
  .collection-slider-desktop slideshow-component:hover > slideshow-container > slideshow-arrows .slideshow-control,
  .collection-slider-desktop slideshow-component:focus-within > slideshow-container > slideshow-arrows .slideshow-control {
    opacity: 1;
  } */

  /* Position arrows outside the slider container */
  .collection-slider-desktop slideshow-arrows .slideshow-control--previous {
    left: 0;
  }

  .collection-slider-desktop slideshow-arrows .slideshow-control--next {
    right: 0;
  }

  @media (max-width: 1200px) {
    .collection-slider-wrapper {
      padding: 0;
    }

    .collection-slider-desktop slideshow-arrows {
      width: calc(100% + 100px);
      margin-left: -50px;
      margin-right: -50px;
    }
  }

  /* Mobile slider styling - 2x2 grid */
  @media screen and (min-width: 750px) {
    .collection-slider-top-label-text {
      font-size: 38px;
    }
  }

  @media (max-width: 768px) {
    .collection-slider-header {
      margin-bottom: 16px;
    }

    .collection-slider-card__title {
      font-size: 14px;
      line-height: 150%;
    }

    .collection-slider-card__title-overlay {
      padding: 0 12px;
      --title-margin-bottom: 13px;
    }

    /* Mobile image dimensions and gradient */
    .collection-slider-card__image-wrapper {
      height: 219px;
    }

    .collection-slider-card__image-wrapper::before {
      background: linear-gradient(180.06deg, rgba(0, 0, 0, 0) 45.21%, #000000 121.86%);
    }

    /* Enable scrollbar on mobile - override slideshow default */
    .collection-slider-mobile slideshow-component {
      --cursor: grab;
      padding-bottom: 0 !important;
      margin-bottom: 0 !important;
    }

    .collection-slider-mobile slideshow-container {
      padding-bottom: 0 !important;
      margin-bottom: 0 !important;
    }

    .collection-slider-mobile slideshow-component[disabled='true'] slideshow-slides {
      overflow-x: auto !important;
    }

    .collection-slider-mobile slideshow-slides {
      overflow-x: auto !important;
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 0 !important;
      margin-bottom: 0 !important;
    }

    /* Hide native scrollbar */
    .collection-slider-mobile slideshow-slides::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    /* Custom scrollbar indicator */
    .collection-slider-scrollbar-indicator {
      width: 100%;
      height: 4px;
      position: relative;
    }

    .collection-slider-scrollbar-track {
      width: 100%;
      height: 4px;
      background-color: #EEEEEE;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }

    .collection-slider-scrollbar-thumb {
      height: 4px;
      background-color: #7295BB;
      border-radius: 10px;
      position: absolute;
      left: 0;
      top: 0;
      transition: width 0.1s ease-out;
      min-width: 20px;
    }

    /* Mobile slide: 2x2 grid layout */
    .collection-slider-mobile .collection-slider-slide-mobile {
      width: 100%;
      flex: 0 0 100%;
      scroll-snap-align: start;
    }

    .collection-slider-mobile-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      width: 100%;
      padding: 0;
    }

    .collection-slider-mobile-grid .collection-slider-item {
      width: 100%;
    }
  }

  /* Desktop: Show arrows, hide on mobile */
  @media (max-width: 768px) {
    .collection-slider-carousel slideshow-arrows {
      display: none !important;
    }
  }

  @media (min-width: 769px) {
    .collection-slider-carousel slideshow-arrows {
      display: flex;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const desktopCarousel = document.querySelector('[data-testid="collection-slider-grid"]');
    if (!desktopCarousel) return;

    const itemsPerView = parseInt(desktopCarousel.getAttribute('data-items-per-view')) || 4;
    const slideshow = desktopCarousel.querySelector('slideshow-component[ref="collectionSliderDesktop"]');
    if (!slideshow) return;

    const previousBtn = slideshow.querySelector('slideshow-arrows .slideshow-control--previous');
    const nextBtn = slideshow.querySelector('slideshow-arrows .slideshow-control--next');
    const slides = slideshow.querySelectorAll('slideshow-slide');

    if (!previousBtn || !nextBtn || slides.length === 0) return;

    let currentIndex = 0;
    const totalSlides = slides.length;
    const maxIndex = Math.max(0, totalSlides - itemsPerView);

    // Override previous button
    previousBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      currentIndex = Math.max(0, currentIndex - itemsPerView);
      if (slides[currentIndex]) {
        slideshow.select(currentIndex, e, { animate: true });
      }
    });

    // Override next button
    nextBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      currentIndex = Math.min(maxIndex, currentIndex + itemsPerView);
      if (slides[currentIndex]) {
        slideshow.select(currentIndex, e, { animate: true });
      }
    });

    // Update current index when slideshow changes
    slideshow.addEventListener('slideshow:select', function(event) {
      currentIndex = event.detail.index || 0;
    });
  });

  // Custom scrollbar indicator for mobile
  document.addEventListener('DOMContentLoaded', function() {
    const mobileSlides = document.querySelector('.collection-slider-mobile slideshow-slides');
    const scrollbarThumb = document.querySelector('.collection-slider-scrollbar-thumb');
    const scrollbarIndicator = document.querySelector('.collection-slider-scrollbar-indicator');
    
    if (!mobileSlides || !scrollbarThumb || !scrollbarIndicator) return;

    function updateScrollbar() {
      const scrollLeft = mobileSlides.scrollLeft;
      const scrollWidth = mobileSlides.scrollWidth;
      const clientWidth = mobileSlides.clientWidth;
      const maxScroll = scrollWidth - clientWidth;
      
      if (maxScroll <= 0) {
        scrollbarIndicator.style.display = 'none';
        return;
      }
      
      scrollbarIndicator.style.display = 'block';
      
      // Calculate thumb width and position
      const thumbWidth = (clientWidth / scrollWidth) * 100;
      const thumbPosition = (scrollLeft / maxScroll) * (100 - thumbWidth);
      
      scrollbarThumb.style.width = thumbWidth + '%';
      scrollbarThumb.style.left = thumbPosition + '%';
    }

    // Update on scroll
    mobileSlides.addEventListener('scroll', updateScrollbar);
    
    // Update on resize
    const resizeObserver = new ResizeObserver(updateScrollbar);
    resizeObserver.observe(mobileSlides);
    
    // Initial update
    updateScrollbar();
    
    // Update periodically to catch any changes
    setInterval(updateScrollbar, 100);
  });
</script>

{% schema %}
{
  "name": "Collection Slider",
  "class": "ui-test-collection-slider",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "top_label",
      "label": "Top Label",
      "default": "shop",
      "info": "Text displayed above the section title"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "OUR COLLECTIONS",
      "info": "Title displayed above the collection slider"
    },
    {
      "type": "collection_list",
      "id": "collection_list",
      "label": "Collections",
      "info": "Select specific collections to display. Leave empty to show all collections."
    },
    {
      "type": "range",
      "id": "items_per_view",
      "label": "Items per view",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4,
      "info": "Number of collections to show at once in the slider"
    },
    {
      "type": "select",
      "id": "title_position",
      "label": "Title Position",
      "options": [
        {
          "value": "flex-start",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "flex-end",
          "label": "Right"
        }
      ],
      "default": "center",
      "info": "Position of collection title on the image"
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow Style",
      "options": [
        {
          "value": "arrow",
          "label": "Arrows"
        },
        {
          "value": "chevron",
          "label": "Chevrons"
        },
        {
          "value": "arrows_large",
          "label": "Large Arrows"
        },
        {
          "value": "chevron_large",
          "label": "Large Chevrons"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "arrow"
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow Background",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ],
      "default": "none",
      "visible_if": "{{ section.settings.icons_style != 'none' }}"
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Horizontal Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page"
        },
        {
          "value": "full-width",
          "label": "Full"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Collection Slider",
      "category": "Collections",
      "settings": {
        "top_label": "shop",
        "section_title": "OUR COLLECTIONS",
        "items_per_view": 4,
        "title_position": "center",
        "icons_style": "arrow",
        "icons_shape": "none",
        "columns_gap": 12,
        "section_width": "page-width",
        "gap": 12,
        "color_scheme": "scheme-1",
        "padding-block-start": 48,
        "padding-block-end": 48
      }
    }
  ]
}
{% endschema %}

