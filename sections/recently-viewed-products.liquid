<script
  src="{{ 'recently-viewed-products-section.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  data-testid="recently-viewed-products"
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
    gap-style
    recently-viewed-products-section
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
>
  <div class="product-slider-header">
    {% if section.settings.top_label != blank %}
      <div class="product-slider-top-label">
        <span class="product-slider-top-label-text">{{ section.settings.top_label }}</span>
      </div>
    {% endif %}
    
    {% if section.settings.section_title != blank %}
      <div class="product-slider-section-title">
        <span class="product-slider-section-title-label">{{ section.settings.section_title }}</span>
      </div>
    {% endif %}
  </div>

  <recently-viewed-products-component
    id="recently-viewed-products-{{ section.id }}"
    data-section-id="{{ section.id }}"
    data-items-per-view="{{ section.settings.items_per_view | default: 4 }}"
    data-columns-gap="{{ section.settings.columns_gap | default: 8 }}"
    data-icons-style="{{ section.settings.icons_style | default: 'arrow' }}"
    data-icons-shape="{{ section.settings.icons_shape | default: 'none' }}"
    data-max-products="{{ section.settings.max_products | default: 10 }}"
    data-quick-add="{{ section.settings.quick_add | default: true }}"
    {{ section.shopify_attributes }}
  >
    <div class="recently-viewed-products-content">
      <div class="recently-viewed-products-skeleton">
        {% for i in (1..4) %}
          <div class="recently-viewed-products-skeleton-item"></div>
        {% endfor %}
      </div>
    </div>
  </recently-viewed-products-component>
</div>

<style>

  .recently-viewed-products-content .resource-card__content {
      margin-top: auto;
  }
  /* Use same styles as product-slider */
  [data-testid="recently-viewed-products"] .product-slider-header {
    text-align: center;
    margin-bottom: 16px;
  }

  @media screen and (min-width: 750px) {
    [data-testid="recently-viewed-products"] .product-slider-header {
      margin-bottom: 24px;
    }
  }

  [data-testid="recently-viewed-products"] .product-slider-top-label {
    text-align: center;
    margin-bottom: 0;
  }

  [data-testid="recently-viewed-products"] .product-slider-top-label-text {
    margin: 0;
    font-family: 'Sacramento', cursive, sans-serif;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    color: #7295BB;
    text-align: center;
    text-transform: lowercase;
    display: block;
  }

  [data-testid="recently-viewed-products"] .product-slider-section-title {
    text-align: center;
    margin-bottom: 0;
  }

  [data-testid="recently-viewed-products"] .product-slider-section-title-label {
    margin: 0;
    font-weight: 500;
    font-size: 24px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  @media screen and (min-width: 750px) {
    [data-testid="recently-viewed-products"] .product-slider-top-label-text {
      font-size: 38px;
    }
    [data-testid="recently-viewed-products"] .product-slider-section-title-label {
      font-size: 32px;
    }
  }

  .recently-viewed-products-skeleton {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }

  .recently-viewed-products-skeleton-item {
    aspect-ratio: 3 / 4;
    background-color: var(--color-foreground);
    opacity: 0.1;
    border-radius: 4px;
  }

  @media (max-width: 767px) {
    .recently-viewed-products-skeleton {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  recently-viewed-products-component:has([data-has-products='false']) {
    display: none;
  }

  recently-viewed-products-component[data-loaded='true'] .recently-viewed-products-skeleton {
    display: none;
  }


  /* Product slider carousel container */
  .recently-viewed-products-carousel {
    position: relative;
  }

  /* Remove horizontal padding for max width */
  [data-testid="recently-viewed-products"] .section--page-width {
    padding-inline: 0 !important;
  }

  [data-testid="recently-viewed-products"] .section--page-width > * {
    padding-inline: 0 !important;
  }

  [data-testid="recently-viewed-products-grid"] {
    padding-inline: 0 !important;
    --peek-next-slide-size: 0px;
    --gutter-slide-width: 0px !important;
    overflow: visible;
  }

  /* Use same carousel classes as product-slider */
  [data-testid="recently-viewed-products"] .product-slider-wrapper {
    position: relative;
    padding: 0;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop .resource-list__carousel {
    --column-count: var(--items-per-view, 4);
    --resource-list-column-gap-desktop: var(--columns-gap, 8px);
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-slides {
    gap: var(--columns-gap, 8px) !important;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-container {
    position: relative;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows {
    position: absolute;
    inset: 0;
    left: auto;
    right: auto;
    width: calc(100% + 120px);
    max-width: none;
    pointer-events: none;
    z-index: var(--layer-heightened);
    margin-left: -60px;
    margin-right: -60px;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows[position='center'] {
    justify-content: space-between;
    align-items: center;
    padding: 0;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows .slideshow-control {
    position: absolute;
    margin: 0;
    pointer-events: auto;
    opacity: 1;
    top: 50%;
    transform: translateY(-50%);
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows .slideshow-control--previous {
    left: 0;
  }

  [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows .slideshow-control--next {
    right: 0;
  }


  /* Ensure slideshow slides stretch to same height */
  [data-testid="recently-viewed-products-grid"] slideshow-slides {
    align-items: stretch !important;
  }

  /* Ensure all product cards have the same height (stretch) */
  [data-testid="recently-viewed-products-grid"] .resource-list__item,
  [data-testid="recently-viewed-products-grid"] [data-product-slider-item] {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    align-self: stretch !important;
  }

  /* Ensure product-card takes full height */
  [data-testid="recently-viewed-products-grid"] product-card {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    flex: 1 1 auto !important;
  }

  /* Ensure product-card__content uses flexbox and fills available space */
  [data-testid="recently-viewed-products-grid"] .product-card__content {
    display: flex !important;
    flex-direction: column !important;
    flex: 1 1 auto !important;
    min-height: 0 !important;
  }

  /* Product card actions styling for recently viewed section - match product-slider */
  /* Force visibility with high specificity */
  [data-testid="recently-viewed-products"] .product-card-actions,
  [data-testid="recently-viewed-products-grid"] .product-card-actions,
  [data-testid="recently-viewed-products"] [data-product-slider-item] .product-card-actions,
  [data-testid="recently-viewed-products-grid"] [data-product-slider-item] .product-card-actions {
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
    margin-top: auto !important; /* Push to bottom using auto margin */
    position: relative !important;
    z-index: 10 !important;
    width: 100% !important;
    visibility: visible !important;
    opacity: 1 !important;
    flex-shrink: 0 !important; /* Don't shrink the buttons */
  }

  /* Ensure product-card-actions are visible when data-view-product-button-setting is true */
  [data-testid="recently-viewed-products"] product-card[data-view-product-button-setting="true"] .product-card-actions,
  [data-testid="recently-viewed-products"] product-card[data-view-product-button-setting="true"] product-price .product-card-actions,
  [data-testid="recently-viewed-products"] [data-view-product-button-setting="true"] .product-card-actions,
  [data-testid="recently-viewed-products-grid"] product-card[data-view-product-button-setting="true"] .product-card-actions,
  [data-testid="recently-viewed-products-grid"] [data-view-product-button-setting="true"] .product-card-actions {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  /* Also ensure visibility for items that have the attribute */
  [data-testid="recently-viewed-products"] [data-product-slider-item][data-view-product-button-setting="true"] .product-card-actions {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    margin-top: 12px !important; 
  }

  [data-testid="recently-viewed-products"] .product-card-actions__view-product-button {
    background: #7295BB !important;
    border: 1px solid #7295BB !important;
    flex: 1 !important;
    padding: 10px 6px !important;
    margin: 0 !important;
    margin-t
    font-family: 'Outfit', sans-serif !important;
    font-style: normal !important;
    font-weight: 500 !important;
    font-size: 12px !important;
    line-height: 20px !important;
    text-transform: uppercase !important;
    color: #FFFFFF !important;
    text-decoration: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: background-color 0.2s ease, color 0.2s ease, border 0.2s ease !important;
    cursor: pointer !important;
    pointer-events: auto !important;
    position: relative !important;
    z-index: 100 !important;
  }

  [data-testid="recently-viewed-products"] .product-card-actions__view-product-button:hover {
    background: white !important;
    border: 1px solid #7295BB !important;
    color: #7295BB !important;
  }
  
  /* Ensure View Product button is clickable and not blocked by product card */
  [data-testid="recently-viewed-products"] .product-card-actions__view-product-button,
  [data-testid="recently-viewed-products"] .product-card-actions__view-product-button * {
    pointer-events: auto !important;
  }
  
  [data-testid="recently-viewed-products"] product-card:hover .product-card-actions__view-product-button {
    pointer-events: auto !important;
  }

  /* Disable product card hover effects (image zoom/scale) when hovering anywhere on card */
  /* Override base.css hover effects - prevent image zoom when hovering over card content */
  [data-testid="recently-viewed-products"] .card-hover-effect-subtle-zoom product-card:hover .card-gallery,
  [data-testid="recently-viewed-products"] .card-hover-effect-subtle-zoom product-card:hover .product-card__image,
  [data-testid="recently-viewed-products-grid"] .card-hover-effect-subtle-zoom product-card:hover .card-gallery,
  [data-testid="recently-viewed-products-grid"] .card-hover-effect-subtle-zoom product-card:hover .product-card__image {
    transform: none !important;
  }

  [data-testid="recently-viewed-products"] .card-hover-effect-lift product-card:hover,
  [data-testid="recently-viewed-products"] .card-hover-effect-scale product-card:hover,
  [data-testid="recently-viewed-products-grid"] .card-hover-effect-lift product-card:hover,
  [data-testid="recently-viewed-products-grid"] .card-hover-effect-scale product-card:hover {
    transform: none !important;
  }

  /* Only apply image hover effect when hovering directly over the card-gallery itself */
  [data-testid="recently-viewed-products"] .card-gallery,
  [data-testid="recently-viewed-products-grid"] .card-gallery {
    overflow: hidden;
    transition: transform var(--hover-transition-duration, 0.25s) var(--hover-transition-timing, ease-out);
  }

  [data-testid="recently-viewed-products"] .card-gallery:hover,
  [data-testid="recently-viewed-products-grid"] .card-gallery:hover {
    transform: scale(var(--hover-subtle-zoom-amount, 1.015)) !important;
  }

  [data-testid="recently-viewed-products"] .product-card-actions__quick-add-wrapper {
    display: flex !important;
    align-items: center !important;
    flex-shrink: 0 !important;
    margin: 0 !important;
    position: relative !important;
    width: 32px !important;
    height: 32px !important;
  }
  .recently-viewed-products-content .resource-card__image {
    aspect-ratio: 1;
  }

  @media screen and (min-width: 750px) {
    [data-testid="recently-viewed-products"] .product-card-actions__view-product-button {
      padding: 14px 20px !important;
      font-size: 16px !important;
      line-height: 140% !important;
    }
    
    [data-testid="recently-viewed-products"] .product-card-actions__quick-add-plus {
      font-size: 29.4042px !important;
      line-height: 37px !important;
      color: #7295BB !important;
      top: -2px !important;
    }
  }

  /* Tablet (iPad) - Show 3 items per row */
  @media (min-width: 768px) and (max-width: 1024px) {
    [data-testid="recently-viewed-products"] .product-slider-desktop .resource-list__carousel {
      --column-count: 3;
    }

    [data-testid="recently-viewed-products"] .product-slider-desktop .resource-list__slide {
      width: calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
      max-width: calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
      flex: 0 0 calc((100% - (var(--resource-list-column-gap-desktop, 8px) * 2)) / 3);
    }
  }

  @media (max-width: 1200px) {
    [data-testid="recently-viewed-products"] .product-slider-wrapper {
      padding: 0;
    }

    [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows {
      width: calc(100% + 100px);
      margin-left: -50px;
      margin-right: -50px;
    }
  }

  @media (max-width: 767px) {
    [data-testid="recently-viewed-products"] .product-slider-wrapper {
      padding: 0;
      max-width: calc((175px * 2) + 8px);
      width: 100%;
      margin: 0 auto;
    }

    [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-container {
      max-width: calc((175px * 2) + 8px);
      width: 100%;
      margin: 0 auto;
    }

    [data-testid="recently-viewed-products"] .product-slider-desktop slideshow-arrows {
      display: none !important;
    }

    /* Ensure card-gallery can scroll on mobile - allow overflow for product image scrolling */
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slides {
      overflow-x: auto !important;
      -webkit-overflow-scrolling: touch;
    }
  }

  /* Ensure card-gallery slider works properly - enable hover and arrows */
  [data-testid="recently-viewed-products-grid"] .card-gallery {
    pointer-events: auto;
  }

  [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component {
    pointer-events: auto;
  }

  /* Ensure slideshow slides can be scrolled even when disabled */
  [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] slideshow-slides {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
  }

  /* Desktop: Enable hover image change and arrows */
  @media screen and (min-width: 750px) {
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] slideshow-slides {
      overflow-x: auto !important;
      cursor: grab;
    }

    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] slideshow-slides:active {
      cursor: grabbing;
    }
  }

  /* Enable product card image slider on mobile */
  @media screen and (max-width: 749px) {
   
    [data-testid="recently-viewed-products"] .card-gallery slideshow-component[disabled='true'] slideshow-slides,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] slideshow-slides {
      overflow-x: auto !important;
    }

    [data-testid="recently-viewed-products"] .card-gallery slideshow-slides,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slides {
      overflow-x: auto !important;
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
    }

    [data-testid="recently-viewed-products"] .card-gallery slideshow-slides::-webkit-scrollbar,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slides::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

  }

  /* Enable product card image slider on desktop */
  @media screen and (min-width: 750px) {
    [data-testid="recently-viewed-products"] .card-gallery slideshow-component,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component {
      --cursor: grab;
      pointer-events: auto !important;
    }

    [data-testid="recently-viewed-products"] .card-gallery slideshow-component[disabled='true'],
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] {
      pointer-events: auto !important;
    }

    [data-testid="recently-viewed-products"] .card-gallery slideshow-component[disabled='true'] slideshow-slides,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-component[disabled='true'] slideshow-slides {
      overflow: visible !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      pointer-events: auto !important;
      scroll-behavior: smooth;
    }

    [data-testid="recently-viewed-products"] .card-gallery slideshow-slides,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slides {
      overflow: visible !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      scrollbar-width: none;
      -ms-overflow-style: none;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      pointer-events: auto !important;
    }

    /* Hide native scrollbar */
    [data-testid="recently-viewed-products"] .card-gallery slideshow-slides::-webkit-scrollbar,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slides::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    /* Ensure slides are visible and can be scrolled */
    [data-testid="recently-viewed-products"] .card-gallery slideshow-slide,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-slide {
      flex-shrink: 0;
      flex-basis: 100%;
      width: 100%;
      min-width: 100%;
      scroll-snap-align: start;
    }

    /* Ensure slideshow container allows scrolling */
    [data-testid="recently-viewed-products"] .card-gallery slideshow-container,
    [data-testid="recently-viewed-products-grid"] .card-gallery slideshow-container {
      overflow: visible;
    }
  }
</style>

{% schema %}
{
  "name": "Recently Viewed Products",
  "class": "ui-test-recently-viewed-products",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    },
    {
      "type": "_divider"
    },
    {
      "type": "_product-card"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "top_label",
      "label": "Top Label",
      "default": "shop",
      "info": "Text displayed above the section title"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "RECENTLY VIEWED",
      "info": "Title displayed above the product slider"
    },
    {
      "type": "header",
      "content": "Slider Settings"
    },
    {
      "type": "range",
      "id": "items_per_view",
      "label": "Items per view",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4,
      "info": "Number of products to show at once in the slider"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products to track",
      "min": 4,
      "max": 50,
      "step": 1,
      "default": 10,
      "info": "Maximum number of recently viewed products to store and display"
    },
    {
      "type": "checkbox",
      "id": "quick_add",
      "label": "Enable quick add",
      "default": true,
      "info": "Show the quick add button (+) on product cards"
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Horizontal Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow Style",
      "options": [
        {
          "value": "arrow",
          "label": "Arrows"
        },
        {
          "value": "chevron",
          "label": "Chevrons"
        },
        {
          "value": "arrows_large",
          "label": "Large Arrows"
        },
        {
          "value": "chevron_large",
          "label": "Large Chevrons"
        },
        {
          "value": "blue_arrows",
          "label": "Blue arrows"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "arrow"
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow Background",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ],
      "default": "none",
      "visible_if": "{{ section.settings.icons_style != 'none' }}"
    },
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page"
        },
        {
          "value": "full-width",
          "label": "Full"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed Products",
      "category": "Products",
      "settings": {
        "top_label": "shop",
        "section_title": "RECENTLY VIEWED",
        "items_per_view": 4,
        "max_products": 10,
        "columns_gap": 8,
        "icons_style": "arrow",
        "icons_shape": "none",
        "section_width": "page-width",
        "gap": 12,
        "color_scheme": "scheme-1",
        "padding-block-start": 48,
        "padding-block-end": 48
      }
    }
  ]
}
{% endschema %}
