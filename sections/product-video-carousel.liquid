{% liquid
  assign top_label = section.settings.top_label
  assign section_title = section.settings.section_title
  assign gap = section.settings.gap | default: 16
  assign items_per_view = 5
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="
    section
    section--{{ section.settings.section_width }}
    color-{{ section.settings.color_scheme }}
    spacing-style
    gap-style
    product-video-carousel-section
  "
  style="
    {% render 'spacing-style', settings: section.settings %}
    {% render 'gap-style', value: section.settings.gap %}
  "
>
  <div class="product-video-carousel__header">
    {% if top_label != blank %}
      <div class="product-video-carousel-top-label">
        <span class="product-video-carousel-top-label-text">{{ top_label }}</span>
      </div>
    {% endif %}
    
    {% if section_title != blank %}
      <div class="product-video-carousel-section-title">
        <span class="product-video-carousel-section-title-label">{{ section_title }}</span>
      </div>
    {% endif %}
  </div>

  {% if section.blocks.size > 0 %}
    {% liquid
      if section.settings.show_arrows == false
        assign effective_icons_style = 'none'
      else
        assign effective_icons_style = section.settings.icons_style
      endif

      assign slideshow_gutters = null
      assign gutter_style = '--gutter-slide-width: 0px;'
    %}

    {% capture slides %}
      {% for block in section.blocks %}
        {% if forloop.index0 > 0 %}<!--@list/split-->{% endif %}
        {% liquid
          assign block_video = block.settings.video
          assign block_image = block.settings.image
          assign block_product = block.settings.product
          assign video_to_show = null
          assign preview_image = null

          if block_video != blank
            assign video_to_show = block_video
            assign preview_image = block_video.preview_image
          elsif block_image != blank
            assign video_to_show = block_image
            assign preview_image = block_image
          else
            assign preview_image = block_product.featured_image
          endif
        %}
        
        <div class="product-video-carousel__item" {{ block.shopify_attributes }}>
          <div class="product-video-carousel__video-wrapper">
            {% if video_to_show != blank %}
              {% render 'video',
                video: video_to_show,
                video_loop: true,
                video_autoplay: false,
                disable_controls: true,
                section_id: section.id,
                video_class: 'product-video-carousel__video',
                video_preview_image: preview_image
              %}
            {% elsif block_image != blank %}
              <div class="product-video-carousel__image-wrapper">
                {{
                  block_image
                  | image_url: width: 3840
                  | image_tag: widths: '240, 352, 832, 1200, 1600, 1920, 2560, 3840', sizes: '100vw', loading: 'lazy', class: 'product-video-carousel__image', alt: block_image.alt
                }}
              </div>
            {% else %}
              <div class="product-video-carousel__placeholder-video">
                {{ 'hero-apparel-3' | placeholder_svg_tag: 'product-video-carousel__placeholder-svg' }}
              </div>
            {% endif %}
          </div>
          
          {% if block_product != blank %}
            <div class="product-video-carousel__product-info">
              {% if block_product.featured_image != blank %}
                <div class="product-video-carousel__product-image-wrapper">
                  <a href="{{ block_product.url }}" class="product-video-carousel__product-image-link">
                    {{
                      block_product.featured_image
                      | image_url: width: 200
                      | image_tag: widths: '100, 200', sizes: '100px', loading: 'lazy', class: 'product-video-carousel__product-image', alt: block_product.featured_image.alt
                    }}
                  </a>
                </div>
              {% endif %}
              <div class="product-video-carousel__product-details">
                <h4 class="product-video-carousel__product-title">
                  <a href="{{ block_product.url }}" class="product-video-carousel__product-link">
                    {{ block_product.title }}
                  </a>
                </h4>
                <div class="product-video-carousel__product-price">
                  {% render 'price', product_resource: block_product, show_sale_price_first: true %}
                </div>
              </div>
              {% if settings.quick_add and block_product.available %}
                <div class="product-video-carousel__quick-add-wrapper">
                  {% liquid
                    assign product_form_id = 'QuickAdd-ProductForm-' | append: block_product.id | append: '-' | append: block.id
                    assign variant = block_product.selected_or_first_available_variant
                  %}
                  <a href="{{ block_product.url }}" class="product-video-carousel__product-url" ref="productCardLink" style="display: none;"></a>
                  <quick-add-component
                    class="quick-add color-{{ section.settings.color_scheme }}"
                    ref="quickAdd"
                    data-product-title="{{ block_product.title }}"
                    data-quick-add-button="choose"
                    data-product-options-count="{{ block_product.options.size }}"
                  >
                    <product-form-component
                      data-section-id="{{ section.id }}"
                      data-product-id="{{ block_product.id }}"
                      on:submit="/handleSubmit"
                      class="quick-add__product-form-component"
                    >
                      <div
                        class="visually-hidden"
                        aria-live="assertive"
                        role="status"
                        aria-atomic="true"
                        ref="liveRegion"
                      ></div>
                      {%- form 'product', block_product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                        <input
                          type="hidden"
                          name="id"
                          ref="variantId"
                          value="{{ variant.id }}"
                          {% if variant.available == false %}
                            disabled
                          {% endif %}
                        >
                        <input
                          type="hidden"
                          name="quantity"
                          value="{% if variant.quantity_rule.min %}{{ variant.quantity_rule.min }}{% else %}1{% endif %}"
                        >
                        <button
                          class="button quick-add__button quick-add__button--choose add-to-cart-button product-video-carousel__plus-button"
                          type="button"
                          name="add"
                          on:click="quick-add-component/handleClick"
                        >
                          <span class="product-video-carousel__plus-text">+</span>
                        </button>
                      {%- endform -%}
                    </product-form-component>
                  </quick-add-component>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endcapture %}

    {% liquid
      assign slide_content = slides | strip
      assign slides_array = slide_content | split: '<!--@list/split-->'
    %}

    <div class="product-video-carousel__carousel-wrapper">
      <div
        class="product-video-carousel__carousel resource-list__carousel"
        style="{{ gutter_style }} --resource-list-column-gap-desktop: {{ gap }}px; --resource-list-column-gap: {{ gap }}px; --column-count: {{ items_per_view }}; --slide-width-max: 450px;"
        data-items-per-view="{{ items_per_view }}"
      >
        {% capture slideshow_slides %}
          {% for item in slides_array %}
            {% render 'slideshow-slide',
              index: forloop.index0,
              children: item,
              class: 'resource-list__slide product-video-carousel__slide'
            %}
          {% endfor %}
        {% endcapture %}
        
        {% render 'slideshow',
          ref: 'productVideoCarousel',
          class: 'product-video-carousel__slideshow resource-list__carousel',
          slides: slideshow_slides,
          show_arrows: section.settings.show_arrows,
          icon_style: effective_icons_style,
          icon_shape: section.settings.icons_shape,
          auto_hide_controls: false,
          infinite: false,
          initial_slide: 0,
          slide_count: slides_array.size,
          slideshow_gutters: slideshow_gutters
        %}
      </div>
    </div>
  {% else %}
    <div class="product-video-carousel__placeholder">
      <p>Please add video items to display.</p>
    </div>
  {% endif %}
</div>

{% stylesheet %}
  /* Prevent horizontal scroll on mobile */
  @media screen and (max-width: 749px) {
    .section--page-width {
      overflow-x: hidden !important;
      overflow-y: visible;
    }
    
    .product-video-carousel__carousel-wrapper {
      overflow-x: hidden;
      overflow-y: visible;
      width: 100%;
      max-width: 100%;
      position: relative;
    }
    
    .product-video-carousel__carousel {
      width: 100%;
      max-width: 100%;
    }
    
    .product-video-carousel__carousel slideshow-slides {
      width: 100%;
      max-width: 100%;
    }
  }
  
  /* Allow overflow visible on desktop for arrows positioned outside */
  @media screen and (min-width: 750px) {
    .section--page-width {
      overflow-x: visible;
    }
  }
  
  .product-video-carousel__header {
    text-align: center;
    margin-bottom: 16px;
  }

  @media screen and (min-width: 750px) {
    .product-video-carousel__header {
      margin-bottom: 24px;
    }
  }

  .product-video-carousel-top-label {
    text-align: center;
    margin-bottom: 0;
  }

  .product-video-carousel-top-label-text {
    margin: 0;
    font-family: 'Sacramento', cursive, sans-serif;
    font-weight: 400;
    font-size: 30px;
    line-height: 150%;
    color: #7295BB;
    text-align: center;
    text-transform: lowercase;
    display: block;
  }

  .product-video-carousel-section-title {
    text-align: center;
    margin-bottom: 0;
  }

  .product-video-carousel-section-title-label {
    margin: 0;
    font-family: 'Futura PT', 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 28px;
    line-height: 150%;
    text-transform: uppercase;
    color: #1D425A;
    text-align: center;
    display: block;
  }

  @media screen and (min-width: 750px) {
    .product-video-carousel-top-label-text {
      font-size: 38px;
    }
  }

  .product-video-carousel__item {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    touch-action: manipulation;
    transition: transform 0.3s ease, width 0.3s ease, height 0.3s ease;
  }
  
  .product-video-carousel__image-wrapper {
    width: 100%;
    aspect-ratio: 204 / 321;
    overflow: hidden;
    border-radius: 4px;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__image-wrapper {
      aspect-ratio: 281 / 442;
    }
  }
  
  .product-video-carousel__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .product-video-carousel__product-info {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px;
    background-color: #FFFFFF;
    border-radius: 4px;
    box-sizing: border-box;
    position: relative;
    width: 100%;
  }
  
  .product-video-carousel__product-image-wrapper {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    overflow: visible;
    border-radius: 4px;
    background-color: #F7F7F7;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__product-image-wrapper {
      width: 53px;
      height: 53px;
    }
  }
  
  .product-video-carousel__product-image-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background-color: transparent;
  }
  
  .product-video-carousel__product-image {
    object-fit: cover;
    display: block;
    background-color: transparent;
    margin: auto;
  }
  
  .product-video-carousel__product-image-wrapper img.product-video-carousel__product-image,
  .product-video-carousel__product-image-wrapper img {
    background-color: #F7F7F7 !important;
  }
  
  .product-video-carousel__product-details {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .product-video-carousel__product-title {
    margin: 0;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 16px;
    color: #1D425A;
    display: flex;
    align-items: center;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__product-title {
      font-size: 14px;
      line-height: 18px;
    }
  }
  
  .product-video-carousel__product-link {
    color: inherit;
    text-decoration: none;
    transition: opacity 0.2s ease;
  }
  
  .product-video-carousel__product-link:hover {
    opacity: 0.8;
  }
  
  .product-video-carousel__product-price {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 160%;
    color: #1D425A;
  }
  
  .product-video-carousel__product-price .price {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 13px;
    line-height: 160%;
    color: #1D425A;
  }
  
  .product-video-carousel__product-price .compare-at-price,
  .product-video-carousel__product-price .price-discount-badge,
  .product-video-carousel__product-price .price-snippet .compare-at-price {
    display: none !important;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__product-price {
      font-size: 14px;
      line-height: 160%;
    }
    
    .product-video-carousel__product-price .price {
      font-size: 14px;
      line-height: 160%;
    }
  }
  
  .product-video-carousel__quick-add-wrapper {
    position: relative;
    width: 20.99px;
    height: 20.99px;
    pointer-events: all;
    flex-shrink: 0;
  }
  
  .product-video-carousel__quick-add-wrapper .quick-add {
    position: relative;
    inset: auto;
    pointer-events: all;
  }
  
  .product-video-carousel__quick-add-wrapper .quick-add__button--add {
    display: none !important;
  }
  
  .product-video-carousel__quick-add-wrapper .quick-add__button--choose {
    position: relative;
    right: auto;
    bottom: auto;
    width: 20.99px;
    height: 20.99px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    border-radius: 50%;
    border: 1px solid #1D425A;
    background: transparent;
    min-width: 20.99px;
  }
  
  .product-video-carousel__quick-add-wrapper .quick-add__button--choose:hover {
    opacity: 0.8;
  }
  
  .product-video-carousel__plus-text {
    font-family: 'Geologica', sans-serif;
    font-style: normal;
    font-weight: 100;
    font-size: 19.5279px;
    line-height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #1D425A;
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    position: relative;
    top: -1px;
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__quick-add-wrapper .quick-add__button--choose {
      width: 31.61px;
      height: 31.61px;
      border: 0.735105px solid #7295BB;
      min-width: 31.61px;
    }
    
    .product-video-carousel__plus-text {
      font-size: 29.4042px;
      line-height: 37px;
      color: #7295BB;
      top: -2px;
    }
  }

  .product-video-carousel__video-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 204 / 321;
    overflow: hidden;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-button {
    cursor: pointer;
    pointer-events: auto !important;
    z-index: var(--layer-raised);
    position: relative;
  }
  
  .product-video-carousel__video-wrapper deferred-media:not([data-media-loaded]) .deferred-media__poster-button {
    z-index: var(--layer-raised);
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__video-wrapper {
      aspect-ratio: 281 / 442;
    }
  }

  .product-video-carousel__video {
    width: 100%;
    height: 100%;
  }

  .product-video-carousel__video-wrapper deferred-media {
    width: 100%;
    height: 100%;
    display: block;
  }

  .product-video-carousel__video-wrapper deferred-media video,
  .product-video-carousel__video-wrapper deferred-media iframe {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .product-video-carousel__video-wrapper deferred-media[data-media-loaded] .video-interaction-hint {
    opacity: 1 !important;
    pointer-events: auto !important;
    z-index: var(--layer-raised) !important;
  }
  
  .product-video-carousel__video-wrapper deferred-media[data-media-loaded] .video-interaction-hint.deferred-media__poster-button {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: var(--layer-raised);
  }
  
  .product-video-carousel__video-wrapper deferred-media[data-media-loaded] {
    cursor: pointer;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play svg {
    display: none !important;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play.hidden {
    display: none !important;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play:not(.hidden) {
    width: 49px !important;
    height: 49px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play:not(.hidden)::after {
    content: '';
    display: block;
    width: 49px;
    height: 49px;
    background-image: url("data:image/svg+xml,%3Csvg width='49' height='49' viewBox='0 0 49 49' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-2.28349' y='-2.28349' width='53.0909' height='53.0909'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.14px);clip-path:url(%23bgblur_0_860_8379_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='2.28349' cx='24.2621' cy='24.2621' r='24.2621' fill='%23222222' fill-opacity='0.36'/%3E%3Cpath d='M19 15L19 33L31 24L19 15Z' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_8379_clip_path' transform='translate(2.28349 2.28349)'%3E%3Ccircle cx='24.2621' cy='24.2621' r='24.2621'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause svg {
    display: none !important;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause.hidden {
    display: none !important;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause:not(.hidden) {
    width: 49px !important;
    height: 49px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  
  .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause:not(.hidden)::after {
    content: '';
    display: block;
    width: 49px;
    height: 49px;
    background-image: url("data:image/svg+xml,%3Csvg width='49' height='49' viewBox='0 0 49 49' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-2.28349' y='-2.28349' width='53.0909' height='53.0909'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.14px);clip-path:url(%23bgblur_0_860_8379_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='2.28349' cx='24.2621' cy='24.2621' r='24.2621' fill='%23222222' fill-opacity='0.36'/%3E%3Crect x='18' y='14' width='4' height='20' fill='white'/%3E%3Crect x='27' y='14' width='4' height='20' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_8379_clip_path' transform='translate(2.28349 2.28349)'%3E%3Ccircle cx='24.2621' cy='24.2621' r='24.2621'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play:not(.hidden) {
      width: 70px !important;
      height: 70px !important;
    }
    
    .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-play:not(.hidden)::after {
      width: 70px;
      height: 70px;
      background-image: url("data:image/svg+xml,%3Csvg width='70' height='70' viewBox='0 0 70 70' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-3.2696' y='-3.2696' width='76.0182' height='76.0182'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.63px);clip-path:url(%23bgblur_0_860_7705_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='3.2696' cx='34.7395' cy='34.7395' r='34.7395' fill='%23222222' fill-opacity='0.36'/%3E%3Cpath d='M27 21L27 48L43 34.5L27 21Z' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_7705_clip_path' transform='translate(3.2696 3.2696)'%3E%3Ccircle cx='34.7395' cy='34.7395' r='34.7395'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    }
    
    .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause:not(.hidden) {
      width: 70px !important;
      height: 70px !important;
    }
    
    .product-video-carousel__video-wrapper .deferred-media__poster-icon.icon-pause:not(.hidden)::after {
      width: 70px;
      height: 70px;
      background-image: url("data:image/svg+xml,%3Csvg width='70' height='70' viewBox='0 0 70 70' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3CforeignObject x='-3.2696' y='-3.2696' width='76.0182' height='76.0182'%3E%3Cdiv xmlns='http://www.w3.org/1999/xhtml' style='backdrop-filter:blur(1.63px);clip-path:url(%23bgblur_0_860_7705_clip_path);height:100%25;width:100%25'%3E%3C/div%3E%3C/foreignObject%3E%3Ccircle data-figma-bg-blur-radius='3.2696' cx='34.7395' cy='34.7395' r='34.7395' fill='%23222222' fill-opacity='0.36'/%3E%3Crect x='25' y='20' width='6' height='30' fill='white'/%3E%3Crect x='39' y='20' width='6' height='30' fill='white'/%3E%3Cdefs%3E%3CclipPath id='bgblur_0_860_7705_clip_path' transform='translate(3.2696 3.2696)'%3E%3Ccircle cx='34.7395' cy='34.7395' r='34.7395'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E");
    }
  }

  .product-video-carousel__carousel-wrapper {
    width: 100%;
    position: relative;
  }

  .product-video-carousel__carousel.resource-list__carousel {
    width: 100%;
  }
  
  /* Position arrows outside the slider container */
  .product-video-carousel__carousel slideshow-arrows {
    position: absolute;
    inset: 0;
    left: auto;
    right: auto;
    width: calc(100% + 120px);
    max-width: none;
    pointer-events: none;
    z-index: var(--layer-heightened);
    margin-left: -60px;
    margin-right: -60px;
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  .product-video-carousel__carousel slideshow-arrows[position='center'] {
    justify-content: space-between;
    align-items: center;
    padding: 0;
  }
  
  .product-video-carousel__carousel.resource-list__carousel .slideshow-control[disabled],
  .product-video-carousel__carousel .slideshow-control[disabled] {
    display: flex !important;
    opacity: 0.3 !important;
    pointer-events: none;
    visibility: visible !important;
  }
  
  .product-video-carousel__carousel .slideshow-control {
    position: absolute;
    margin: 0;
    pointer-events: auto;
    top: 50%;
    transform: translateY(-50%);
    opacity: 1;
    display: flex !important;
    transition: opacity 0.2s ease;
  }
  
  .product-video-carousel__carousel .slideshow-control:not([disabled]) {
    opacity: 1;
    pointer-events: auto;
  }

  .product-video-carousel__carousel slideshow-arrows .slideshow-control--previous {
    left: 0;
  }

  .product-video-carousel__carousel slideshow-arrows .slideshow-control--next {
    right: 0;
  }

  @media (max-width: 1200px) {
    .product-video-carousel__carousel-wrapper {
      padding: 0;
    }

    .product-video-carousel__carousel slideshow-arrows {
      width: calc(100% + 100px);
      margin-left: -50px;
      margin-right: -50px;
    }
  }
  
  @media screen and (max-width: 749px) {
    .product-video-carousel__carousel-wrapper {
      overflow: hidden;
      position: relative;
    }
    
    .product-video-carousel__carousel slideshow-arrows {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
      left: 0;
      right: 0;
    }
    
    .product-video-carousel__carousel slideshow-arrows .slideshow-control--previous {
      left: 10px;
    }
    
    .product-video-carousel__carousel slideshow-arrows .slideshow-control--next {
      right: 10px;
    }
  }
  
  /* Active slide styling - larger width and height */
  @container resource-list-carousel (min-width: 750px) {
    .product-video-carousel__carousel slideshow-slide.product-video-carousel__active-slide {
      --section-slide-width: calc(
        ((100% - (var(--resource-list-column-gap) * (var(--column-count) - 1)) - var(--peek-next-slide-size, 0px)) / var(--column-count)) * 1.4
      );
      --slide-width: var(--section-slide-width) !important;
    }
  }
  
  @media screen and (min-width: 750px) {
    .product-video-carousel__carousel.resource-list__carousel slideshow-slide.product-video-carousel__active-slide {
      width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.4
      ) !important;
      min-width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.4
      ) !important;
      max-width: calc(
        ((100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)) * 1.4
      ) !important;
      flex-shrink: 0 !important;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }

    /* Make the video wrapper and item taller for active slide */
    .product-video-carousel__carousel slideshow-slide.product-video-carousel__active-slide .product-video-carousel__video-wrapper {
      aspect-ratio: 281 / 520;
    }
  }
  
  /* For mobile, make the active item larger */
  @container resource-list-carousel (max-width: 749px) {
    .product-video-carousel__carousel slideshow-slide.product-video-carousel__active-slide {
      --slide-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.3) !important;
    }
  }
  
  @media screen and (max-width: 749px) {
    .product-video-carousel__carousel.resource-list__carousel slideshow-slide.product-video-carousel__active-slide {
      width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.3) !important;
      min-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.3) !important;
      max-width: calc(clamp(150px, var(--mobile-card-size, 60cqw), var(--slide-width-max)) * 1.3) !important;
      flex-shrink: 0 !important;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
  }

  /* Default slide width (non-active) */
  @media screen and (min-width: 750px) {
    .product-video-carousel__carousel.resource-list__carousel slideshow-slide:not(.product-video-carousel__active-slide) {
      width: calc(
        (100% - (var(--resource-list-column-gap-desktop, var(--resource-list-column-gap)) * (var(--column-count) - 1))) / var(--column-count)
      ) !important;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
  }

  .product-video-carousel__placeholder {
    text-align: center;
    padding: 40px 20px;
  }
  
{% endstylesheet %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.product-video-carousel__carousel');
    if (!carousel) return;
    
    const slidesContainer = carousel.querySelector('slideshow-slides');
    if (!slidesContainer) return;
    
    const slides = Array.from(carousel.querySelectorAll('slideshow-slide'));
    if (slides.length === 0) return;
    
    const slideshowComponent = carousel.closest('slideshow-component');
    if (!slideshowComponent) return;
    
    const itemsPerView = parseInt(carousel.getAttribute('data-items-per-view')) || 5;
    let currentActiveIndex = 0;
    let isNavigating = false;
    
    // Function to set active slide
    function setActiveSlide(index) {
      // Remove active class from all slides
      slides.forEach(slide => {
        slide.classList.remove('product-video-carousel__active-slide');
      });
      
      // Add active class to the new active slide
      if (slides[index]) {
        slides[index].classList.add('product-video-carousel__active-slide');
        currentActiveIndex = index;
      }
    }
    
    // Function to navigate one item at a time
    function navigateOneItem(direction) {
      if (isNavigating) return;
      isNavigating = true;
      
      let nextIndex = currentActiveIndex;
      
      if (direction === 'next') {
        // Move forward by 1, but don't go beyond the last item
        nextIndex = Math.min(slides.length - 1, currentActiveIndex + 1);
      } else {
        // Move backward by 1, but don't go below 0
        nextIndex = Math.max(0, currentActiveIndex - 1);
      }
      
      // If we can't move further, don't do anything
      if (nextIndex === currentActiveIndex) {
        isNavigating = false;
        return;
      }
      
      // Update active slide first
      setActiveSlide(nextIndex);
      
      // Wait for CSS to apply the size change, then scroll
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const activeSlide = slides[nextIndex];
          if (!activeSlide) {
            isNavigating = false;
            return;
          }
          
          const containerRect = slidesContainer.getBoundingClientRect();
          const containerWidth = containerRect.width;
          const gap = parseInt(getComputedStyle(carousel).getPropertyValue('--resource-list-column-gap-desktop')) || 16;
          
          // Calculate the left position of the active slide
          let activeSlideLeft = 0;
          for (let i = 0; i < nextIndex; i++) {
            const prevSlide = slides[i];
            if (prevSlide) {
              const prevRect = prevSlide.getBoundingClientRect();
              activeSlideLeft += prevRect.width;
              if (i < nextIndex - 1) {
                activeSlideLeft += gap;
              }
            }
          }
          
          // Calculate target scroll to show 5 items with active visible
          let targetScroll = 0;
          
          if (nextIndex < 2) {
            // First two: scroll to start
            targetScroll = 0;
          } else {
            // For items after the first two, scroll to show active with 2 items before it
            // Calculate width of 2 previous items + gaps
            let widthOfTwoBefore = 0;
            if (nextIndex >= 2) {
              for (let i = nextIndex - 2; i < nextIndex; i++) {
                const slide = slides[i];
                if (slide) {
                  const rect = slide.getBoundingClientRect();
                  widthOfTwoBefore += rect.width;
                  if (i < nextIndex - 1) {
                    widthOfTwoBefore += gap;
                  }
                }
              }
            }
            
            // Position so we see 2 items before active
            targetScroll = activeSlideLeft - widthOfTwoBefore;
            
            // Clamp to valid range
            const maxScroll = slidesContainer.scrollWidth - slidesContainer.clientWidth;
            targetScroll = Math.max(0, Math.min(targetScroll, maxScroll));
          }
          
          // Scroll smoothly
          slidesContainer.scrollTo({
            left: targetScroll,
            behavior: 'smooth'
          });
          
          // Update slideshow component's current index
          if (slideshowComponent.select) {
            slideshowComponent.select(nextIndex, null, { animate: false });
          }
          
          // Reset navigation flag after animation
          setTimeout(() => {
            isNavigating = false;
          }, 500);
        });
      });
    }
    
    // Override slideshow component's next/previous methods
    const originalNext = slideshowComponent.next;
    const originalPrevious = slideshowComponent.previous;
    
    slideshowComponent.next = function(event, options) {
      navigateOneItem('next');
    };
    
    slideshowComponent.previous = function(event, options) {
      navigateOneItem('previous');
    };
    
    // Initialize: set first slide as active
    setTimeout(function() {
      setActiveSlide(0);
      
      // Ensure first slide is visible
      if (slides[0]) {
        slidesContainer.scrollTo({
          left: 0,
          behavior: 'auto'
        });
      }
    }, 200);
    
    // Handle scroll events to update active slide based on position
    let scrollTimeout;
    slidesContainer.addEventListener('scroll', function() {
      if (isNavigating) return;
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
        const containerRect = slidesContainer.getBoundingClientRect();
        const containerCenter = containerRect.left + containerRect.width / 2;
        
        let closestSlide = null;
        let minDistance = Infinity;
        
        slides.forEach((slide, index) => {
          const slideRect = slide.getBoundingClientRect();
          const slideCenter = slideRect.left + slideRect.width / 2;
          const distance = Math.abs(containerCenter - slideCenter);
          
          // Only consider visible slides
          if (slideRect.right > containerRect.left && slideRect.left < containerRect.right) {
            if (distance < minDistance) {
              minDistance = distance;
              closestSlide = { slide, index };
            }
          }
        });
        
        if (closestSlide) {
          setActiveSlide(closestSlide.index);
        }
      }, 100);
    }, { passive: true });
    
    // Make video wrappers clickable to toggle play/pause
    const videoWrappers = carousel.querySelectorAll('.product-video-carousel__video-wrapper');
    videoWrappers.forEach(function(wrapper) {
      const deferredMedia = wrapper.querySelector('deferred-media');
      if (!deferredMedia) return;
      
      let clickHandlerAdded = false;
      
      function handleVideoClick(e) {
        if (e.target.closest('button, a, .quick-add')) {
          return;
        }
        
        if (!deferredMedia.hasAttribute('data-media-loaded')) {
          return;
        }
        
        if (deferredMedia.toggleMedia && typeof deferredMedia.toggleMedia === 'function') {
          deferredMedia.toggleMedia();
        }
      }
      
      function setupVideoClickHandler() {
        if (clickHandlerAdded) return;
        clickHandlerAdded = true;
        wrapper.addEventListener('click', handleVideoClick, true);
        wrapper.style.cursor = 'pointer';
      }
      
      function playVideoAfterLoad() {
        let attempts = 0;
        const maxAttempts = 10;
        
        function tryPlay() {
          attempts++;
          
          if (deferredMedia.playMedia && typeof deferredMedia.playMedia === 'function') {
            try {
              deferredMedia.playMedia();
              return;
            } catch (err) {
              console.log('playMedia method failed:', err);
            }
          }
          
          const videoElement = deferredMedia.querySelector('video');
          const iframe = deferredMedia.querySelector('iframe[data-video-type]');
          
          if (videoElement) {
            videoElement.play().catch(function(err) {
              if (attempts < maxAttempts) {
                setTimeout(tryPlay, 50);
              }
            });
          } else if (iframe) {
            const videoType = iframe.dataset.videoType;
            if (videoType === 'youtube') {
              iframe.contentWindow?.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
            } else if (videoType === 'vimeo') {
              iframe.contentWindow?.postMessage('{"method":"play"}', '*');
            }
          } else if (attempts < maxAttempts) {
            setTimeout(tryPlay, 50);
          }
        }
        
        setTimeout(tryPlay, 50);
      }
      
      const mediaObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-media-loaded') {
            setupVideoClickHandler();
            playVideoAfterLoad();
          }
        });
      });
      
      mediaObserver.observe(deferredMedia, {
        attributes: true,
        attributeFilter: ['data-media-loaded']
      });
      
      if (deferredMedia.hasAttribute('data-media-loaded')) {
        setupVideoClickHandler();
      }
    });
  });
</script>

{% schema %}
{
  "name": "Product Video Carousel",
  "tag": "section",
  "class": "section-wrapper",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "blocks": [
    {
      "type": "video_item",
      "name": "Video Item",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image (fallback if no video)"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Associated Product"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "top_label",
      "label": "Top Label",
      "default": "shop",
      "info": "Text displayed above the section title"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "FEATURED PRODUCTS",
      "info": "Title displayed above the carousel"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between products",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": true
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "Arrow style",
      "default": "arrow",
      "options": [
        {
          "value": "arrow",
          "label": "Arrows"
        },
        {
          "value": "chevron",
          "label": "Chevrons"
        },
        {
          "value": "arrows_large",
          "label": "Large Arrows"
        },
        {
          "value": "chevron_large",
          "label": "Large Chevrons"
        },
        {
          "value": "blue_arrows",
          "label": "Blue arrows"
        },
        {
          "value": "none",
          "label": "None"
        }
      ]
    },
    {
      "type": "select",
      "id": "icons_shape",
      "label": "Arrow background",
      "default": "none",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "circle",
          "label": "Circle"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ]
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "default": "page-width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "full-width",
          "label": "Full width"
        }
      ]
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Product Video Carousel",
      "category": "Products"
    }
  ]
}
{% endschema %}

