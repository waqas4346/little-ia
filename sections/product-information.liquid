

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{% capture media_gallery %}
  {%- content_for 'block',
    type: '_product-media-gallery',
    id: 'media-gallery',
    closest.product: closest.product
  -%}
{% endcapture %}

{% capture product_details %}
  {% content_for 'block',
    type: '_product-details',
    id: 'product-details',
    closest.product: closest.product
  %}
{% endcapture %}

{% capture additional_blocks %}
  {% content_for 'blocks' %}
{% endcapture %}

{% if section.settings.enable_sticky_add_to_cart %}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
    # Get the initial quantity based on quantity rules
    assign initial_quantity = current_variant.quantity_rule.min | default: 1
    
    # Check if product has personalization enabled
    assign show_personalise_button = false
    assign product_tags_lowercase = product.tags | join: ' ' | downcase
    if product_tags_lowercase contains 'cust_personalized'
      assign show_personalise_button = true
    endif
  %}

  <sticky-add-to-cart
    class="sticky-add-to-cart"
    data-variant-available="{{ current_variant.available }}"
    data-product-id="{{ product.id }}"
    data-current-variant-id="{{ current_variant.id }}"
    data-initial-quantity="{{ initial_quantity }}"
    data-default-variant-title="{{ 'products.product.default_title' | t }}"
  >
    <div
      class="sticky-add-to-cart__bar color-{{ settings.popover_color_scheme }}"
      data-stuck="false"
      ref="stickyBar"
      role="region"
      aria-label="{{ 'products.product.sticky_add_to_cart' | t }}"
    >
      {% liquid
        assign image_to_show = current_variant.featured_image | default: product.featured_image
      %}
      
      <div class="sticky-add-to-cart__content">
        <div class="sticky-add-to-cart__product-info">
          {% if image_to_show %}
            <div
              class="sticky-add-to-cart__image"
            >
              {% assign image_alt = image_to_show.alt | default: product.title | escape %}
              {{
                image_to_show
                | image_url: width: 120
                | image_tag:
                  loading: 'lazy',
                  alt: image_alt,
                  class: 'sticky-add-to-cart__image-img',
                  data-testid: 'sticky-product-image',
                  srcset: null,
                  sizes: null,
                  ref: 'productImage'
              }}
            </div>
          {% endif %}

          <div class="sticky-add-to-cart__info">
            <h3
              class="sticky-add-to-cart__title"
              data-testid="sticky-product-title"
            >
              {{ product.title | escape }}
            </h3>
            <div
              class="sticky-add-to-cart__price"
              data-testid="sticky-price-display"
            >
              {% render 'price', product_resource: product, show_sale_price_first: true %}
            </div>
          </div>
        </div>

        <div class="sticky-add-to-cart__actions">
          {% if show_personalise_button %}
          <button
            type="button"
            class="sticky-add-to-cart__personalise-button personalise-button button-unstyled"
            data-personalise-button
          >
            <span class="personalise-button__summary" data-personalise-summary style="display: none;"></span>
            <div class="icon-tex-container"> 
            <span class="personalise-button__icon">
             <img src="{{ 'edit-icon-personisation.png' | asset_url }}" alt="" width="18" height="18">

            </span>
            <span class="personalise-button__text" data-personalise-text>PERSONALISE IT</span>
           </div>
          </button>
          {% endif %}
          
          <button
            type="button"
            class="sticky-add-to-cart__button add-to-cart-button button button--primary"
            ref="addToCartButton"
            on:click="/handleAddToCartClick"
            {% unless current_variant.available %}
              disabled
            {% endunless %}
          >
            <span
              class="add-to-cart-text"
            >
              <span class="add-to-cart-text__content">
                <span>
                  {%- if current_variant.available -%}
                    {{- 'products.product.add_to_cart' | t -}}
                  {%- elsif current_variant == blank -%}
                    {{- 'products.product.unavailable' | t -}}
                  {%- else -%}
                    {{- 'products.product.sold_out' | t -}}
                  {%- endif -%}
                </span>
                <span
                  class="quantity-display"
                  ref="quantityDisplay"
                  {% if current_variant.available and initial_quantity > 1 %}
                    style="display: inline;"
                  {% else %}
                    style="display: none;"
                  {% endif %}
                >
                  {{- ' (' -}}
                  <span ref="quantityNumber">{{- initial_quantity -}}</span>
                  {{- ')' -}}
                </span>
              </span>
            </span>
            <span class="add-to-cart__added">
              <span class="svg-wrapper add-to-cart__added-icon">
                {{- 'icon-checkmark-burst.svg' | inline_asset_content -}}
              </span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </sticky-add-to-cart>
{% endif %}

{%- comment -%} Personalise Modal {%- endcomment -%}
{% render 'personalise-modal', product: product, variant: product.selected_or_first_available_variant %}

<script src="{{ 'personalise-modal.js' | asset_url }}" type="module"></script>

{%- comment -%} Size Guide Modal {%- endcomment -%}
{% render 'size-guide-modal', product: product %}

<script src="{{ 'size-guide-modal.js' | asset_url }}" type="module"></script>
<script>
  // Handle personalise button clicks for sticky bar - completely silent error handling
  (function() {
    'use strict';
    
    // Simple function to safely open the dialog when button is clicked
    function handlePersonaliseClick(e) {
      try {
        const button = e.target.closest('[data-personalise-button]');
        if (!button) return;
        
        e.preventDefault();
        e.stopPropagation();
        
          // Try to find and open the dialog with retries
          function tryOpenDialog(attempts) {
            attempts = attempts || 0;
            const maxAttempts = 40; // Increased for slower mobile devices
            
            try {
              // CRITICAL: Check if button is in quick-add modal - if so, find dialog within that modal
              let dialog = null;
              const quickAddModal = button.closest('#quick-add-modal-content');
              
              if (quickAddModal) {
                // Button is in quick-add modal - find personalise-dialog associated with this modal
                // First, try to find one marked for quick-add
                const productFormComponent = quickAddModal.querySelector('product-form-component');
                const productId = productFormComponent?.dataset?.productId;
                
                if (productId) {
                  // Try to find dialog with matching product ID
                  dialog = document.querySelector(`personalise-dialog[data-product-id="${productId}"][data-quick-add="true"]`);
                }
                
                // If not found by product ID, try to find one in modal content
                if (!dialog) {
                  dialog = quickAddModal.querySelector('personalise-dialog');
                }
                
                // If still not found, find one marked for quick-add (any product)
                if (!dialog) {
                  dialog = document.querySelector('personalise-dialog[data-quick-add="true"]');
                }
                
                // Last resort: find any dialog that's not the main product page one
                if (!dialog) {
                  const allDialogs = document.querySelectorAll('personalise-dialog');
                  if (allDialogs.length > 1) {
                    dialog = Array.from(allDialogs).find(d => {
                      const context = d.getAttribute('data-context');
                      return context !== 'product-page';
                    }) || allDialogs[0];
                  } else if (allDialogs.length === 1) {
                    dialog = allDialogs[0];
                  }
                }
              } else {
                // Button is NOT in quick-add modal - use main product page dialog
                dialog = document.getElementById('personalise-dialog') || 
                        document.querySelector('personalise-dialog');
              }
            
            if (dialog) {
              // Capture current variant from form (form that contains the Personalise button) so modal shows correct variant
              let variantIdFromForm = null;
              const buttonForm = button.closest('product-form-component')?.querySelector('form[data-type="add-to-cart-form"]') || button.closest('form');
              const variantInput = buttonForm?.querySelector('input[name="id"]');
              if (variantInput?.value) variantIdFromForm = variantInput.value;

              // Check if custom element class is defined
              const isCustomElementDefined = customElements.get('personalise-dialog');
              
              if (isCustomElementDefined) {
                // Try using the showDialog method (pass variant so modal syncs to current selection)
                if (typeof dialog.showDialog === 'function') {
                  try {
                    dialog.showDialog(variantIdFromForm);
                    return; // Success!
                  } catch (err) {
                    // Continue to fallback
                  }
                }
              }
              
              // Fallback: try opening the inner dialog element directly
              const innerDialog = dialog.querySelector && dialog.querySelector('dialog');
              if (innerDialog && typeof innerDialog.showModal === 'function') {
                try {
                  innerDialog.showModal();
                  return; // Success!
                } catch (err) {
                  // Continue to retry
                }
              }
            }
            
            // If not found and we haven't exceeded attempts, try again
            if (attempts < maxAttempts) {
              setTimeout(function() {
                tryOpenDialog(attempts + 1);
              }, 100);
            }
            // Silently fail after max attempts - no errors logged
          } catch (err) {
            // Silently catch any errors - absolutely no logging
          }
        }
        
        tryOpenDialog(0);
      } catch (err) {
        // Silently handle any outer errors
      }
    }
    
    // Initialize event listener when DOM is ready
    function init() {
      try {
        // Check if personalise button exists before adding listener
        const hasButton = document.querySelector('[data-personalise-button]');
        if (hasButton) {
          document.addEventListener('click', handlePersonaliseClick, true);
        }
      } catch (err) {
        // Silently handle initialization errors
      }
    }
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM already ready, wait a bit to ensure custom elements are loaded
      setTimeout(init, 100);
    }
  })();
</script>

<script>
  // Function to update button text based on personalization state
  // Only define once to avoid conflicts
  if (!window.updatePersonaliseButtonText) {
    window.updatePersonaliseButtonText = function(updatedFormFromEvent) {
      try {
        // Try multiple ways to get product ID
        let productId = document.querySelector('product-form-component')?.dataset?.productId;
        if (!productId) {
          productId = document.querySelector('sticky-add-to-cart')?.dataset?.productId;
        }
        if (!productId) {
          // Try to get from the button's closest product-form-component
          const button = document.querySelector('[data-personalise-button]');
          if (button) {
            productId = button.closest('product-form-component')?.dataset?.productId || 
                        button.closest('sticky-add-to-cart')?.dataset?.productId;
          }
        }
        
        // Find all forms that might contain personalization
        const allForms = [];
        
        // Find form by product ID
        if (productId) {
          const productFormComponents = document.querySelectorAll('product-form-component');
          productFormComponents.forEach(formComponent => {
            const compProductId = formComponent.dataset?.productId || formComponent.dataset?.productId;
            if (compProductId === productId || compProductId === String(productId)) {
              // CRITICAL: Exclude forms that are in quick-add modal (they should be handled separately)
              const quickAddModal = document.querySelector('#quick-add-modal-content');
              if (quickAddModal && quickAddModal.contains(formComponent)) {
                return; // Skip this form - it's in quick-add modal
              }
              
              const compForm = formComponent.querySelector('form[data-type="add-to-cart-form"]');
              if (compForm && !allForms.includes(compForm)) {
                allForms.push(compForm);
              }
            }
          });
        }
        
        // Also check sticky-add-to-cart (but not if it's in quick-add modal)
        const stickyCart = document.querySelector('sticky-add-to-cart');
        if (stickyCart) {
          const quickAddModal = document.querySelector('#quick-add-modal-content');
          if (!quickAddModal || !quickAddModal.contains(stickyCart)) {
            const stickyForm = stickyCart.querySelector('form[data-type="add-to-cart-form"]');
            if (stickyForm && !allForms.includes(stickyForm)) {
              allForms.push(stickyForm);
            }
          }
        }
        
        // Fallback: find any form (but exclude quick-add modal forms)
        if (allForms.length === 0) {
          const quickAddModal = document.querySelector('#quick-add-modal-content');
          const allFormsOnPage = document.querySelectorAll('form[data-type="add-to-cart-form"]');
          allFormsOnPage.forEach(anyForm => {
            // Skip forms in quick-add modal
            if (!quickAddModal || !quickAddModal.contains(anyForm)) {
              allForms.push(anyForm);
            }
          });
        }
        
        // If we have a form from the event, prioritize it (but not if it's in quick-add modal)
        if (updatedFormFromEvent && !allForms.includes(updatedFormFromEvent)) {
          const quickAddModal = document.querySelector('#quick-add-modal-content');
          if (!quickAddModal || !quickAddModal.contains(updatedFormFromEvent)) {
            allForms.unshift(updatedFormFromEvent); // Add to beginning to check first
          }
        }
        
        // Read personalisation from form inputs
        const personalisation = {};
        for (const form of allForms) {
          if (!form) continue;
          
          // Read all personalisation fields
          const nameInput = form.querySelector('input[name="properties[Name]"]');
          if (nameInput && nameInput.value.trim()) {
            personalisation.name = nameInput.value.trim();
          }
          
          const name1Input = form.querySelector('input[name="properties[Name 1]"]');
          if (name1Input && name1Input.value.trim()) {
            personalisation.name1 = name1Input.value.trim();
          }
          
          const name2Input = form.querySelector('input[name="properties[Name 2]"]');
          if (name2Input && name2Input.value.trim()) {
            personalisation.name2 = name2Input.value.trim();
          }
          
          const name3Input = form.querySelector('input[name="properties[Name 3]"]');
          if (name3Input && name3Input.value.trim()) {
            personalisation.name3 = name3Input.value.trim();
          }
          
          const name4Input = form.querySelector('input[name="properties[Name 4]"]');
          if (name4Input && name4Input.value.trim()) {
            personalisation.name4 = name4Input.value.trim();
          }
          
          const dobInput = form.querySelector('input[name="properties[Date of Birth]"]');
          if (dobInput && dobInput.value.trim()) {
            personalisation.dob = dobInput.value.trim();
          }
          
          const optionalDobInput = form.querySelector('input[name="properties[Personalise Date of Birth]"]');
          if (optionalDobInput && optionalDobInput.value.trim()) {
            personalisation.optionalDob = optionalDobInput.value.trim();
          }
          
          const schoolYearInput = form.querySelector('input[name="properties[School Year]"]');
          if (schoolYearInput && schoolYearInput.value.trim()) {
            personalisation.schoolYear = schoolYearInput.value.trim();
          }
          
          const babyNameInput = form.querySelector('input[name="properties[Baby\'s Name]"]');
          if (babyNameInput && babyNameInput.value.trim()) {
            personalisation.babyName = babyNameInput.value.trim();
          }
          
          const kidNameInput = form.querySelector('input[name="properties[Kid\'s Name]"]');
          if (kidNameInput && kidNameInput.value.trim()) {
            personalisation.kidName = kidNameInput.value.trim();
          }
          
          const mumNameInput = form.querySelector('input[name="properties[Mum\'s Name]"]');
          if (mumNameInput && mumNameInput.value.trim()) {
            personalisation.mumName = mumNameInput.value.trim();
          }
          
          const colorInput = form.querySelector('input[name="properties[Text Color]"]:checked') || 
                             form.querySelector('input[name="properties[Text Color]"]');
          if (colorInput && colorInput.value.trim()) {
            personalisation.color = colorInput.value.trim();
          }
          
          const fontInput = form.querySelector('input[name="properties[Text Font]"]:checked') || 
                            form.querySelector('input[name="properties[Text Font]"]');
          if (fontInput && fontInput.value.trim()) {
            personalisation.font = fontInput.value.trim();
          }
          
          const textboxInput = form.querySelector('textarea[name="properties[Personalisation:]"]');
          if (textboxInput && textboxInput.value.trim()) {
            personalisation.textbox = textboxInput.value.trim();
          }
          
          const messageInput = form.querySelector('textarea[name="properties[Message]"]');
          if (messageInput && messageInput.value.trim()) {
            personalisation.message = messageInput.value.trim();
          }
          
          const timeInput = form.querySelector('input[name="properties[Time]"]');
          if (timeInput && timeInput.value.trim()) {
            personalisation.time = timeInput.value.trim();
          }
          
          const weightInput = form.querySelector('input[name="properties[Weight]"]');
          if (weightInput && weightInput.value.trim()) {
            personalisation.weight = weightInput.value.trim();
          }
          
          // If we found any personalization, we can stop checking
          if (Object.keys(personalisation).length > 0) {
            break;
          }
        }
        
        const hasPersonalisation = Object.keys(personalisation).length > 0;
        
        const buttons = document.querySelectorAll('[data-personalise-button]');
        console.log('Found buttons:', buttons.length, 'Has personalisation:', hasPersonalisation);
        
        buttons.forEach(button => {
          // CRITICAL: Check if button is in quick-add modal - if so, only read from that modal's forms
          const buttonQuickAddModal = button.closest('#quick-add-modal-content');
          let buttonPersonalisation = {};
          
          if (buttonQuickAddModal) {
            // Button is in quick-add modal - ONLY check forms within that modal
            const quickAddForms = buttonQuickAddModal.querySelectorAll('form[data-type="add-to-cart-form"]');
            for (const qForm of quickAddForms) {
              if (!qForm) continue;
              
              // Get product ID from the form's product-form-component
              const qFormComponent = qForm.closest('product-form-component');
              const qFormProductId = qFormComponent?.dataset?.productId;
              
              // Read personalisation from this form
              const nameInput = qForm.querySelector('input[name="properties[Name]"]');
              if (nameInput && nameInput.value.trim()) {
                buttonPersonalisation.name = nameInput.value.trim();
              }
              
              const colorInput = qForm.querySelector('input[name="properties[Text Color]"]:checked') || 
                                 qForm.querySelector('input[name="properties[Text Color]"]');
              if (colorInput && colorInput.value.trim()) {
                buttonPersonalisation.color = colorInput.value.trim();
              }
              
              const fontInput = qForm.querySelector('input[name="properties[Text Font]"]:checked') || 
                                qForm.querySelector('input[name="properties[Text Font]"]');
              if (fontInput && fontInput.value.trim()) {
                buttonPersonalisation.font = fontInput.value.trim();
              }
              
              // Read other fields too...
              const babyNameInput = qForm.querySelector('input[name="properties[Baby\'s Name]"]');
              if (babyNameInput && babyNameInput.value.trim()) {
                buttonPersonalisation.babyName = babyNameInput.value.trim();
              }
              
              const kidNameInput = qForm.querySelector('input[name="properties[Kid\'s Name]"]');
              if (kidNameInput && kidNameInput.value.trim()) {
                buttonPersonalisation.kidName = kidNameInput.value.trim();
              }
              
              const mumNameInput = qForm.querySelector('input[name="properties[Mum\'s Name]"]');
              if (mumNameInput && mumNameInput.value.trim()) {
                buttonPersonalisation.mumName = mumNameInput.value.trim();
              }
              
              // Read all other personalization fields
              const name1Input = qForm.querySelector('input[name="properties[Name 1]"]');
              if (name1Input && name1Input.value.trim()) {
                buttonPersonalisation.name1 = name1Input.value.trim();
              }
              
              const name2Input = qForm.querySelector('input[name="properties[Name 2]"]');
              if (name2Input && name2Input.value.trim()) {
                buttonPersonalisation.name2 = name2Input.value.trim();
              }
              
              const name3Input = qForm.querySelector('input[name="properties[Name 3]"]');
              if (name3Input && name3Input.value.trim()) {
                buttonPersonalisation.name3 = name3Input.value.trim();
              }
              
              const name4Input = qForm.querySelector('input[name="properties[Name 4]"]');
              if (name4Input && name4Input.value.trim()) {
                buttonPersonalisation.name4 = name4Input.value.trim();
              }
              
              const dobInput = qForm.querySelector('input[name="properties[Date of Birth]"]');
              if (dobInput && dobInput.value.trim()) {
                buttonPersonalisation.dob = dobInput.value.trim();
              }
              
              const optionalDobInput = qForm.querySelector('input[name="properties[Personalise Date of Birth]"]');
              if (optionalDobInput && optionalDobInput.value.trim()) {
                buttonPersonalisation.optionalDob = optionalDobInput.value.trim();
              }
              
              const schoolYearInput = qForm.querySelector('input[name="properties[School Year]"]');
              if (schoolYearInput && schoolYearInput.value.trim()) {
                buttonPersonalisation.schoolYear = schoolYearInput.value.trim();
              }
              
              const textboxInput = qForm.querySelector('textarea[name="properties[Personalisation:]"]');
              if (textboxInput && textboxInput.value.trim()) {
                buttonPersonalisation.textbox = textboxInput.value.trim();
              }
              
              const messageInput = qForm.querySelector('textarea[name="properties[Message]"]');
              if (messageInput && messageInput.value.trim()) {
                buttonPersonalisation.message = messageInput.value.trim();
              }
              
              const timeInput = qForm.querySelector('input[name="properties[Time]"]');
              if (timeInput && timeInput.value.trim()) {
                buttonPersonalisation.time = timeInput.value.trim();
              }
              
              const weightInput = qForm.querySelector('input[name="properties[Weight]"]');
              if (weightInput && weightInput.value.trim()) {
                buttonPersonalisation.weight = weightInput.value.trim();
              }
              
              // If we found any personalization, we can stop checking
              if (Object.keys(buttonPersonalisation).length > 0) {
                break;
              }
            }
          } else {
            // Button is NOT in quick-add modal - use the personalisation we already read
            buttonPersonalisation = personalisation;
          }
          
          const textSpan = button.querySelector('[data-personalise-text]');
          const summarySpan = button.querySelector('[data-personalise-summary]');
          
          // Find the confirmation checkbox container
          // Try multiple methods to find it
          let confirmationContainer = button.nextElementSibling;
          if (!confirmationContainer || !confirmationContainer.classList?.contains('personalise-confirmation')) {
            // Try finding in the same parent
            confirmationContainer = button.parentElement?.querySelector('[data-personalise-confirmation]');
          }
          if (!confirmationContainer) {
            // Try finding in the product form buttons container (product page)
            const formButtons = button.closest('.product-form-buttons');
            if (formButtons) {
              confirmationContainer = formButtons.querySelector('[data-personalise-confirmation]');
            }
          }
          
          if (textSpan) {
            // Use button-specific personalisation if button is in quick-add modal, otherwise use global personalisation
            const buttonHasPersonalisation = Object.keys(buttonPersonalisation).length > 0;
            const personalisationToUse = buttonQuickAddModal ? buttonPersonalisation : personalisation;
            const hasPersonalisationToUse = buttonQuickAddModal ? buttonHasPersonalisation : hasPersonalisation;
            
            if (hasPersonalisationToUse) {
              try {
                
                // Format the summary: "Personalised: {name} | {date} ({color})"
                // Include all active personalization fields
                const parts = [];
                if (personalisationToUse.name) {
                  parts.push(personalisationToUse.name);
                }
                if (personalisationToUse.name1) {
                  parts.push(personalisationToUse.name1);
                }
                if (personalisationToUse.name2) {
                  parts.push(personalisationToUse.name2);
                }
                if (personalisationToUse.name3) {
                  parts.push(personalisationToUse.name3);
                }
                if (personalisationToUse.name4) {
                  parts.push(personalisationToUse.name4);
                }
                if (personalisationToUse.dob) {
                  parts.push(personalisationToUse.dob);
                }
                if (personalisationToUse.optionalDob) {
                  parts.push(personalisationToUse.optionalDob);
                }
                if (personalisationToUse.schoolYear) {
                  parts.push(personalisationToUse.schoolYear);
                }
                // Add baby/kid/mum names
                if (personalisationToUse.babyName && typeof personalisationToUse.babyName === 'string' && personalisationToUse.babyName.trim()) {
                  parts.push('Baby: ' + personalisationToUse.babyName);
                }
                if (personalisationToUse.kidName && typeof personalisationToUse.kidName === 'string' && personalisationToUse.kidName.trim()) {
                  parts.push('Kid: ' + personalisationToUse.kidName);
                }
                if (personalisationToUse.mumName && typeof personalisationToUse.mumName === 'string' && personalisationToUse.mumName.trim()) {
                  parts.push('Mum: ' + personalisationToUse.mumName);
                }
                // Add font to parts
                if (personalisationToUse.font) {
                  parts.push('Font: ' + personalisationToUse.font);
                }
                const colorText = personalisationToUse.color || '';
                
                let summaryText = 'Personalised:';
                if (parts.length > 0) {
                  summaryText += ' ' + parts.join(' | ');
                }
                if (colorText) {
                  summaryText += ' (' + colorText + ')';
                }
                
                // Show summary and update text
                if (summarySpan) {
                  summarySpan.textContent = summaryText;
                  summarySpan.style.display = '';
                  button.classList.add('has-summary');
                }
                textSpan.textContent = 'EDIT';
                
                // Show and update confirmation checkbox
                if (confirmationContainer) {
                  const confirmTextSpan = confirmationContainer.querySelector('[data-personalise-confirm-text]');
                  if (confirmTextSpan) {
                    // Build dynamic label based on ALL available fields
                    const fields = [];
                    if (personalisationToUse.name) {
                      fields.push('name');
                    }
                    if (personalisationToUse.name1) {
                      fields.push('name1');
                    }
                    if (personalisationToUse.name2) {
                      fields.push('name2');
                    }
                    if (personalisationToUse.name3) {
                      fields.push('name3');
                    }
                    if (personalisationToUse.name4) {
                      fields.push('name4');
                    }
                    if (personalisationToUse.dob || personalisationToUse.optionalDob) {
                      fields.push('date');
                    }
                    if (personalisationToUse.color) {
                      fields.push('colour');
                    }
                    if (personalisationToUse.font) {
                      fields.push('font');
                    }
                    if (personalisationToUse.schoolYear) {
                      fields.push('school year');
                    }
                    if (personalisationToUse.textbox) {
                      fields.push('text');
                    }
                    if (personalisationToUse.message) {
                      fields.push('message');
                    }
                    if (personalisationToUse.time) {
                      fields.push('time');
                    }
                    if (personalisationToUse.weight) {
                      fields.push('weight');
                    }
                    
                    let labelText = 'I confirm that the personalisation';
                    if (fields.length > 0) {
                      if (fields.length === 1) {
                        labelText += ' (' + fields[0] + ')';
                      } else if (fields.length === 2) {
                        labelText += ' (' + fields[0] + ' and ' + fields[1] + ')';
                      } else {
                        labelText += ' (' + fields.slice(0, -1).join(', ') + ', and ' + fields[fields.length - 1] + ')';
                      }
                    }
                    labelText += ' is correct.';
                    confirmTextSpan.innerHTML = labelText + '<br>No changes can be made once it is confirmed.';
                  }
                  confirmationContainer.style.display = 'block';
                  console.log('Confirmation container displayed');
                } else {
                  console.log('Confirmation container not found for button');
                }
                
                console.log('Updated button to show summary and EDIT');
              } catch (e) {
                console.error('Error parsing personalisation:', e);
                // Fallback: just show EDIT
                if (summarySpan) {
                  summarySpan.style.display = 'none';
                  button.classList.remove('has-summary');
                }
                textSpan.textContent = 'EDIT';
                if (confirmationContainer) {
                  confirmationContainer.style.display = 'none';
                }
              }
            } else {
              // Hide summary and show PERSONALISE IT
              if (summarySpan) {
                summarySpan.style.display = 'none';
                button.classList.remove('has-summary');
              }
              textSpan.textContent = 'PERSONALISE IT';
              if (confirmationContainer) {
                confirmationContainer.style.display = 'none';
              }
              console.log('Updated button to PERSONALISE IT');
            }
          } else {
            console.log('Text span not found in button');
          }
        });
      } catch (error) {
        console.error('Error updating personalise button text:', error);
      }
    };
  }
  
  // Use shared debounce with buy-buttons to avoid duplicate updates (and flashing)
  var _piDebounceMs = 400;
  function handlePersonalisationSaved(event) {
    var now = Date.now();
    if (window.__lastPersonalisationSavedHandledAt && (now - window.__lastPersonalisationSavedHandledAt) < _piDebounceMs) return;
    window.__lastPersonalisationSavedHandledAt = now;
    var updatedForm = event.detail && event.detail.form;
    setTimeout(function() {
      if (window.updatePersonaliseButtonText) window.updatePersonaliseButtonText(updatedForm);
    }, 100);
  }

  // Handle variant update - update personalization button text after variant changes
  function handleVariantUpdate(event) {
    // Wait a bit for DOM to update after variant change
    setTimeout(() => {
      if (window.updatePersonaliseButtonText) {
        // Get the form that might have been updated
        const productId = event.detail?.data?.productId;
        let form = null;
        
        if (productId) {
          const productFormComponent = document.querySelector(`product-form-component[data-product-id="${productId}"]`);
          if (productFormComponent) {
            form = productFormComponent.querySelector('form[data-type="add-to-cart-form"]');
          }
        }
        
        // Fallback: find any form
        if (!form) {
          form = document.querySelector('form[data-type="add-to-cart-form"]');
        }
        
        window.updatePersonaliseButtonText(form);
        
        // Also update add to cart button state after updating personalization button
        // This ensures the button is disabled if personalization is present but not confirmed
        if (window.updateAddToCartButtonState) {
          setTimeout(() => {
            window.updateAddToCartButtonState();
          }, 100);
        }
      }
    }, 150);
  }
  
  try {
    document.addEventListener('personalisation-saved', handlePersonalisationSaved);
    var sectionEl = document.querySelector('.shopify-section');
    if (sectionEl) sectionEl.addEventListener('variant:update', handleVariantUpdate);
  } catch (e) {
    console.error('Error setting up personalise button listeners:', e);
  }
</script>

{% render 'product-information-content',
  product_media_size: closest.product.media.size,
  section_id: section.id,
  settings: section.settings,
  media_gallery: media_gallery,
  product_details: product_details,
  additional_blocks: additional_blocks
%}

{% stylesheet %}
  .sticky-add-to-cart__bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    opacity: 0;
    transform: translateY(100%);
    z-index: calc(var(--layer-sticky) - 1); /* Below sticky header */
    display: block;
    width: 100%;
    border-radius: 0;
    box-shadow: var(--shadow-popover);
    padding: var(--padding-md);
    background-color: #F8F3ED;
    /* Layout styling */
    display: flex;
    align-items: center;
    justify-content: center;

    @starting-style {
      opacity: 0;
      transform: translateY(100%);
    }

    &::before {
      --border: 2px;
      content: '';
      position: absolute;
      inset: calc(var(--border) * -1);
      background: linear-gradient(#F8F3ED 0 100%), linear-gradient(hsl(0 0% 0% / 0.15) 0 100%);
      
      
      border-radius: inherit;
      z-index: -1;
      backdrop-filter: blur(20px) saturate(180%) brightness(1.5);
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    .sticky-add-to-cart__bar {
      transition-property: transform, opacity, display;
      transition-duration: 0.3s;
      transition-timing-function: var(--ease-out-quad);
      transition-behavior: allow-discrete;
    }
  }

  .sticky-add-to-cart__bar[data-stuck='true'] {
    transform: translateY(0%);
    opacity: 1;
  }

  sticky-add-to-cart:not([data-variant-available='true']) .sticky-add-to-cart__bar {
    opacity: 0;
    transform: translateY(100%);
    display: none;
  }

  .sticky-add-to-cart__content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--gap-lg);
    width: 100%;
    max-width: var(--page-content-width);
    margin: 0 auto;
    min-width: 0;
  }

  .sticky-add-to-cart__product-info {
    display: flex;
    align-items: center;
    gap: var(--gap-md);
    min-width: 0;
  }

  .sticky-add-to-cart__info {
    flex: 1;
    min-width: 0;
  }

  .sticky-add-to-cart__image {
    flex-shrink: 0;
    aspect-ratio: 1;
    height: var(--height-buy-buttons);
    width: var(--height-buy-buttons);
    overflow: hidden;
    border-radius: var(--style-border-radius-buttons-primary);
    background: var(--color-background-secondary);
    display: block;
  }

  .sticky-add-to-cart__image-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sticky-add-to-cart__title {
    font-size: var(--font-paragraph-medium--size);
    font-weight: var(--font-weight-semibold);
    margin: 0;
    margin-bottom: var(--margin-2xs);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .sticky-add-to-cart__price {
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-paragraph-medium--size);
    margin: 0;
  }

  .sticky-add-to-cart__actions {
    display: flex;
    flex-direction: row;
    gap: var(--gap-sm);
    flex-shrink: 0;
    align-items: stretch;
    width: 50%;
  }

  .sticky-add-to-cart__button {
    height: var(--height-buy-buttons);
    position: relative;
    text-transform: uppercase !important;
    background-color: #7295BB !important;
    color: #ffffff !important;
    border: none !important;
    font-weight: 500;
    width: 100%;
  }

  .sticky-add-to-cart__button:hover:not(:disabled) {
    background-color: #5a7a9a !important;
    color: #ffffff !important;
  }

  .sticky-add-to-cart__button:disabled {
    background-color: #cccccc !important;
    color: #666666 !important;
    cursor: not-allowed;
  }

  .sticky-add-to-cart__personalise-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: var(--padding-md) var(--padding-lg);
    background-color: transparent;
    border: 1px solid #7295BB;
    border-radius: 0;
    color: #7295BB;
    text-transform: uppercase;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: var(--height-buy-buttons);
  }
  
  /* When summary is visible, space between left and right */
  .sticky-add-to-cart__personalise-button.has-summary {
    justify-content: space-between;
  }
  
  .sticky-add-to-cart__personalise-button .icon-tex-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .sticky-add-to-cart__personalise-button:hover {
    background-color: transparent;
    border-color: #7295BB;
    color: #7295BB;
  }

  .sticky-add-to-cart__personalise-button .personalise-button__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .sticky-add-to-cart__personalise-button .personalise-button__icon svg {
    width: 100%;
    height: 100%;
  }

  .sticky-add-to-cart__personalise-button .personalise-button__text {
    line-height: 1;
  }

  .sticky-add-to-cart__personalise-button .personalise-button__summary {
    display: inline-block;
    margin-right: var(--margin-sm);
    flex-shrink: 0;
    color: #1D425A;
    font-size: var(--font-size--sm);
    font-weight: 400;
    line-height: 1.4;
    text-transform: none;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }


  /* Mobile adjustments */
  @media screen and (max-width: 749px) {
    .sticky-add-to-cart__bar {
      padding: var(--padding-sm);
    }

    .sticky-add-to-cart__content {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: var(--gap-sm);
    }

    /* Hide product info (image, title, price) on mobile */
    .sticky-add-to-cart__product-info {
      display: none;
    }

    .sticky-add-to-cart__actions {
      width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: row;
      gap: var(--gap-sm);
      align-items: stretch;
    }

    .sticky-add-to-cart__personalise-button {
      flex: 0 1 auto;
      min-width: 0;
      width: auto;
      padding-left: 8px;
      padding-right: 8px;
      font-size: 16px;
    }

    .sticky-add-to-cart__personalise-button .icon-tex-container {
      min-width: 0;
      flex: 1 1 auto;
    }

    .sticky-add-to-cart__personalise-button .personalise-button__text,
    .sticky-add-to-cart__personalise-button .personalise-button__summary {
      display: inline-block;
      white-space: normal;
    }

    .sticky-add-to-cart__button {
      flex: 1 1 0;
      min-width: 0;
      width: auto;
      font-size: 16px;
    }

    .add-to-cart-text__content {
      display: block;
    }

    sticky-add-to-cart:not([data-variant-available='true']) .add-to-cart-text__content {
      display: initial;
    }

    sticky-add-to-cart:not([data-variant-available='true']) .sticky-add-to-cart__button {
      width: auto;
    }
  }

  /* Small mobile - hide text content and compare price */
  @media screen and (max-width: 389px) {
    .sticky-add-to-cart__bar {
      .compare-at-price {
        display: none;
      }
    }

    .sticky-add-to-cart__title {
      display: none;
    }

    /* For product with only default variant show title */
    .sticky-add-to-cart__info[data-singleton='true'] .sticky-add-to-cart__title {
      display: block;
    }

    /* For single variant show title and variant, truncate both. variant should be identifiable with truncation */
    .sticky-add-to-cart__info[data-single-option='true'] .sticky-add-to-cart__title {
      display: block;
    }
    .sticky-add-to-cart__info[data-single-option='true'] .sticky-add-to-cart__variant {
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_information",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "t:options.page"
        },
        {
          "value": "content-full-width",
          "label": "t:options.full"
        }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "t:settings.media_position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "t:settings.equal_columns",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "t:settings.limit_product_details_width",
      "default": false,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "t:settings.enable_sticky_add_to_cart",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
