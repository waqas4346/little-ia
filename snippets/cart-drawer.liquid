{%- doc -%}
  Renders the cart drawer, a slide-out panel that displays the contents of the cart. It includes the cart icon that acts as a trigger.

  @param {object} [settings] - An object containing theme settings.

  @param {boolean} [settings.auto_open_cart_drawer] - If `true`, the cart drawer opens automatically after an item is
  added.
  @param {string} [settings.drawer_color_scheme] - The color scheme for the drawer.
{%- enddoc -%}

<script
  src="{{ 'cart-drawer.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>
<script
  src="{{ 'cart-drawer-recommendations.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

<cart-drawer-component
  class="cart-drawer"
  {{ block.shopify_attributes }}
  {% if settings.auto_open_cart_drawer %}
    auto-open
  {% endif %}
>
  <button
    class="button header-actions__action button-unstyled"
    on:click="/open"
    aria-haspopup="dialog"
    aria-label="{{ 'accessibility.cart' | t }}"
    aria-describedby="cart-bubble-text"
    data-testid="cart-drawer-trigger"
  >
    {% render 'cart-icon-component' %}
  </button>

  <dialog
    ref="dialog"
    class="cart-drawer__dialog dialog-modal dialog-drawer color-{{ settings.drawer_color_scheme }}{% if cart.empty? %} cart-drawer--empty{%endif%}"
    aria-labelledby="{% if cart.empty? %}cart-drawer-heading-empty{% else %}cart-drawer-heading{% endif %}"
    scroll-lock
  >
    <div class="cart-drawer__inner">
      <cart-items-component
        class="cart-items-component"
        data-section-id="{{ section.id }}"
      >
        {%- if cart.empty? -%}
          <div class="cart-drawer__header">
            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button close-button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          <div
            class="cart-drawer__content motion-reduce"
            aria-label="{{ 'accessibility.cart' | t }}"
          >
            <h2
              class="cart-drawer__heading h3 cart-drawer__heading--empty"
              id="cart-drawer-heading-empty"
            >
              {{ 'content.your_cart_is_empty' | t }}
            </h2>

            <div class="cart-drawer__items">
              {% render 'cart-products', drawer_context: 'drawer' %}
            </div>
          </div>
        {%- else -%}
          <div
            class="cart-drawer__header"
            id="cart-drawer-header"
          >
            <h2
              class="cart-drawer__heading h3"
              id="cart-drawer-heading"
            >
              {{ 'content.cart_title' | t }}
              <span class="cart-drawer__item-count">
                ({{ cart.item_count }} Items)
              </span>
            </h2>

            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button close-button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          {% if settings.show_free_shipping_progress %}
            {% render 'free-shipping-progress' %}
          {% endif %}

          <div
            class="cart-drawer__content motion-reduce"
            aria-label="{{ 'accessibility.cart' | t }}"
            style="--header-height: 60px;"
          >
            <scroll-hint
              class="cart-drawer__items"
            >
              {% render 'cart-products', drawer_context: 'drawer' %}
            </scroll-hint>

            {%- liquid
              assign gift_wrap_product = settings.gift_wrap_product
              assign show_gift_wrap_prompt = false

              if gift_wrap_product != blank and cart.items.size > 0
                assign has_non_gift_items = false
                assign has_gift_wrap_in_cart = false

                for item in cart.items
                  if item.product_id == gift_wrap_product.id
                    assign has_gift_wrap_in_cart = true
                  else
                    assign has_non_gift_items = true
                  endif
                endfor

                if has_non_gift_items and has_gift_wrap_in_cart == false
                  assign show_gift_wrap_prompt = true
                endif
              endif
            -%}

            {%- if show_gift_wrap_prompt -%}
              <div class="cart-drawer-gift-wrap" data-cart-drawer-gift-wrap>
                <div class="cart-drawer-gift-wrap__media">
                  {%- if gift_wrap_product.featured_media -%}
                    {{
                      gift_wrap_product.featured_media
                      | image_url: width: 160
                      | image_tag: loading: 'lazy', class: 'cart-drawer-gift-wrap__image', alt: gift_wrap_product.title
                    }}
                  {%- endif -%}
                </div>
                <div class="cart-drawer-gift-wrap__details">
                  <p class="cart-drawer-gift-wrap__title">{{ gift_wrap_product.title }}</p>
                  <p class="cart-drawer-gift-wrap__price">{{ gift_wrap_product.price | money }}</p>
                  <div class="cart-drawer-gift-wrap__actions">
                    <button
                      type="button"
                      class="button cart-drawer-gift-wrap__add"
                      data-add-gift-wrap-drawer
                      data-gift-variant-id="{{ gift_wrap_product.selected_or_first_available_variant.id }}"
                      aria-label="Add {{ gift_wrap_product.title | escape }}"
                    >
                      Add
                    </button>
                    <span class="cart-drawer-gift-wrap__remove" aria-hidden="true">Remove</span>
                  </div>
                </div>
              </div>
            {%- endif -%}

            {% render 'cart-drawer-recommendations' %}

            <div
              class="cart-drawer__summary"
            >
              <div class="cart-drawer__summary-inner">
                {% render 'cart-summary' %}
              </div>
            </div>
          </div>
          
          {%- comment -%} Personalise Modal for cart editing {%- endcomment -%}
          {%- if cart.items.size > 0 -%}
            {%- assign first_item_with_personalization = null -%}
            {%- for item in cart.items -%}
              {%- liquid
                assign has_personalization = false
                assign personalization_keys = "Name,Name 1,Name 2,Name 3,Name 4,Baby's Name,Kid's Name,Mum's Name,Date of Birth,Personalise Date of Birth,Text Color,Text Font,School Year,Personalisation:,Message,Time,Weight" | split: ','
                for property in item.properties
                  assign property_first_char = property.first | slice: 0
                  if property.last != blank and property_first_char != '_'
                    for key in personalization_keys
                      if property.first == key
                        assign has_personalization = true
                        break
                      endif
                    endfor
                  endif
                  if has_personalization
                    break
                  endif
                endfor
              -%}
              {%- if has_personalization and first_item_with_personalization == null -%}
                {%- assign first_item_with_personalization = item -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if first_item_with_personalization -%}
              {% render 'personalise-modal', product: first_item_with_personalization.product, variant: first_item_with_personalization.variant, context: 'cart-drawer' %}
              <script src="{{ 'personalise-modal.js' | asset_url }}" type="module"></script>
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
      </cart-items-component>
    </div>
  </dialog>
</cart-drawer-component>

{% javascript %}
  const giftWrapButtonSelector = '[data-add-gift-wrap-drawer]';
  const loadingClass = 'is-loading';

  document.addEventListener('click', async (event) => {
    const button = event.target.closest(giftWrapButtonSelector);
    if (!(button instanceof HTMLButtonElement)) return;

    event.preventDefault();
    if (button.disabled) return;

    const variantId = button.dataset.giftVariantId;
    if (!variantId) return;

    const sectionIds = Array.from(document.querySelectorAll('cart-items-component[data-section-id]'))
      .map((element) => element.dataset.sectionId)
      .filter(Boolean);

    button.disabled = true;
    button.classList.add(loadingClass);

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: Number(variantId),
          quantity: 1,
          properties: {
            _gift_wrap_source: 'cart_drawer',
          },
          sections: sectionIds.join(','),
          sections_url: window.location.pathname,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to add gift wrap');
      }

      const responseData = await response.json();

      // Trigger cart re-render for all cart item sections.
      document.dispatchEvent(
        new CustomEvent('cart:update', {
          bubbles: true,
          detail: {
            sourceId: 'cart-drawer-gift-wrap',
            data: {
              source: 'cart-drawer-gift-wrap',
              sections: responseData?.sections || {},
            },
          },
        })
      );
    } catch (error) {
      console.error('Gift wrap add failed', error);
    } finally {
      button.disabled = false;
      button.classList.remove(loadingClass);
    }
  });
{% endjavascript %}

{% stylesheet %}
  .cart-items-component {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;

    .cart-items__variant dd {
      font-weight: 300;
    }

    .cart-items__table-row {
      column-gap: 6px;
      margin-bottom: 0px !important;
    }

    .cart-items__quantity {
      width: 100%;
    }

    .cart-items__quantity-controls {
      width: 100%;
      justify-content: space-between;
    }

    .quantity-selector {
      --quantity-selector-width: 72px;

      flex: 1 1 var(--quantity-selector-width);
    }

    .quantity-selector :is(.quantity-minus, .quantity-plus) {
      --minimum-touch-target: 26px;

      width: var(--minimum-touch-target);
      height: var(--minimum-touch-target);
    }

    .quantity-selector input[type=number] {
      --minimum-touch-target: 26px;
      max-width: calc(var(--quantity-selector-width) - var(--minimum-touch-target) * 2);
    }

    .cart-items__remove {
      width: unset;
      height: unset;
      color: #959595;
      font-weight: 400;
      font-size: 14px;
      line-height: 100%;
      text-decoration: underline;
    }
  }

  .cart-drawer__heading .cart-bubble {
    width: fit-content;
    border-radius: var(--style-border-radius-buttons-primary);
    aspect-ratio: auto;
    padding: var(--cart-padding);
  }

  .cart-drawer__heading .cart-bubble[data-maintain-ratio] {
    aspect-ratio: 1;
    min-width: 26px;
  }

  .cart-drawer__header {
    background-color: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--cart-drawer-padding);
    border-bottom: var(--style-border-width) solid none;
    position: sticky;
    top: 0;
    z-index: 1;
    border-bottom: 0.5px solid #DDDDDD;
    padding-top: 14px !important;
    padding-bottom: 14px !important;

    .close-button {
      right: 23px;
      width: unset;
      height: unset;
    }

    @media screen and (min-width: 750px) {
      padding: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer-gift-wrap {
    display: flex;
    gap: 12px;
    margin: 12px 0;
    padding: 12px;
    background: #ffffff;
    align-items: center;
  }

  .cart-drawer-gift-wrap__media {
    width: 88px;
    min-width: 88px;
    height: 88px;
  }

  .cart-drawer-gift-wrap__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .cart-drawer-gift-wrap__details {
    flex: 1;
    min-width: 0;
  }

  .cart-drawer-gift-wrap__title {
    margin: 0 0 6px;
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 16px;
    line-height: 140%;
    letter-spacing: 0;
    color: #1f364d;
  }

  .cart-drawer-gift-wrap__price {
    margin: 0 0 10px;
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 14px;
    line-height: 160%;
    letter-spacing: 0;
    color: #1f364d;
  }

  .cart-drawer-gift-wrap__actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .cart-drawer-gift-wrap__add {
    text-transform: uppercase;
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    font-size: 14.94px;
    line-height: 100%;
    letter-spacing: 0;
    padding: 4px 20px;
    background: #7f9ec3;
    border-color: #7f9ec3;
    color: #fff;
  }

  .cart-drawer-gift-wrap__add[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .cart-drawer-gift-wrap__remove {
    margin-left: auto;
    font-family: 'Outfit', sans-serif;
    font-weight: 400;
    font-size: 14px;
    line-height: 100%;
    letter-spacing: 0;
    vertical-align: middle;
    color: #8e8e8e;
    text-decoration: underline;
    text-decoration-style: solid;
    text-decoration-thickness: 5%;
    text-underline-offset: 0;
  }

  .cart-drawer__dialog {
    overflow: hidden;
  }

  .cart-drawer__inner {
    height: 100%;
    overflow: hidden;
  }

  .cart-drawer__content {
    height: calc(100% - var(--header-height));
    display: flex;
    flex-direction: column;
  }

  .cart-drawer__summary {
    background-color: var(--color-background);
    position: sticky;
    bottom: 0;
    z-index: 1;
  }
  .cart-drawer__summary-inner {
    width: 100%;
    padding: 15px;
  }
{% endstylesheet %}
