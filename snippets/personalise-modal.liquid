{%- doc -%}
  Renders a personalisation modal for product customization.

  @param {object} product - The product object
  @param {object} variant - The selected variant
{%- enddoc -%}

{% liquid
  assign product = product | default: closest.product
  assign variant = variant | default: product.selected_or_first_available_variant
  assign product_image = variant.featured_image | default: product.featured_media.preview_image | default: product.featured_image
  
  # Tag detection for personalization features
  assign product_tags_lowercase = product.tags | join: ' ' | downcase
  
  assign show_personalized = false
  assign personalized_textcolour = false
  assign personalized_name = false
  assign personalized_dob = false
  assign personalized_textbox = false
  
  for cust_tag in product.tags
    assign cust_tag_lowercase = cust_tag | downcase
    if cust_tag_lowercase contains 'cust_personalized'
      assign show_personalized = true
    endif
    if cust_tag_lowercase contains 'personalized_textcolor'
      assign personalized_textcolour = true
    endif
    if cust_tag_lowercase contains 'personalized_name'
      assign personalized_name = true
    endif
    if cust_tag_lowercase contains 'personalized_dob'
      assign personalized_dob = true
    endif
    if cust_tag_lowercase contains 'personalise_textbox'
      assign personalized_textbox = true
    endif
    if cust_tag_lowercase contains 'personalise_'
      assign maxlength = cust_tag_lowercase | split: '_'
    endif
  endfor
  
  # Determine character limit
  assign dynamic_max = 9
  if product.tags contains 'personalise_5'
    assign dynamic_max = 5
  elsif product.tags contains 'personalise_7'
    assign dynamic_max = 7
  elsif product.tags contains 'personalise_9'
    assign dynamic_max = 9
  endif
  
  # Check for font family tags
  assign font_family_feild = false
  for tag in product.tags
    if tag contains 'font_'
      assign font_family_feild = true
      break
    endif
  endfor
  
  # Check for baby_name, kid_name, mum_name tags
  assign has_baby_name = false
  assign has_kid_name = false
  assign has_mum_name = false
  
  for tag in product.tags
    assign tag_lowercase = tag | downcase
    if tag_lowercase == 'baby_name'
      assign has_baby_name = true
    endif
    if tag_lowercase == 'kid_name'
      assign has_kid_name = true
    endif
    if tag_lowercase == 'mum_name'
      assign has_mum_name = true
    endif
  endfor
  
  assign show_name_tabs = false
  if has_baby_name or has_kid_name or has_mum_name
    assign show_name_tabs = true
  endif
  
  # Generate unique ID based on context
  assign modal_id = 'personalise-dialog'
  if context == 'cart-drawer'
    assign modal_id = 'personalise-dialog-cart'
  endif

  # Dynamic personalization preview: show ONLY if selected variant has ALL required metafields OR product has ALL.
  # Required: cb_personalization_image AND cb_personalization_position (also check typo poisition).
  # Check selected variant first; if it has both, use variant. Else check product; if product has both, use product.
  assign show_cb_dynamic_preview = false
  assign cb_personalization_image_url = ''
  assign cb_personalization_position_json = ''

  assign variant_has_image = false
  assign variant_has_position = false
  assign variant_image_val = variant.metafields.custom.cb_personalization_image
  if variant_image_val != blank and variant_image_val.value != blank
    assign variant_has_image = true
  endif
  assign variant_pos_val = variant.metafields.custom.cb_personalization_position | default: variant.metafields.custom.cb_personalization_poisition
  if variant_pos_val != blank and variant_pos_val.value != blank
    assign variant_has_position = true
  endif

  assign product_has_image = false
  assign product_has_position = false
  assign product_image_val = product.metafields.custom.cb_personalization_image
  if product_image_val != blank and product_image_val.value != blank
    assign product_has_image = true
  endif
  assign product_pos_val = product.metafields.custom.cb_personalization_position | default: product.metafields.custom.cb_personalization_poisition
  if product_pos_val != blank and product_pos_val.value != blank
    assign product_has_position = true
  endif

  if variant_has_image and variant_has_position
    assign show_cb_dynamic_preview = true
    assign cb_personalization_image_url = variant_image_val.value | image_url: width: 600
    assign cb_personalization_position_json = variant_pos_val.value | json
  elsif product_has_image and product_has_position
    assign show_cb_dynamic_preview = true
    assign cb_personalization_image_url = product_image_val.value | image_url: width: 600
    assign cb_personalization_position_json = product_pos_val.value | json
  endif

  # Build variant/product cb personalization map for JS (used when variant changes)
  assign product_image_url = ''
  assign product_position_json = ''
  if product_has_image and product_has_position
    assign product_image_url = product_image_val.value | image_url: width: 600
    assign product_position_json = product_pos_val.value | json
  endif
  if product.featured_media
    assign product_fallback_image = product.featured_media.preview_image | default: product.featured_image | image_url: width: 600
  elsif product.featured_image
    assign product_fallback_image = product.featured_image | image_url: width: 600
  else
    assign product_fallback_image = ''
  endif
%}

<personalise-dialog id="{{ modal_id }}" data-context="{{ context | default: 'product-page' }}" data-product-id="{{ product.id }}"{% if show_cb_dynamic_preview %} data-cb-personalization-image="{{ cb_personalization_image_url }}" data-cb-personalization-position="{{ cb_personalization_position_json | escape }}"{% endif %}>
  {%- comment -%} Variant metafields for dynamic preview when variant changes - keyed by variant ID {%- endcomment -%}
  <script type="application/json" data-cb-personalization-variants>
    {
      "product": {
        "image": {{ product_image_url | json }},
        "position": {{ product_position_json | json }},
        "fallbackImage": {{ product_fallback_image | json }}
      },
      "variants": {
        {%- assign first_variant_entry = true -%}
        {%- for v in product.variants -%}
        {%- assign v_img = v.metafields.custom.cb_personalization_image -%}
        {%- assign v_pos = v.metafields.custom.cb_personalization_position | default: v.metafields.custom.cb_personalization_poisition -%}
        {%- if v_img != blank and v_img.value != blank and v_pos != blank and v_pos.value != blank -%}
        {%- unless first_variant_entry -%},{%- endunless -%}
        "{{ v.id }}": {
          "image": {{ v_img.value | image_url: width: 600 | json }},
          "position": {{ v_pos.value | json }}
        }
        {%- assign first_variant_entry = false -%}
        {%- endif -%}
        {%- endfor -%}
      },
      "variantFallbackImages": {
        {%- assign first_fb = true -%}
        {%- for v in product.variants -%}
        {%- if v.featured_image -%}
          {%- assign v_fb = v.featured_image | image_url: width: 600 -%}
        {%- else -%}
          {%- assign v_fb = product_fallback_image -%}
        {%- endif -%}
        {%- unless first_fb -%},{%- endunless -%}
        "{{ v.id }}": {{ v_fb | json }}
        {%- assign first_fb = false -%}
        {%- endfor -%}
      }
    }
  </script>
  <dialog
    class="personalise-modal dialog-modal"
    ref="dialog"
    scroll-lock
  >
    <button
      ref="closeButton"
      data-personalise-close="true"
      class="button button-unstyled close-button personalise-modal__close"
      aria-label="{{ 'accessibility.close_dialog' | t }}"
    >
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>

    <div class="personalise-modal__content">
      <!-- Mobile-only: Heading and Instructions above image -->
      <div class="personalise-modal__mobile-header">
        <h2 class="personalise-modal__title personalise-modal__title--mobile">
            <span class="personalise-modal__title-icon">
              <img src="{{ 'edit_image.png' | asset_url }}" alt="" width="16" height="16">

          </span>
          <span>Personalise Your Product</span>
        </h2>
        {% if show_name_tabs %}
          <p class="personalise-modal__instructions personalise-modal__instructions--mobile">
            Maximum 9 characters. No special characters.
          </p>
        {% elsif show_personalized or personalized_name or personalized_textbox %}
          {% if personalized_name %}
            <p class="personalise-modal__instructions personalise-modal__instructions--mobile">
              Maximum {{ dynamic_max }} characters. No special characters.
            </p>
          {% endif %}
        {% else %}
          <p class="personalise-modal__instructions personalise-modal__instructions--mobile">
            Maximum 9 characters. No special characters.
          </p>
        {% endif %}
      </div>

      <!-- Left Section: Product Preview (40%) -->
      <div class="personalise-modal__preview" ref="previewContainer">
        {% comment %} Dynamic preview (cb metafields) - always rendered for variant-switch updates, visibility toggled via JS {% endcomment %}
        <div class="personalise-modal__preview-image-wrap" data-cb-dynamic-wrap style="{% unless show_cb_dynamic_preview and cb_personalization_image_url != blank %}display: none;{% endunless %}">
          <img
            src="{{ cb_personalization_image_url | default: '' }}"
            alt="{{ product.title | escape }}"
            class="personalise-modal__preview-image personalise-modal__preview-image--dynamic"
            loading="lazy"
            width="600"
            height="600"
            ref="previewImage"
          >
          <div class="personalise-modal__preview-text-overlay" ref="previewTextOverlay" aria-hidden="true"></div>
        </div>
        {% if product_image %}
          {% liquid
            assign image_alt = product.title | escape
          %}
          <div data-cb-fallback-wrap style="{% if show_cb_dynamic_preview and cb_personalization_image_url != blank %}display: none;{% endif %}">
            {{
              product_image
              | image_url: width: 600
              | image_tag: loading: 'lazy', alt: image_alt, class: 'personalise-modal__preview-image'
            }}
          </div>
        {% endif %}
        {% unless product_image %}
          <div class="personalise-modal__preview-placeholder" data-cb-placeholder style="{% if show_cb_dynamic_preview and cb_personalization_image_url != blank %}display: none;{% endif %}">
            {{ product.title | escape }}
          </div>
        {% endunless %}
      </div>

      <!-- Right Section: Personalisation Form (60%) -->
      <div class="personalise-modal__form">
        <h2 class="personalise-modal__title">
          <span class="personalise-modal__title-icon">
            <img src="{{ 'edit_image.png' | asset_url }}" alt="" width="16" height="16">
          </span>
          <span>Personalise Your Product</span>
        </h2>

        {% if show_name_tabs %}
          <!-- Baby/Kid/Mum Name Tabs -->
          <p class="personalise-modal__instructions">
            Maximum 9 characters. No special characters.
          </p>
          <div class="personalise-name-tabs" data-name-tabs>
            <div class="personalise-name-tabs__tablist" role="tablist">
              {% assign first_tab_active = true %}
              {% if has_baby_name %}
                <button
                  type="button"
                  role="tab"
                  class="personalise-name-tabs__tab {% if first_tab_active %}is-active{% endif %}"
                  aria-selected="{% if first_tab_active %}true{% else %}false{% endif %}"
                  aria-controls="tab-panel-baby"
                  id="tab-baby"
                  data-tab="baby"
                  on:click="/switchNameTab"
                >
                  <span class="personalise-name-tabs__tab-text">Baby</span>
                  <span class="personalise-name-tabs__tab-icon personalise-name-tabs__tab-icon--check" data-tab-icon="baby" style="display: none;">
                    <img src="{{ 'icon-tick.svg' | asset_url }}" alt="" width="16" height="16">
                  </span>
                </button>
                {% assign first_tab_active = false %}
              {% endif %}
              {% if has_kid_name %}
                <button
                  type="button"
                  role="tab"
                  class="personalise-name-tabs__tab {% if first_tab_active %}is-active{% endif %}"
                  aria-selected="{% if first_tab_active %}true{% else %}false{% endif %}"
                  aria-controls="tab-panel-kid"
                  id="tab-kid"
                  data-tab="kid"
                  on:click="/switchNameTab"
                >
                  <span class="personalise-name-tabs__tab-text">Kid</span>
                  <span class="personalise-name-tabs__tab-icon personalise-name-tabs__tab-icon--check" data-tab-icon="kid" style="display: none;">
                    <img src="{{ 'icon-tick.svg' | asset_url }}" alt="" width="16" height="16">
                  </span>
                </button>
                {% assign first_tab_active = false %}
              {% endif %}
              {% if has_mum_name %}
                <button
                  type="button"
                  role="tab"
                  class="personalise-name-tabs__tab {% if first_tab_active %}is-active{% endif %}"
                  aria-selected="{% if first_tab_active %}true{% else %}false{% endif %}"
                  aria-controls="tab-panel-mum"
                  id="tab-mum"
                  data-tab="mum"
                  on:click="/switchNameTab"
                >
                  <span class="personalise-name-tabs__tab-text">Mum</span>
                  <span class="personalise-name-tabs__tab-icon personalise-name-tabs__tab-icon--check" data-tab-icon="mum" style="display: none;">
                    <img src="{{ 'icon-tick.svg' | asset_url }}" alt="" width="16" height="16">
                  </span>
                </button>
                {% assign first_tab_active = false %}
              {% endif %}
            </div>

            <div class="personalise-name-tabs__panels">
              {% assign first_panel_active = true %}
              {% if has_baby_name %}
                <div
                  role="tabpanel"
                  id="tab-panel-baby"
                  class="personalise-name-tabs__panel {% if first_panel_active %}is-active{% endif %}"
                  aria-labelledby="tab-baby"
                  data-panel="baby"
                >
                  <h3 class="personalise-name-tabs__panel-title">Baby's Name (Free Personalisation)</h3>
                  <div class="personalise-name-tabs__input-wrapper">
                    <input
                      type="text"
                      class="personalise-name-tabs__input"
                      name="properties[Baby's Name]"
                      placeholder="Enter the Name or Initials"
                      maxlength="9"
                      data-name-input="baby"
                      ref="babyNameInput"
                      on:input="/handleNameTabInput"
                      data-form-id
                    />
                    <span class="personalise-name-tabs__counter" ref="babyCharCounter">
                      <span ref="babyCharCount">0</span>/9
                    </span>
                  </div>
                </div>
                {% assign first_panel_active = false %}
              {% endif %}
              {% if has_kid_name %}
                <div
                  role="tabpanel"
                  id="tab-panel-kid"
                  class="personalise-name-tabs__panel {% if first_panel_active %}is-active{% endif %}"
                  aria-labelledby="tab-kid"
                  data-panel="kid"
                >
                  <h3 class="personalise-name-tabs__panel-title">Kid's Name (Free Personalisation)</h3>
                  <div class="personalise-name-tabs__input-wrapper">
                    <input
                      type="text"
                      class="personalise-name-tabs__input"
                      name="properties[Kid's Name]"
                      placeholder="Enter the Name or Initials"
                      maxlength="9"
                      data-name-input="kid"
                      ref="kidNameInput"
                      on:input="/handleNameTabInput"
                      data-form-id
                    />
                    <span class="personalise-name-tabs__counter" ref="kidCharCounter">
                      <span ref="kidCharCount">0</span>/9
                    </span>
                  </div>
                </div>
                {% assign first_panel_active = false %}
              {% endif %}
              {% if has_mum_name %}
                <div
                  role="tabpanel"
                  id="tab-panel-mum"
                  class="personalise-name-tabs__panel {% if first_panel_active %}is-active{% endif %}"
                  aria-labelledby="tab-mum"
                  data-panel="mum"
                >
                  <h3 class="personalise-name-tabs__panel-title">Mum's Name (Free Personalisation)</h3>
                  <div class="personalise-name-tabs__input-wrapper">
                    <input
                      type="text"
                      class="personalise-name-tabs__input"
                      name="properties[Mum's Name]"
                      placeholder="Enter the Name or Initials"
                      maxlength="9"
                      data-name-input="mum"
                      ref="mumNameInput"
                      on:input="/handleNameTabInput"
                      data-form-id
                    />
                    <span class="personalise-name-tabs__counter" ref="mumCharCounter">
                      <span ref="mumCharCount">0</span>/9
                    </span>
                  </div>
                </div>
                {% assign first_panel_active = false %}
              {% endif %}
            </div>
          </div>
        {% endif %}

        {% if show_personalized or personalized_name or personalized_textbox %}
          {% if personalized_name %}
            <p class="personalise-modal__instructions">
              Maximum {{ dynamic_max }} characters. No special characters.
            </p>

            <div class="personalise-modal__field">
              <label for="personalise-name" class="personalise-modal__label">
                Name (Free Personlisation) 
              </label>
              <div class="personalise-modal__input-wrapper">
                <input
                  type="text"
                  id="personalise-name"
                  name="personalise-name"
                  class="personalise-modal__input"
                  placeholder="Enter the Name or Initials"
                  maxlength="{{ dynamic_max }}"
                  ref="nameInput"
                  on:input="/handleNameInput"
                />
                <span class="personalise-modal__counter" ref="charCounter">
                  <span ref="charCount">0</span>/{{ dynamic_max }}
                </span>
                {% comment %} <p class="personalise-modal__info-text">Maximum {{ dynamic_max }} characters. No special character</p> {% endcomment %}
              </div>
            </div>
          {% endif %}

          {% if personalized_textcolour %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Text Colour <span style="color: red;">*</span></label>
              <div class="personalise-modal__color-grid variant-option--image-thumbnails" ref="colorGrid">
                {% for product_tag in product.tags %}
                  {% if product_tag contains 'color_' %}
                    {% assign color_tag = product_tag | split: '_' %}
                    <label
                      class="personalise-modal__color-button variant-option__button-label variant-option__button-label--image-thumbnail"
                      data-color="{{ color_tag[1] }}"
                      ref="colorButton"
                      title="{{ color_tag[1] | capitalize }}"
                    >
                      <input
                        type="radio"
                        name="personalise-color"
                        value="{{ color_tag[1] }}"
                        on:click="/selectColor"
                      >
                      <div class="variant-option__image-thumbnail">
                        {% assign color_name = color_tag[1] | downcase %}
                        <div class="personalise-modal__color-icon" style="width: 60px; height: 60px;">
                          {% case color_name %}
                            {% when 'grey' %}
                              {% render 'icon-grey' %}
                            {% when 'pink' %}
                              {% render 'icon-pink' %}
                            {% when 'white' %}
                              {% render 'icon-white' %}
                            {% when 'red' %}
                              {% render 'icon-red' %}
                            {% when 'green' %}
                              {% render 'icon-green' %}
                            {% when 'blue' %}
                              {% render 'icon-blue' %}
                            {% when 'orange' %}
                              {% render 'icon-orange' %}
                            {% when 'yellow' %}
                              {% render 'icon-yellow' %}
                            {% when 'purple' %}
                              {% render 'icon-purple' %}
                            {% when 'gold' %}
                              {% render 'icon-gold' %}
                            {% when 'silver' %}
                              {% render 'icon-silver' %}
                            {% when 'multicolour' %}
                              {% render 'icon-multicolour' %}
                            {% when 'black' %}
                              {% render 'icon-black' %}
                            {% else %}
                              <span class="swatch swatch--unscaled" style="--swatch-background: {{ color_name }}; background-color: {{ color_name }};"></span>
                          {% endcase %}
                        </div>
                      </div>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if font_family_feild %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Choose Your Font <span style="color: red;">*</span></label>
              <div class="personalise-modal__font-grid" ref="fontGrid">
                {% if product.tags contains 'font_rockwell-condensed' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Rockwell Condensed" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Rockwell Condensed', sans-serif;">Rockwell Condensed</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_ariel' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Ariel round" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Ariel round', sans-serif;">Ariel round</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_monotype-corsiva' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Monotype Corsiva" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Monotype Corsiva', serif;">Monotype Corsiva</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_coronation' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Coronation" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Coronation', sans-serif;">Coronation</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_ballantines' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Ballantines" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Ballantines', sans-serif;">Ballantines</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_jester' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Jester" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Jester', sans-serif;">Jester</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_miss-neally' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Miss Neally" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Miss Neally', sans-serif;">Miss Neally</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_castle' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Castle" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Castle', sans-serif;">Castle</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_london' %}
                  <button type="button" class="personalise-modal__font-button" data-font="London" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'London', sans-serif;">London</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_garamond' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Garamond" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Garamond', serif;">Garamond</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_comic-sans' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Comic Sans" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Comic Sans', cursive;">Comic Sans</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_amsterdam' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Amsterdam" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Amsterdam', sans-serif; font-size:12px;">Amsterdam</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_black_jack' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Black Jack" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Black Jack', sans-serif;">Black Jack</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_rochester' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Rochester" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Rochester', cursive;">Rochester</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_poppins' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Poppins" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Poppins', sans-serif;">Poppins</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_playfair-display' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Playfair Display" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Playfair Display', serif;">Playfair Display</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_playball' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Playball" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Playball', cursive;">Playball</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_roboto-serif' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Roboto Serif" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: 'Roboto Serif', serif;">Roboto Serif</span>
                  </button>
                {% endif %}
                {% if product.tags contains 'font_helvetica' %}
                  <button type="button" class="personalise-modal__font-button" data-font="Helvetica" ref="fontButton" on:click="/selectFont">
                    <span style="font-family: Helvetica, sans-serif;">Helvetica</span>
                  </button>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {% assign product_tag_low = product.tags | join: ' ' | downcase %}
          {% if product_tag_low contains 'school_year' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">School Year</label>
              <input type="text" class="personalise-modal__input" name="properties[School Year]" maxlength="20" ref="schoolYearInput">
            </div>
          {% endif %}

          {% if product_tag_low contains 'name1' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Name 1</label>
              <input type="text" class="personalise-modal__input" name="properties[Name 1]" maxlength="8" ref="name1Input">
              <p class="personalise-modal__info-text">English or Arabic. Maximum 8 characters.*</p>
            </div>
          {% endif %}
          {% if product_tag_low contains 'name2' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Name 2</label>
              <input type="text" class="personalise-modal__input" name="properties[Name 2]" maxlength="8" ref="name2Input">
              <p class="personalise-modal__info-text">English or Arabic. Maximum 8 characters.*</p>
            </div>
          {% endif %}
          {% if product_tag_low contains 'name3' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Name 3</label>
              <input type="text" class="personalise-modal__input" name="properties[Name 3]" maxlength="8" ref="name3Input">
              <p class="personalise-modal__info-text">English or Arabic. Maximum 8 characters.</p>
            </div>
          {% endif %}
          {% if product_tag_low contains 'name4' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Name 4</label>
              <input type="text" class="personalise-modal__input" name="properties[Name 4]" maxlength="8" ref="name4Input">
              <p class="personalise-modal__info-text">English or Arabic. Maximum 8 characters.*</p>
            </div>
          {% endif %}

          {% if personalized_dob %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Date of Birth + AED 10 (optional)</label>
              <input type="text" class="personalise-modal__input" name="properties[Date of Birth]" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}" ref="dobInput">
            </div>
          {% endif %}

          {% if product.tags contains 'optional_fields' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Date of Birth (optional)</label>
              <input type="date" class="personalise-modal__input" id="dob_field_val" ref="optionalDobInput">
            </div>
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Time of Birth (optional)</label>
              <input type="text" class="personalise-modal__input" name="properties[Time]" placeholder="HH:MM AM/PM" ref="timeInput">
            </div>
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Weight (kg) (optional)</label>
              <input type="text" class="personalise-modal__input" name="properties[Weight]" ref="weightInput">
            </div>
          {% endif %}

          {% if personalized_textbox %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Enter the names here:</label>
              <textarea class="personalise-modal__textarea" name="properties[Personalisation:]" placeholder="(e.g. Sarah,Jane,Robert)" maxlength="500" ref="textboxInput"></textarea>
            </div>
          {% endif %}

          {% if product.tags contains 'create_20' %}
            <div class="personalise-modal__field">
              <label class="personalise-modal__label">Enter the text here:</label>
              <textarea class="personalise-modal__textarea" name="properties[Message]" maxlength="50" ref="messageInput"></textarea>
            </div>
          {% endif %}
        {% else %}
          <p class="personalise-modal__instructions">
            Maximum 9 characters. No special characters.
          </p>

          <div class="personalise-modal__field">
            <label for="personalise-name" class="personalise-modal__label">
              Name (Free Personalisation)
            </label>
            <div class="personalise-modal__input-wrapper">
              <input
                type="text"
                id="personalise-name"
                name="personalise-name"
                class="personalise-modal__input"
                placeholder="Enter the Name or Initials"
                maxlength="9"
                ref="nameInput"
                on:input="/handleNameInput"
              />
              <span class="personalise-modal__counter" ref="charCounter">
                <span ref="charCount">0</span>/9
              </span>
            </div>
          </div>

          <div class="personalise-modal__field">
            <label class="personalise-modal__label">Choose Font Style</label>
            <div class="personalise-modal__font-grid" ref="fontGrid">
              <button type="button" class="personalise-modal__font-button" data-font="Ariel round" ref="fontButton" on:click="/selectFont">Ariel round</button>
              <button type="button" class="personalise-modal__font-button" data-font="Comic Sans" ref="fontButton" on:click="/selectFont">Comic Sans</button>
              <button type="button" class="personalise-modal__font-button" data-font="Playfair Display" ref="fontButton" on:click="/selectFont">Playfair Display</button>
              <button type="button" class="personalise-modal__font-button" data-font="Playball" ref="fontButton" on:click="/selectFont">Playball</button>
              <button type="button" class="personalise-modal__font-button" data-font="Roboto Serif" ref="fontButton" on:click="/selectFont">Roboto Serif</button>
              <button type="button" class="personalise-modal__font-button" data-font="Helvetica" ref="fontButton" on:click="/selectFont">Helvetica</button>
            </div>
          </div>
        {% endif %}

        <div class="personalise-modal__actions">
          <button
            type="button"
            class="personalise-modal__save-button button button--primary"
            ref="saveButton"
            on:click="/savePersonalisation"
          >
            SAVE PERSONALISATION
          </button>
          <button
            type="button"
            data-personalise-close="true"
            class="personalise-modal__cancel-button button button-unstyled"
            ref="cancelButton"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>
  </dialog>
</personalise-dialog>

{% stylesheet %}
  .personalise-modal {
    padding: 20px;
    border: var(--style-border-popover);
    max-width: 90vw;
    width: 79.86vw; /* 1150px at 1440px screen size */
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 5px 30px rgb(0 0 0 / var(--opacity-15));
    background-color: var(--color-background);
  }

  /* At 1440px screen size, modal should be exactly 1150px */
  @media screen and (min-width: 1440px) {
    .personalise-modal {
      width: 1150px;
    }
  }

  /* Scale down proportionally for smaller screens */
  @media screen and (max-width: 1439px) {
    .personalise-modal {
      width: 79.86vw;
    }
  }

  .personalise-modal[open] {
    display: flex;
    flex-direction: column;
    animation: modalSlideInTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .personalise-modal.dialog-closing {
    animation: modalSlideOutTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .personalise-modal__close {
    position: absolute;
    top: var(--margin-md);
    right: var(--margin-md);
    z-index: var(--layer-raised);
    transition: transform 0.15s var(--animation-timing-bounce);
  }

  .personalise-modal__close:active {
    transform: scale(0.8);
  }

  .personalise-modal__content {
    display: flex;
    height: 100%;
    /* min-height: 500px; */
    overflow: hidden;
    padding: 0;
  }

  /* Left Section: Preview */
  .personalise-modal__preview {
    flex: 0 0 52%; /* 525px / 1150px = 45.65% for proportional scaling */
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(0deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.02));
    position: relative;
    overflow: hidden;
  }

  /* At 1150px modal width, preview should be exactly 525px */
  @media screen and (min-width: 1440px) {
    .personalise-modal__preview {
      flex: 0 0 525px;
    }
  }

  /* Wrapper: initial 100% so image can load; JS sets exact px to match image displayed size (object-fit: contain) */
  .personalise-modal__preview-image-wrap {
    position: relative;
    display: block;
    overflow: hidden;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
  }

  .personalise-modal__preview-image--dynamic {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .personalise-modal__preview-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .personalise-modal__preview-text-overlay {
    position: absolute;
    pointer-events: none;
    white-space: nowrap;
    transform: translate(-50%, 50%);
    line-height: 1.2;
  }

  .personalise-modal__preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-50));
  }

  /* Right Section: Form */
  .personalise-modal__form {
    flex: 0 0 46.09%; /* 530px / 1150px = 46.09% for proportional scaling */
    display: flex;
    flex-direction: column;
    padding-left: 20px; 
    overflow-y: auto;
  }

  /* At 1150px modal width, form should be exactly 530px */
  @media screen and (min-width: 1440px) {
    .personalise-modal__form {
      flex: 0 0 530px;
    }
  }

  .personalise-modal__mobile-header {
    display: none;
  }

  .personalise-modal__title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 24px;
    line-height: 156%;
    text-align: center;
    text-transform: capitalize;
    color: #1D425A;
    margin: 0;
  }

  .personalise-modal__title--mobile {
    display: none;
  }

  .personalise-modal__title-icon {
    display: flex;
    align-items: center;
    width: 16px;
    height: 16px;
  }

  .personalise-modal__instructions {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 18px;
    line-height: 156%;
    color: #777777;
    margin: 0;
    margin-top: 6px;
  }

  .personalise-modal__instructions--mobile {
    display: none;
  }

  .personalise-modal__field {
    /* margin-block-end: var(--margin-xl); */
    margin-top: 25px;
  }

  .personalise-modal__label {
    display: block;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 16px;
    line-height: 156%;
    color: #1D425A;
    margin-block-end: var(--margin-sm);
  }

  .personalise-modal__input-wrapper {
    display: flex;
    flex-direction: column;
  }

  .personalise-modal__input {
    width: 100%;
    padding: var(--padding-md);
    border: 1px solid #D0D0D0;
    border-radius: 0;
    font-size: 14px;
    font-family: 'Outfit', sans-serif;
    background-color: #FFFFFF;
    color: var(--color-foreground);
    transition: border-color 0.2s ease;
    line-height: 156%;
  }

  .personalise-modal__input::placeholder {
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 400;
    font-size: 14px;
    line-height: 156%;
    color: #797979;
  }

  .personalise-modal__input:focus {
    outline: none;
    border-color: #7295BB;
  }

  .personalise-modal__counter {
    margin-top: var(--padding-xs);
    text-align: right;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 14px;
    line-height: 156%;
    color: #7295BB;
  }

  .personalise-modal__font-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--gap-sm);
    margin-block-start: var(--margin-sm);
  }

  .personalise-modal__font-button {
    padding: var(--padding-md);
    border: 1px solid #e0e0e0;
    border-radius: 0;
    background-color: var(--color-background);
    color: #A2A2A2;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 156%;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .personalise-modal__font-button:hover {
    border-color: #7295BB;
    color: #7295BB;
  }

  .personalise-modal__font-button--selected {
    background-color: #F4F9FF;
    border: 1px solid #7295BB;
    color: #7295BB;
    font-style: normal;
    font-weight: 400;
    line-height: 156%;
  }

  /* Font-specific styles â€“ reference: PERSONALISATION_FONT_FAMILIES_REFERENCE.md */
  .personalise-modal__font-button[data-font="Rockwell Condensed"] { font-family: 'Rockwell Condensed', sans-serif; }
  .personalise-modal__font-button[data-font="Ariel round"] { font-family: 'Ariel round', sans-serif; }
  .personalise-modal__font-button[data-font="Monotype Corsiva"] { font-family: 'Monotype Corsiva', serif; }
  .personalise-modal__font-button[data-font="Coronation"] { font-family: 'Coronation', sans-serif; }
  .personalise-modal__font-button[data-font="Ballantines"] { font-family: 'Ballantines', sans-serif; }
  .personalise-modal__font-button[data-font="Jester"] { font-family: 'Jester', sans-serif; }
  .personalise-modal__font-button[data-font="Miss Neally"] { font-family: 'Miss Neally', sans-serif; }
  .personalise-modal__font-button[data-font="Castle"] { font-family: 'Castle', sans-serif; }
  .personalise-modal__font-button[data-font="London"] { font-family: 'London', sans-serif; }
  .personalise-modal__font-button[data-font="Garamond"] { font-family: 'Garamond', serif; }
  .personalise-modal__font-button[data-font="Comic Sans"] { font-family: 'Comic Sans', cursive; }
  .personalise-modal__font-button[data-font="Amsterdam"] { font-family: 'Amsterdam', sans-serif; }
  .personalise-modal__font-button[data-font="Black Jack"] { font-family: 'Black Jack', sans-serif; }
  .personalise-modal__font-button[data-font="Rochester"] { font-family: 'Rochester', cursive; }
  .personalise-modal__font-button[data-font="Poppins"] { font-family: 'Poppins', sans-serif; }
  .personalise-modal__font-button[data-font="Playfair Display"] { font-family: 'Playfair Display', serif; }
  .personalise-modal__font-button[data-font="Playball"] { font-family: 'Playball', cursive; }
  .personalise-modal__font-button[data-font="Roboto Serif"] { font-family: 'Roboto Serif', serif; }
  .personalise-modal__font-button[data-font="Helvetica"] { font-family: Helvetica, sans-serif; }

  .personalise-modal__info-text {
    font-size: var(--font-size--sm);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
    margin-top: var(--padding-xs);
  }

  .personalise-modal__textarea {
    width: 100%;
    padding: var(--padding-md);
    border: 1px solid #D0D0D0;
    border-radius: 0;
    font-size: 14px;
    font-family: 'Outfit', sans-serif;
    background-color: #FFFFFF;
    color: var(--color-foreground);
    transition: border-color 0.2s ease;
    line-height: 156%;
    min-height: 100px;
    resize: vertical;
  }

  .personalise-modal__textarea:focus {
    outline: none;
    border-color: #7295BB;
  }

  .personalise-modal__color-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-block-start: var(--margin-sm);
  }

  .personalise-modal__color-button {
    padding: 2px;
    border: none;
    border-radius: 0;
    overflow: hidden;
    position: relative;
    width: 60px;
    height: 60px;
    min-width: 60px;
    min-height: 60px;
    flex: 0 0 auto;
    background: transparent;
    cursor: pointer;
  }

  .personalise-modal__color-button:hover {
    outline: none;
    border-color: transparent !important;
    background-color: transparent !important;
  }

  .personalise-modal__color-button:has(:checked) {
    border: 1px solid #1D425A;
    border-radius: 50%;
    outline: none;
  }

  .personalise-modal__color-button:has(:checked):hover {
    border-color: #1D425A !important;
    background-color: transparent !important;
  }

  /* Match the exact styling from variant picker image thumbnails */
  .personalise-modal__color-button.variant-option__button-label--image-thumbnail:has(:checked) {
    border: 1px solid #1D425A;
    border-radius: 50%;
    outline: none;
  }

  .personalise-modal__color-button.variant-option__button-label--image-thumbnail:has(:checked):hover {
    border-color: #1D425A !important;
    background-color: transparent !important;
  }

  .personalise-modal__color-button input {
    position: absolute;
    inset: 0;
    opacity: 0;
    margin: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .personalise-modal__color-button .variant-option__image-thumbnail {
    width: 100%;
    height: 100%;
    position: relative;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .personalise-modal__color-button .swatch {
    width: 100%;
    height: 100%;
    display: block;
    background: var(--swatch-background);
    border-radius: var(--variant-picker-swatch-radius, 0);
  }

  .personalise-modal__color-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
  }

  .personalise-modal__color-icon svg {
    width: 60px;
    height: 60px;
    display: block;
  }

  .personalise-modal__color-button:has(:checked) .variant-option__image-thumbnail {
    border-radius: 50%;
    overflow: hidden;
  }

  .personalise-modal__color-button:has(:focus-visible) {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  .personalise-modal__actions {
    display: flex;
    gap: var(--gap-md);
    /* margin-block-start: auto; */
    flex-wrap: wrap;
    padding-block-start: var(--padding-xl);
  }

  .personalise-modal__save-button {
    flex: 1;
    background-color: #7295BB;
    color: #ffffff;
    border: none;
    padding: var(--padding-md) var(--padding-lg);
    border-radius: 0;
    font-weight: 500;
    text-transform: uppercase;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .personalise-modal__save-button:hover:not(:disabled) {
    background-color: #5a7a9a;
  }

  .personalise-modal__save-button:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
  }

  .personalise-modal__cancel-button {
    flex: 0 0 auto;
    background-color: transparent;
    border: 1px solid #7295BB;
    color: #7295BB;
    padding: var(--padding-md) var(--padding-lg);
    border-radius: 0;
    font-weight: 500;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .personalise-modal__cancel-button:hover {
    border-color: #5a7a9a;
    color: #5a7a9a;
  }

  @media screen and (max-width: 749px) {
    .personalise-modal {
      width: 100%;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .personalise-modal__content {
      flex-direction: column;
      min-height: unset;
      overflow: visible;
    }

    /* Show mobile header */
    .personalise-modal__mobile-header {
      display: block;
      padding-top: 20px;
      margin-bottom: 0;
    }

    .personalise-modal__title--mobile {
      display: flex;
      font-size: 18px;
    }

    .personalise-modal__instructions--mobile {
      display: block;
      font-size: 14px;
    }

    /* Hide desktop title and instructions */
    .personalise-modal__form .personalise-modal__title {
      display: none;
    }

    .personalise-modal__form .personalise-modal__instructions:not(.personalise-modal__instructions--mobile) {
      display: none;
    }

    .personalise-modal__preview {
      flex: 0 0 40%;
      min-height: 200px;
      margin: 16px 0;
    }

    .personalise-modal__form {
      flex: 1;
      padding: 0;
      padding-top: 20px;
      overflow-y: visible;
    }

    /* Mobile font sizes */
    .personalise-modal__label {
      font-size: 14px;
    }

    .personalise-modal__instructions {
      font-size: 14px;
    }

    .personalise-modal__font-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .personalise-modal__actions {
      flex-direction: column;
    }

    .personalise-modal__save-button,
    .personalise-modal__cancel-button {
      width: 100%;
    }
  }

  /* Name Tabs Styles */
  .personalise-name-tabs {
    margin-bottom: var(--margin-lg);
  }

  .personalise-name-tabs__tablist {
    display: flex;
    gap: 0;
    border-bottom: 1px solid #D0D0D0;
    margin-bottom: var(--margin-lg);
    justify-content: space-between;
  }

  .personalise-name-tabs__tab {
    position: relative;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 6px 20px;
    font-size: 14px;
    font-family: 'Outfit', sans-serif;
    color: #999999;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--padding-xs);
    transition: all 0.2s ease;
  }

  .personalise-name-tabs__tab:hover {
    color: #333333;
  }

  .personalise-name-tabs__tab.is-active {
    color: #001D4A;
    border-bottom-color: #001D4A;
    font-weight: 500;
  }

  .personalise-name-tabs__tab-text {
    line-height: 1.5;
  }

  .personalise-name-tabs__tab-icon {
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .personalise-name-tabs__tab-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .personalise-name-tabs__tab-icon--check {
    color: #001D4A;
  }

  .personalise-name-tabs__panels {
    position: relative;
  }

  .personalise-name-tabs__panel {
    display: none;
  }

  .personalise-name-tabs__panel.is-active {
    display: block;
  }

  .personalise-name-tabs__panel-title {
    font-size: 14px;
    font-family: 'Outfit', sans-serif;
    font-weight: 500;
    color: #001D4A;
    margin-bottom: var(--margin-md);
    line-height: 1.5;
  }

  .personalise-name-tabs__input-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .personalise-name-tabs__input {
    width: 100%;
    padding: var(--padding-md);
    border: 1px solid #D0D0D0;
    border-radius: 0;
    font-size: 14px;
    font-family: 'Outfit', sans-serif;
    background-color: #FFFFFF;
    color: var(--color-foreground);
    transition: border-color 0.2s ease;
    line-height: 156%;
  }

  .personalise-name-tabs__input:focus {
    outline: none;
    border-color: #7295BB;
  }

  .personalise-name-tabs__input::placeholder {
    color: #999999;
  }

  .personalise-name-tabs__counter {
    margin-top: var(--padding-xs);
    text-align: right;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 14px;
    line-height: 156%;
    color: #7295BB;
  }

  @media screen and (max-width: 749px) {
    .personalise-name-tabs__tab {
      padding: var(--padding-sm) var(--padding-md);
      font-size: 13px;
    }

    .personalise-name-tabs__panel-title {
      font-size: 14px;
    }
  }
{% endstylesheet %}


