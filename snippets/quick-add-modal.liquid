<quick-add-dialog id="quick-add-dialog">
  <dialog
    class="quick-add-modal dialog-modal color-{{ settings.popover_color_scheme }}"
    ref="dialog"
    scroll-lock
  >
    <button
      ref="closeButton"
      on:click="/closeDialog"
      class="button button-unstyled close-button quick-add-modal__close"
      aria-label="{{ 'accessibility.close_dialog' | t }}"
    >
      {{- 'icon-close.svg' | inline_asset_content -}}
    </button>
    <div
      id="quick-add-modal-content"
      class="quick-add-modal__content"
    ></div>
  </dialog>
</quick-add-dialog>

{% stylesheet %}
  @media screen and (min-width: 750px) {
    .quick-add-modal {
      width: 90%;
      max-width: 1000px;
    }
  }

  @media screen and (min-width: 1400px) {
    .quick-add-modal {
      width: 1200px;
      max-width: 1200px;
    }
  }

  .quick-add-modal {
    padding: 0;
    border: var(--style-border-popover);
    height: fit-content;
    max-height: 90vh;
    overflow: hidden;
    min-height: 500px;
    box-shadow: 0 5px 30px rgb(0 0 0 / var(--opacity-15));

    @media screen and (max-width: 750px) {
      position: fixed;
      display: block;
      margin: auto 0 0 0;
      min-height: unset;
      max-width: 100%;
      border-radius: 0;
      max-height: 100vh;
    }
  }

  .quick-add-modal[open] {
    @media screen and (min-width: 750px) {
      display: flex;
    }
  }

  .quick-add-modal .view-more-details__wrapper {
    @media screen and (max-width: 750px) {
      display: none;
    }
  }

  .quick-add-modal[open] {
    animation: modalSlideInTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .quick-add-modal.dialog-closing {
    animation: modalSlideOutTop var(--animation-speed) var(--animation-easing) forwards;
  }

  .quick-add-modal__close {
    position: absolute;
    top: var(--margin-2xs);
    right: var(--margin-2xs);
    transition: transform 0.15s var(--animation-timing-bounce);
    z-index: calc(var(--layer-raised) + 1);
    pointer-events: all;
    cursor: pointer;
  }

  .quick-add-modal__close:active {
    transform: scale(0.8);
  }

  .quick-add-modal__content {
    display: flex;
    height: 100%;
    min-height: 500px;
    max-height: 90vh;
    overflow: hidden;
    padding: 0;

    @media screen and (max-width: 750px) {
      flex-direction: column;
      min-height: unset;
      padding-inline: var(--padding-xl);
      padding-block: var(--padding-xl);
      gap: var(--gap-lg);
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      height: auto; /* Prevent a bug in Safari where height:fit-content is not respected */
      max-height: 100vh;
    }
  }

  /* Override product-information__grid to use flex layout in quick add modal */
  .quick-add-modal__content .product-information__grid {
    display: flex !important;
    flex-direction: row;
    width: 100% !important;
    height: 100% !important;
    gap: 0;
    grid-template-columns: none !important;
    min-height: 500px;
  }

  /* Ensure all direct children are visible */
  .quick-add-modal__content .product-information__grid > * {
    display: block !important;
    visibility: visible !important;
  }

  .quick-add-modal__content .media-gallery--grid .media-gallery__grid {
    grid-template-columns: 1fr;
    display: grid !important;
  }

  /* For grid layout, ensure first image is visible */
  .quick-add-modal__content .product-information__media .media-gallery--grid .product-media-container:first-child {
    display: grid !important;
    width: 100% !important;
    height: 100% !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .quick-add-modal__content .product-information__media .media-gallery--grid .product-media-container:first-child .product-media,
  .quick-add-modal__content .product-information__media .media-gallery--grid .product-media-container:first-child img {
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
    display: block !important;
    visibility: visible !important;
  }

  /* Hide all media containers except the first one in quick add modal */
  .quick-add-modal__content .product-information__media .product-media-container:not(:first-child) {
    display: none !important;
  }

  /* Ensure first media container is visible */
  .quick-add-modal__content .product-information__media .product-media-container:first-child {
    display: flex !important;
    width: 100% !important;
    height: 100% !important;
    align-items: center;
    justify-content: center;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .quick-add-modal__content .media-gallery--grid.media-gallery--two-column .product-media-container:first-child {
    grid-column: auto;
  }

  .quick-add-modal__content {
    /* One column */
    .media-gallery--grid:not(.media-gallery--two-column) .product-media > *,
    /* Two column, small first image */
    .media-gallery--grid.media-gallery--two-column:not(.media-gallery--large-first-image)
    .product-media-container:nth-of-type(odd)
    .product-media > *,
    /* Two column, large first image */
    .media-gallery--grid.media-gallery--two-column.media-gallery--large-first-image
      .product-media-container:is(:first-of-type, :nth-of-type(even))
      .product-media > *,
      /* Carousel */
    .media-gallery--carousel slideshow-container {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
  }

  .quick-add-modal__content .view-more-details__wrapper {
    display: flex;
    justify-content: flex-start;
    width: 100%;
  }

  .view-more-details__wrapper .view-more-details {
    display: flex;
    align-items: center;
    width: fit-content;
  }

  .quick-add-modal__content .product-header {
    /* Hide product-header on desktop - only show on mobile */
    @media screen and (min-width: 750px) {
      display: none !important;
    }

    @media screen and (max-width: 750px) {
      display: flex;
      flex-direction: column;
      grid-column: 2 / -1;
      grid-row: 1;
      padding-right: var(--padding-2xl);
    }
  }

  .quick-add-modal__content .product-header a:not(product-price *) {
    @media screen and (max-width: 749px) {
      font-size: var(--font-size--md);
      font-weight: 500;
      color: inherit;
      width: fit-content;
    }
  }

  .quick-add-modal__content variant-picker,
  .quick-add-modal__content product-form-component {
    @media screen and (max-width: 750px) {
      grid-column: 1 / -1;
    }
  }

  .quick-add-modal__content .product-media-container__zoom-button {
    cursor: default;
  }

  .quick-add-modal__content .product-details {
    flex: 0 0 46.09% !important; /* Similar to personalisation modal */
    display: flex !important;
    flex-direction: column;
    justify-content: stretch;
    height: 100%;
    min-height: 0;
    overflow-y: auto;
    padding-left: 20px;
    order: 1 !important;
    width: 46.09% !important;
    max-width: 46.09% !important;
    visibility: visible !important;

    dialog[open] & {
      animation: fadeSlideIn 0.3s var(--animation-timing-fade-in) both;
      animation-delay: 0.1s;
    }

    @media screen and (min-width: 1400px) {
      flex: 0 0 530px !important;
      width: 530px !important;
      max-width: 530px !important;
    }

    @media screen and (max-width: 750px) {
      flex: 1 !important;
      width: 100% !important;
      max-width: 100% !important;
      padding: var(--padding-xl);
      max-height: 100%;
      height: 100%;
      order: 1 !important;
    }
  }

  .quick-add-modal__content .product-details > .group-block {
    flex-grow: 1;
  }

  .quick-add-modal__content > * {
    min-height: 0;
  }

  .quick-add-modal__content .product-details :is(.view-product-title, .buy-buttons-block) {
    flex: 0 0 auto;
  }
  .quick-add-modal__content .product-details :is(.buy-buttons-block) {
    margin-top: auto;
  }

  .quick-add-modal__content .product-details .variant-picker {
    flex: 0 0 auto;

    padding-block: min(var(--gap-2xl), var(--gap));
    margin-block-end: calc(var(--focus-outline-offset) + var(--focus-outline-width));
  }

  .quick-add-modal__content .variant-option--swatches {
    padding-inline-start: var(--padding-2xs);
  }

  .quick-add-modal__content .variant-option--swatches legend {
    margin-inline-start: calc(-1 * var(--padding-2xs));
  }

  .quick-add-modal__content:not(:has(.product-information__media)) .product-details {
    flex: 1 1 100%;
  }

  .quick-add-modal__content .view-product-title {
    display: flex;
    padding-block: 0;
    margin-block-end: 12px;

    /* Prevent overlap between title and close button */
    padding-inline: 0 calc(var(--minimum-touch-target) / 2);
  }

  .quick-add-modal__content .view-product-title a {
    color: inherit;
    text-decoration: none;
    text-align: left;
    font-size: var(--font-size--2xl);
    font-weight: 600;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s var(--animation-easing);
  }

  /* Hide ALL duplicate product title elements - only show .view-product-title */
  @media screen and (min-width: 750px) {
    /* Hide text blocks that contain headings (these are usually product title blocks) */
    .quick-add-modal__content .product-details .text-block:has(h1),
    .quick-add-modal__content .product-details .text-block:has(h2),
    .quick-add-modal__content .product-details .text-block:has(h3) {
      display: none !important;
    }

    /* Hide any standalone headings that aren't in .view-product-title */
    .quick-add-modal__content .product-details h1:not(.view-product-title h1):not(.view-product-title *),
    .quick-add-modal__content .product-details h2:not(.view-product-title h2):not(.view-product-title *),
    .quick-add-modal__content .product-details h3:not(.view-product-title h3):not(.view-product-title *) {
      display: none !important;
    }

    /* Hide product-title-text class */
    .quick-add-modal__content .product-details .product-title-text {
      display: none !important;
    }
  }

  /* Hide extra content in product-details on desktop in quick add modal */
  @media screen and (min-width: 750px) {
    /* Hide text blocks that contain product title (h1, h2, h3) - we only want .view-product-title */
    .quick-add-modal__content .product-details .text-block:has(h1),
    .quick-add-modal__content .product-details .text-block:has(h2),
    .quick-add-modal__content .product-details .text-block:has(h3) {
      display: none !important;
    }

    /* Keep showing essential elements */
    .quick-add-modal__content
      .product-details
      *:not(
        .group-block,
        .group-block-content,
        .buy-buttons-block,
        .buy-buttons-block *,
        .view-product-title,
        .view-product-title *,
        variant-picker,
        variant-picker *,
        product-price,
        product-price *,
        product-inventory,
        product-inventory *,
        .view-more-details__wrapper,
        .view-more-details__wrapper *,
        .text-block:has(h1),
        .text-block:has(h2),
        .text-block:has(h3)
      ) {
      /* Keep original behavior - hide other content */
      display: none !important;
    }
  }

  .quick-add-modal__content
    .group-block:not(
      :has(
          .buy-buttons-block,
          .buy-buttons-block *,
          .view-product-title,
          .view-product-title *,
          variant-picker,
          variant-picker *,
          product-price,
          product-price *,
          product-inventory,
          product-inventory *,
          .view-more-details__wrapper,
          .view-more-details__wrapper *
        ),
      .buy-buttons-block
    ) {
    display: none;
  }

  @media screen and (min-width: 750px) {
    .quick-add-modal__content .group-block-content {
      gap: 0;
    }

    .quick-add-modal__content .media-gallery__grid {
      gap: min(var(--gap-2xs), var(--image-gap));
      border-radius: var(--style-border-radius-popover, 0);
    }

    .quick-add-modal__content .media-gallery--grid .product-media img {
      border-radius: 0;
    }
  }

  .quick-add-modal__content .product-details > .group-block {
    padding: var(--padding-2xl);
  }

  .quick-add-modal__content slideshow-slide:not([aria-hidden='false']) {
    content-visibility: auto;
  }

  /* Ensure first slide content is always visible */
  .quick-add-modal__content .product-information__media slideshow-slide:first-child {
    content-visibility: visible !important;
  }

  .quick-add-modal__content .product-information__media {
    flex: 0 0 45.65% !important; /* Similar to personalisation modal preview */
    display: flex !important;
    align-items: center;
    justify-content: center;
    background: linear-gradient(0deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.02));
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.4s var(--animation-timing-fade-in) both;
    width: 45.65% !important;
    max-width: 45.65% !important;
    min-width: 0 !important;
    order: 0 !important;

    @media screen and (min-width: 1400px) {
      flex: 0 0 525px !important;
      width: 525px !important;
      max-width: 525px !important;
    }

    @media screen and (max-width: 750px) {
      flex: 0 0 40% !important;
      width: 100% !important;
      max-width: 100% !important;
      min-height: 200px;
    }
  }

  .quick-add-modal__content .product-information__media media-gallery {
    pointer-events: none;
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    align-items: center;
    justify-content: center;
    position: relative;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Ensure slideshow-component is visible */
  .quick-add-modal__content .product-information__media slideshow-component {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .quick-add-modal media-gallery {
    padding: 0;
  }

  .quick-add-modal__content .product-information__media slideshow-arrows {
    display: none;
  }

  .quick-add-modal__content .product-information__media slideshow-container {
    display: block !important;
    width: 100%;
    height: 100%;
  }

  .quick-add-modal__content .product-information__media slideshow-slides {
    display: flex !important;
    flex-direction: row;
    gap: 0;
    overflow: hidden;
    scroll-snap-type: none;
    width: 100% !important;
    height: 100% !important;
    position: relative;
  }

  .quick-add-modal__content .product-information__media slideshow-slide {
    width: 100%;
    flex: none;
    scroll-snap-align: unset;
    position: relative;
    transform: none;
    transition: opacity 0.3s var(--animation-easing);
  }

  /* Hide all slides except the first one - show only one image like personalisation modal */
  .quick-add-modal__content .product-information__media slideshow-slide:not(:first-child) {
    display: none !important;
    visibility: hidden !important;
  }

  /* Force first slide to be visible regardless of aria-hidden */
  .quick-add-modal__content .product-information__media slideshow-slide:first-child {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    position: relative;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* Override aria-hidden for first slide */
  .quick-add-modal__content .product-information__media slideshow-slide:first-child[aria-hidden='true'] {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Ensure all image/media elements are visible in first slide */
  .quick-add-modal__content .product-information__media slideshow-slide:first-child .product-media,
  .quick-add-modal__content .product-information__media slideshow-slide:first-child .product-media > *,
  .quick-add-modal__content .product-information__media slideshow-slide:first-child img,
  .quick-add-modal__content .product-information__media slideshow-slide:first-child video,
  .quick-add-modal__content .product-information__media slideshow-slide:first-child iframe,
  .quick-add-modal__content .product-information__media slideshow-slide:first-child .product-media-container,
  .quick-add-modal__content .product-information__media .product-media,
  .quick-add-modal__content .product-information__media .product-media img,
  .quick-add-modal__content .product-information__media img,
  .quick-add-modal__content .product-information__media .product-media__image,
  .quick-add-modal__content .product-information__media .product-media__image img {
    width: 100% !important;
    height: 100% !important;
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Ensure product-media-container in first slide is visible */
  .quick-add-modal__content .product-information__media slideshow-slide:first-child .product-media-container {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Ensure product-media element itself is visible */
  .quick-add-modal__content .product-information__media .product-media {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative;
  }

  /* Handle deferred-media (lazy loaded images) */
  .quick-add-modal__content .product-information__media deferred-media,
  .quick-add-modal__content .product-information__media deferred-media img,
  .quick-add-modal__content .product-information__media deferred-media > * {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    object-fit: contain !important;
  }

  /* Ensure any nested image elements are visible */
  .quick-add-modal__content .product-information__media * img {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
  }

  /* General rule: make sure first visible slide or container shows its content */
  .quick-add-modal__content .product-information__media > *:first-child,
  .quick-add-modal__content .product-information__media media-gallery > *:first-child,
  .quick-add-modal__content .product-information__media slideshow-component > *:first-child,
  .quick-add-modal__content .product-information__media slideshow-slides > *:first-child {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* View Product button on image container */
  .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #FFFFFF;
    border: 1px solid #7295BB;
    border-radius: 50px;
    color: #7295BB;
    text-decoration: none;
    font-family: 'Outfit', sans-serif;
    font-style: normal;
    font-weight: 500;
    font-size: 14px;
    line-height: 20px;
    text-transform: uppercase;
    z-index: var(--layer-raised);
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button:hover {
    background: #7295BB;
    color: #FFFFFF;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button-icon svg {
    width: 100%;
    height: 100%;
    stroke: currentColor;
    fill: none;
  }

  @media screen and (min-width: 750px) {
    .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button {
      padding: 12px 20px;
      font-size: 16px;
      line-height: 140%;
    }

    .quick-add-modal__content .product-information__media .quick-add-modal__view-product-button-icon {
      width: 18px;
      height: 18px;
    }
  }

  /* Only hide non-first slides with aria-hidden */
  .quick-add-modal__content .product-information__media slideshow-slide:not(:first-child)[aria-hidden='true'] {
    display: none !important;
  }

  .quick-add-modal__content .product-information__media slideshow-slide:nth-child(1) {
    animation: fadeSlideIn 0.3s var(--animation-timing-fade-in) both;
  }

  .quick-add-modal__content .product-information__media slideshow-slide:nth-child(2) {
    animation: fadeSlideIn 0.3s var(--animation-timing-fade-in) both;
    animation-delay: 0.05s;
  }

  .quick-add-modal__content .product-information__media slideshow-slide:nth-child(3) {
    animation: fadeSlideIn 0.3s var(--animation-timing-fade-in) both;
    animation-delay: 0.1s;
  }

  .quick-add-modal__content .product-information__media slideshow-controls {
    display: none;
  }

  .quick-add-modal__content .sticky-content,
  .quick-add-modal__content .sticky-content--desktop {
    top: 0;
  }

  .quick-add-modal__content .text-block.rte:not(product-price),
  .quick-add-modal__content .view-more-details__wrapper {
    display: none;
  }

  @keyframes fadeSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
{% endstylesheet %}
